import AsyncStorage from '@react-native-async-storage/async-storage';
import DateTimePicker from '@react-native-community/datetimepicker';
import * as AuthSession from 'expo-auth-session';
import { BlurView } from 'expo-blur';
import * as Contacts from 'expo-contacts';
import * as ImageManipulator from 'expo-image-manipulator';
import * as ImagePicker from 'expo-image-picker';
import * as Notifications from 'expo-notifications';
import { useRouter } from 'expo-router';
import * as SMS from 'expo-sms';
import { WidgetTaskHandler } from '../../components/widget-task-handler'; // Dosya yolunuza gÃ¶re dÃ¼zeltin
// AÅžAÄžIDAKÄ° GÄ°BÄ° Prompt'u ekleyin
import { Prompt } from 'expo-auth-session';
// getAuth'u da eklemeyi unutma
import * as Localization from 'expo-localization';
import { Auth, browserLocalPersistence } from "firebase/auth";
import {
  AlarmClock,
  AlertCircle,
  AlignLeft,
  Bell,
  CalendarClock,
  CalendarDays,
  CalendarIcon,
  Check,
  CheckCheck,
  CheckCircle2,
  ChevronDown,
  ChevronLeft, ChevronRight,
  ChevronUp,
  Edit2,
  Flame,
  Globe,
  Layers,
  ListTodo,
  Lock,
  LogOut, Mail,
  MessageCircle,
  Monitor,
  Moon,
  Plus,
  Repeat,
  Search,
  Send,
  Sliders,
  Sun,
  Trash2,
  Trophy,
  User,
  UserMinus,
  UserPlus,
  Users,
  X,
  XCircle
} from 'lucide-react-native';
import React, { useEffect, useMemo, useRef, useState } from 'react';
import {
  ActivityIndicator,
  FlatList, Image,
  Keyboard,
  KeyboardAvoidingView,
  LayoutAnimation,
  Modal,
  Platform,
  SafeAreaView,
  ScrollView, StatusBar,
  StyleSheet,
  Switch,
  Text,
  TextInput, TouchableOpacity,
  TouchableWithoutFeedback,
  UIManager,
  useColorScheme,
  View
} from 'react-native';
import { Calendar, LocaleConfig } from 'react-native-calendars';
import AnimatedSplash from '../../components/AnimatedSplash'; // Yolunu kendine gÃ¶re ayarla
import OmmioAdBanner from '../../components/OmmioAdBanner';
import PagerView from "../../components/OmmioPager";
import { setupCalendarLocales } from '../../constants/calendarConfig';
import { decryptMessage, encryptMessage, generateAndStoreKeys } from '../../utils/crypto';
// --- FIREBASE ---
import * as AppleAuthentication from 'expo-apple-authentication';
import * as Google from 'expo-auth-session/providers/google';
import { initializeApp } from "firebase/app";
import {
  createUserWithEmailAndPassword,
  EmailAuthProvider, // YENÄ°: getAuth yerine bunu kullanacaÄŸÄ±z




  // @ts-ignore
  getReactNativePersistence,
  GoogleAuthProvider,
  initializeAuth,
  linkWithCredential,
  OAuthProvider,
  onAuthStateChanged,
  signInAnonymously,
  signInWithCredential,
  signInWithEmailAndPassword,
  signOut,
  updatePassword,
  updateProfile
} from 'firebase/auth';
import {
  addDoc,
  arrayRemove,
  arrayUnion,
  collection,
  deleteDoc, doc,
  getDoc,
  getDocs,
  initializeFirestore,
  onSnapshot,
  orderBy,
  query,
  serverTimestamp,
  setDoc,
  updateDoc,
  where
} from 'firebase/firestore';
import LandingPage from '../../components/LandingPage';
import { TRANSLATIONS } from '../../constants/translations'; // YENÄ° IMPORT
// Auth tipini gÃ¼venli hale getiriyoruz

import * as WebBrowser from 'expo-web-browser';

// Widget (Android)
// @ts-ignore
import { requestWidgetUpdate } from 'react-native-android-widget';
// @ts-ignore
WebBrowser.maybeCompleteAuthSession();
// --- IMPORTLARIN EN ÃœSTÃœNE EKLEYÄ°N ---
import Constants from 'expo-constants';
import * as Device from 'expo-device';

// --- YARDIMCI FONKSÄ°YON: Push Token Alma ---
async function registerForPushNotificationsAsync() {
  let token;

  if (Platform.OS === 'android') {
    await Notifications.setNotificationChannelAsync('default', {
      name: 'default',
      importance: Notifications.AndroidImportance.MAX,
      vibrationPattern: [0, 250, 250, 250],
      lightColor: '#FF231F7C',
    });
    
    // Alarm iÃ§in Ã¶zel kanal (Daha uzun titreÅŸim ve yÃ¼ksek ses)
    await Notifications.setNotificationChannelAsync('alarm', {
      name: 'Alarm',
      importance: Notifications.AndroidImportance.MAX,
      sound: 'default', // Ã–zel ses dosyanÄ±z varsa buraya yazÄ±lÄ±r (Ã¶rn: 'alarm_sound.wav')
      vibrationPattern: [0, 500, 500, 500], // Uzun titreÅŸim
      enableLights: true,
    });
  }

  if (Device.isDevice) {
    const { status: existingStatus } = await Notifications.getPermissionsAsync();
    let finalStatus = existingStatus;
    if (existingStatus !== 'granted') {
      const { status } = await Notifications.requestPermissionsAsync();
      finalStatus = status;
    }
    if (finalStatus !== 'granted') {
      if (Platform.OS !== 'web') {
            alert('notification_permission_denied');
        }
        return;
    }
    
    // Expo Push Token al (Proje ID'si otomatik algÄ±lanÄ±r)
    token = (await Notifications.getExpoPushTokenAsync({
      projectId: Constants.expoConfig?.extra?.eas?.projectId,
    })).data;
  } else {
    // alert('Fiziksel cihaz kullanmalÄ±sÄ±nÄ±z.');
  }

  return token;
}

// --- YARDIMCI FONKSÄ°YON: BaÅŸkasÄ±na Bildirim GÃ¶nderme (Push) ---
// Bu fonksiyonu mesaj atarken, gÃ¶rev atarken vb. kullanacaÄŸÄ±z.
async function sendPushNotification(expoPushToken: string, title: string, body: string, data = {}) {
  const message = {
    to: expoPushToken,
    sound: 'default',
    title: title,
    body: body,
    data: data,
  };

  await fetch('https://exp.host/--/api/v2/push/send', {
    method: 'POST',
    headers: {
      Accept: 'application/json',
      'Accept-encoding': 'gzip, deflate',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(message),
  });
}

if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {
  UIManager.setLayoutAnimationEnabledExperimental(true);
}
const COLORS = {
  primary: '#6366f1', secondary: '#a5b4fc', background: '#F8FAFC', surface: '#ffffff',
  textDark: '#1e293b', textLight: '#64748b', textMuted: '#94a3b8',
  success: '#10b981', danger: '#ef4444', warning: '#f59e0b', darkBg: '#0f172a', darkSurface: '#1e293b',
};
const firebaseConfig = {
  apiKey: "AIzaSyCKClbJrNCzTgNPsy9JcAMgmGpP1hQ1Ts4",
  authDomain: "ommio-30d72.firebaseapp.com",
  projectId: "ommio-30d72",
  storageBucket: "ommio-30d72.firebasestorage.app",
  messagingSenderId: "677937409612",
  appId: "1:677937409612:web:09e17f70f5e1a8904d0ee9",
  measurementId: "G-V7WP221WRP"
};
// YENÄ° KISIM (Standart YÃ¶ntem)
const app = initializeApp(firebaseConfig);

// DÃœZELTME BURADA: DeÄŸiÅŸkene tip atadÄ±k ðŸ‘‡
let auth: Auth;

if (Platform.OS === 'web') {
  auth = initializeAuth(app, {
    persistence: browserLocalPersistence
  });
} else {
  auth = initializeAuth(app, {
    persistence: getReactNativePersistence(AsyncStorage)
  });
}

export { auth };

export const db = initializeFirestore(app, {
    experimentalForceLongPolling: true, 
});
const CATEGORY_COLORS = [
  { id: 'blue', hex: '#3b82f6', bg: '#eff6ff' },
  { id: 'orange', hex: '#f97316', bg: '#fff7ed' },
  { id: 'green', hex: '#10b981', bg: '#f0fdf4' },
  { id: 'purple', hex: '#a855f7', bg: '#faf5ff' },
  { id: 'pink', hex: '#ec4899', bg: '#fdf2f8' },
];

Notifications.setNotificationHandler({
  handleNotification: async () => ({ shouldShowAlert: true, shouldPlaySound: true, shouldSetBadge: false, shouldShowBanner: true, shouldShowList: true }),
});

const LANGUAGES = [{ code: 'en', label: 'English', flag: 'ðŸ‡¬ðŸ‡§' }, { code: 'tr', label: 'TÃ¼rkÃ§e', flag: 'ðŸ‡¹ðŸ‡·' }, { code: 'nl', label: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' }, { code: 'de', label: 'German', flag: 'ðŸ‡©ðŸ‡ª' }, { code: 'es', label: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' }, { code: 'fr', label: 'French', flag: 'ðŸ‡«ðŸ‡·' }, { code: 'ar', label: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' }, { code: 'id', label: 'Indonesian', flag: 'ðŸ‡®ðŸ‡©' }, { code: 'pt', label: 'Portuguese', flag: 'ðŸ‡µðŸ‡¹' }, { code: 'hi', label: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' }, { code: 'ko', label: 'Korean', flag: 'ðŸ‡°ðŸ‡·' }, { code: 'ja', label: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' }, { code: 'ru', label: 'Russian', flag: 'ðŸ‡·ðŸ‡º' }, { code: 'it', label: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' }, { code: 'pl', label: 'Polish', flag: 'ðŸ‡µðŸ‡±' }, { code: 'uk', label: 'Ukrainian', flag: 'ðŸ‡ºðŸ‡¦' }];

// --- TÄ°P TANIMLAMALARI ---
type ThemeMode = 'light' | 'dark' | 'system';
type LangCode = 'en' | 'tr' | 'nl' | 'de' | 'es' | 'fr' | 'ar' | 'id' | 'pt' | 'hi' | 'ko' | 'ja' | 'ru' | 'it' | 'pl' | 'uk';

interface Task { 
  id: string; text: string; description?: string; completed: boolean; date: string; dueDate?: string; showEveryDayUntilDue?: boolean; categoryId: string; notificationTime?: string | null; alarmTime?: string | null; assignedBy?: string; assignedByName?: string; assignedTo?: string; 
}

interface Habit {
  id: string; title: string; frequency: 'daily' | 'weekly'; selectedDays: number[]; endDate?: string | null; notificationTime?: string | null; notificationIds?: string[]; completedDates: string[]; categoryId: string; createdAt: any;
}

interface Category { id: string; name: string; color: string; }
interface Contact { uid: string; username: string; email: string; phoneNumber?: string; canAssignToMe: boolean; defaultCategoryId?: string; photoURL?: string; displayName?: string;  publicKey?: string; }
interface FriendRequest { id: string; fromUid: string; fromUsername: string; fromEmail: string; status: 'pending'; }
interface DeviceContact { id: string; name: string; phoneNumber: string; isAppUser?: boolean; uid?: string; }
interface ChatMessage { id: string; text: string; senderId: string; timestamp: any; read?: boolean; }

const getISODate = (date: Date): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

const formatDateDDMMYYYY = (date: Date): string => {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}-${month}-${year}`;
};

const parseDueDate = (dateStr?: string) => {
    if (!dateStr) return Infinity; 
    const parts = dateStr.split('-');
    if (parts.length !== 3) return Infinity;
    return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])).getTime();
};

const convertDDMMYYYYtoISO = (dateStr: string) => {
    if (!dateStr) return ""; // BoÅŸ kontrolÃ¼
    const parts = dateStr.split('-');
    if (parts.length !== 3) return dateStr;
    
    // DÃœZELTME: padStart(2, '0') ile tek haneli sayÄ±larÄ±n baÅŸÄ±na 0 ekliyoruz.
    const day = parts[0].padStart(2, '0');
    const month = parts[1].padStart(2, '0');
    const year = parts[2];
    
    return `${year}-${month}-${day}`;
};

const maskDateInput = (text: string) => {
  const cleaned = text.replace(/[^0-9]/g, '');
  let formatted = cleaned;
  if (cleaned.length > 2) formatted = cleaned.slice(0, 2) + '-' + cleaned.slice(2);
  if (cleaned.length > 4) formatted = formatted.slice(0, 5) + '-' + cleaned.slice(4);
  return formatted.slice(0, 10); 
};

const maskTimeInput = (text: string) => {
  const cleaned = text.replace(/[^0-9]/g, '');
  let formatted = cleaned;
  if (cleaned.length > 2) formatted = cleaned.slice(0, 2) + ':' + cleaned.slice(2);
  return formatted.slice(0, 5);
};

const GREETINGS = {
  en:{morning:"Good morning",afternoon:"Good afternoon",evening:"Good evening"},
  tr:{morning:"GÃ¼naydÄ±n",afternoon:"TÃ¼naydÄ±n",evening:"Ä°yi akÅŸamlar"},
  nl:{morning:"Goedemorgen",afternoon:"Goedemiddag",evening:"Goedenavond"},
  de:{morning:"Guten Morgen",afternoon:"Guten Nachmittag",evening:"Guten Abend"},
  es:{morning:"Buenos dÃ­as",afternoon:"Buenas tardes",evening:"Buenas noches"},
  fr:{morning:"Bonjour",afternoon:"Bon aprÃ¨s-midi",evening:"Bonsoir"},
  ar:{morning:"ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±",afternoon:"Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±",evening:"Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±"},
  id:{morning:"Selamat pagi",afternoon:"Selamat siang",evening:"Selamat malam"},
  pt:{morning:"Bom dia",afternoon:"Boa tarde",evening:"Boa noite"},
  hi:{morning:"à¤¸à¥à¤ªà¥à¤°à¤­à¤¾à¤¤",afternoon:"à¤¨à¤®à¤¸à¥à¤•à¤¾à¤°",evening:"à¤¶à¥à¤­ à¤¸à¤‚à¤§à¥à¤¯à¤¾"},
  ko:{morning:"ì¢‹ì€ ì•„ì¹¨",afternoon:"ì¢‹ì€ ì˜¤í›„",evening:"ì¢‹ì€ ì €ë…"},
  ja:{morning:"ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™",afternoon:"ã“ã‚“ã«ã¡ã¯",evening:"ã“ã‚“ã°ã‚“ã¯"},
  ru:{morning:"Ð”Ð¾Ð±Ñ€Ð¾Ðµ ÑƒÑ‚Ñ€Ð¾",afternoon:"Ð”Ð¾Ð±Ñ€Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ",evening:"Ð”Ð¾Ð±Ñ€Ñ‹Ð¹ Ð²ÐµÑ‡ÐµÑ€"},
  it:{morning:"Buongiorno",afternoon:"Buon pomeriggio",evening:"Buonasera"},
  pl:{morning:"DzieÅ„ dobry",afternoon:"DzieÅ„ dobry",evening:"Dobry wieczÃ³r"},
  uk:{morning:"Ð”Ð¾Ð±Ñ€Ð¾Ð³Ð¾ Ñ€Ð°Ð½ÐºÑƒ",afternoon:"Ð”Ð¾Ð±Ñ€Ð¸Ð¹ Ð´ÐµÐ½ÑŒ",evening:"Ð”Ð¾Ð±Ñ€Ð¸Ð¹ Ð²ÐµÑ‡Ñ–Ñ€"}
};
const getGreeting = (lang:LangCode)=>{const hour=new Date().getHours();const g=GREETINGS[lang]||GREETINGS.en;return hour<12?g.morning:hour<18?g.afternoon:g.evening;};


const DAYS_OF_WEEK_MAP = {
  en:[{id:1,label:"Mon"},{id:2,label:"Tue"},{id:3,label:"Wed"},{id:4,label:"Thu"},{id:5,label:"Fri"},{id:6,label:"Sat"},{id:0,label:"Sun"}],
  tr:[{id:1,label:"Pzt"},{id:2,label:"Sal"},{id:3,label:"Ã‡ar"},{id:4,label:"Per"},{id:5,label:"Cum"},{id:6,label:"Cmt"},{id:0,label:"Paz"}],
  nl:[{id:1,label:"Ma"},{id:2,label:"Di"},{id:3,label:"Wo"},{id:4,label:"Do"},{id:5,label:"Vr"},{id:6,label:"Za"},{id:0,label:"Zo"}],
  de:[{id:1,label:"Mo"},{id:2,label:"Di"},{id:3,label:"Mi"},{id:4,label:"Do"},{id:5,label:"Fr"},{id:6,label:"Sa"},{id:0,label:"So"}],
  es:[{id:1,label:"Lun"},{id:2,label:"Mar"},{id:3,label:"MiÃ©"},{id:4,label:"Jue"},{id:5,label:"Vie"},{id:6,label:"SÃ¡b"},{id:0,label:"Dom"}],
  fr:[{id:1,label:"Lun"},{id:2,label:"Mar"},{id:3,label:"Mer"},{id:4,label:"Jeu"},{id:5,label:"Ven"},{id:6,label:"Sam"},{id:0,label:"Dim"}],
  ar:[{id:1,label:"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†"},{id:2,label:"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"},{id:3,label:"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡"},{id:4,label:"Ø§Ù„Ø®Ù…ÙŠØ³"},{id:5,label:"Ø§Ù„Ø¬Ù…Ø¹Ø©"},{id:6,label:"Ø§Ù„Ø³Ø¨Øª"},{id:0,label:"Ø§Ù„Ø£Ø­Ø¯"}],
  id:[{id:1,label:"Sen"},{id:2,label:"Sel"},{id:3,label:"Rab"},{id:4,label:"Kam"},{id:5,label:"Jum"},{id:6,label:"Sab"},{id:0,label:"Min"}],
  pt:[{id:1,label:"Seg"},{id:2,label:"Ter"},{id:3,label:"Qua"},{id:4,label:"Qui"},{id:5,label:"Sex"},{id:6,label:"SÃ¡b"},{id:0,label:"Dom"}],
  hi:[{id:1,label:"à¤¸à¥‹à¤®"},{id:2,label:"à¤®à¤‚à¤—à¤²"},{id:3,label:"à¤¬à¥à¤§"},{id:4,label:"à¤—à¥à¤°à¥"},{id:5,label:"à¤¶à¥à¤•à¥à¤°"},{id:6,label:"à¤¶à¤¨à¤¿"},{id:0,label:"à¤°à¤µà¤¿"}],
  ko:[{id:1,label:"ì›”"},{id:2,label:"í™”"},{id:3,label:"ìˆ˜"},{id:4,label:"ëª©"},{id:5,label:"ê¸ˆ"},{id:6,label:"í† "},{id:0,label:"ì¼"}],
  ja:[{id:1,label:"æœˆ"},{id:2,label:"ç«"},{id:3,label:"æ°´"},{id:4,label:"æœ¨"},{id:5,label:"é‡‘"},{id:6,label:"åœŸ"},{id:0,label:"æ—¥"}],
  ru:[{id:1,label:"ÐŸÐ½"},{id:2,label:"Ð’Ñ‚"},{id:3,label:"Ð¡Ñ€"},{id:4,label:"Ð§Ñ‚"},{id:5,label:"ÐŸÑ‚"},{id:6,label:"Ð¡Ð±"},{id:0,label:"Ð’Ñ"}],
  it:[{id:1,label:"Lun"},{id:2,label:"Mar"},{id:3,label:"Mer"},{id:4,label:"Gio"},{id:5,label:"Ven"},{id:6,label:"Sab"},{id:0,label:"Dom"}],
  pl:[{id:1,label:"Pon"},{id:2,label:"Wto"},{id:3,label:"Åšro"},{id:4,label:"Czw"},{id:5,label:"PiÄ…"},{id:6,label:"Sob"},{id:0,label:"Nie"}],
  uk:[{id:1,label:"ÐŸÐ½"},{id:2,label:"Ð’Ñ‚"},{id:3,label:"Ð¡Ñ€"},{id:4,label:"Ð§Ñ‚"},{id:5,label:"ÐŸÑ‚"},{id:6,label:"Ð¡Ð±"},{id:0,label:"ÐÐ´"}]
};

const getDaysOfWeek = (lang:LangCode)=>DAYS_OF_WEEK_MAP[lang]||DAYS_OF_WEEK_MAP.en;

setupCalendarLocales();
// lang prop'unu ekledik
export default function OmmioApp() {
  const [theme, setTheme] = useState<ThemeMode>("system");
  const [rememberMe, setRememberMe] = useState(true);
  const systemScheme = useColorScheme();
  const [user, setUser] = useState<any>(null);
  const [isAuthLoading, setIsAuthLoading] = useState(true);
  const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
  const [authMethod, setAuthMethod] = useState<'email' | 'phone'>('email'); 
  const [authMode, setAuthMode] = useState<'login' | 'signup'>('login');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [username, setUsername] = useState('');
  const [phoneNumber, setPhoneNumber] = useState(''); 
  const [newCategoryColor, setNewCategoryColor] = useState('blue'); // VarsayÄ±lan renk
  const CATEGORY_PALETTE = ['blue', 'orange', 'green', 'purple','pink']; // SeÃ§enekler
  const [tasks, setTasks] = useState<Task[]>([]);
  const [habits, setHabits] = useState<Habit[]>([]);
  const [contacts, setContacts] = useState<Contact[]>([]);
  const [friendRequests, setFriendRequests] = useState<FriendRequest[]>([]);


  // Mevcut editUsernameInput'un hemen altÄ±na ekleyin:
  const [editDisplayNameInput, setEditDisplayNameInput] = useState("");

  const [taskComments, setTaskComments] = useState<any[]>([]); // YorumlarÄ± tutar
  const [taskCommentInput, setTaskCommentInput] = useState(""); // Yorum yazma kutusu
  const [taskModalTab, setTaskModalTab] = useState<'details' | 'chat'>('details'); // Modal iÃ§indeki sekme
  
  // Profil DÃ¼zenleme State'leri
  const [isEditProfileVisible, setIsEditProfileVisible] = useState(false);
  const [editUsernameInput, setEditUsernameInput] = useState("");

  const [isCalendarExpanded, setIsCalendarExpanded] = useState(false); // Takvim aÃ§Ä±k/kapalÄ± kontrolÃ¼

  // OmmioApp fonksiyonunun iÃ§ine, diÄŸer state'lerin yanÄ±na ekle
const [isSplashAnimationComplete, setIsSplashAnimationComplete] = useState(false);

const passwordRef = useRef<TextInput>(null);

  // --- REKLAM VE SAYAÃ‡ STATE'LERÄ° ---
  // Hangi eylemden kaÃ§ tane yapÄ±ldÄ±?  
  // --- REKLAM & PREMIUM MANTIÄžI ---
  const [adCounters, setAdCounters] = useState({ tasks: 0, habits: 0, assigned: 0, time: 0 });
  const [isAdVisible, setIsAdVisible] = useState(false);
  const [isUpsellVisible, setIsUpsellVisible] = useState(false);
  
  // YENÄ°: Reklam geri sayÄ±mÄ± (BaÅŸlangÄ±Ã§ 5 saniye)
  const [adCountdown, setAdCountdown] = useState(5); 

  const AD_THRESHOLDS = { tasks: 4, habits: 4, assigned: 3, time: 300 };



  const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);
  const [newPasswordInput, setNewPasswordInput] = useState("");

// Landing Page mi gÃ¶sterilsin yoksa Auth ekranÄ± mÄ±?
// Web deÄŸilse (Android/iOS) direkt true baÅŸlasÄ±n.
const [showAuth, setShowAuth] = useState(Platform.OS !== 'web');
// ... state tanÄ±mlarÄ± ...

const handlePageScroll = (e: any) => {
    const index = e.nativeEvent.position;
    // EÄŸer TAB_ORDER tanÄ±mlÄ± deÄŸilse hata almamak iÃ§in kontrol edelim
    if (TAB_ORDER && TAB_ORDER[index]) {
        // @ts-ignore
        setActiveTab(TAB_ORDER[index]); 
    }
};

// PagerView kontrolÃ¼ iÃ§in referans
const pagerRef = useRef<PagerView>(null);

// TablarÄ±n sÄ±rasÄ± (Ã–NEMLÄ°: Bu sÄ±ra BottomBar'daki sÄ±rayla aynÄ± olmalÄ±)
const TAB_ORDER = ['list', 'habits', 'messages', 'social', 'profile'];

// Tab deÄŸiÅŸtirme fonksiyonu (Hem tÄ±klama hem kaydÄ±rma iÃ§in)
const handleTabChange = (index: number) => {
    const tabName = TAB_ORDER[index];
    // State'i gÃ¼ncelle (ikonun rengi deÄŸiÅŸsin diye)
    // @ts-ignore
    setActiveTab(tabName); 
};

// Alt bara tÄ±klandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak fonksiyon
const onBottomTabPress = (tabName: string) => {
    setActiveTab(tabName as any);
    const index = TAB_ORDER.indexOf(tabName);
    // SayfayÄ± o indexe kaydÄ±r
    pagerRef.current?.setPage(index);
};


  // --- YENÄ° STATE TANIMLARI ---
  
  // 1. GeliÅŸmiÅŸ Toast (Bildirim) State'i
const [customToast, setCustomToast] = useState<{visible: boolean;
    title: string;
    message: string;
    type: 'success' | 'error' | 'info' | 'warning';}>({     visible: false, 
    title: '', 
    message: '', 
    type: 'success' });

  // 2. Ã–zel Onay Kutusu (Confirm Modal) State'i
  const [confirmModal, setConfirmModal] = useState({ visible: false, title: '', message: '', onConfirm: () => {}, // OnaylanÄ±nca Ã§alÄ±ÅŸacak fonksiyon
      isDestructive: false // Silme iÅŸlemiyse kÄ±rmÄ±zÄ± buton olsun mu?
  });

  const [friendTasksModal, setFriendTasksModal] = useState<{visible: boolean; tasks: any[]; // veya Task[] yazabilirsin ama any[] ÅŸimdilik hatalarÄ± Ã§Ã¶zer
    friendName: string;}>({ visible: false, tasks: [], friendName: '' });

  // Toast Bildirim State'i
  const [toast, setToast] = useState({ visible: false, message: '', type: 'success' }); // type: 'success' | 'error' | 'info'

  // Her arkadaÅŸÄ±n son mesajÄ±nÄ± ve okunmamÄ±ÅŸ sayÄ±sÄ±nÄ± tutar: { [uid]: { text, time, unread } }

  const [isGuestModalOpen, setIsGuestModalOpen] = useState(false);
  const [chatPreviews, setChatPreviews] = useState<any>({});

  // Sosyal sekmesinde hangi kiÅŸinin detaylarÄ±nÄ±n aÃ§Ä±k olduÄŸunu tutar
  const [expandedContactId, setExpandedContactId] = useState<string | null>(null);

  // NAVIGATION STATE
  const [activeTab, setActiveTab] = useState<'list' | 'habits' | 'messages' | 'social' | 'profile' | 'chat_room'>('list');
  const [chatTarget, setChatTarget] = useState<Contact | null>(null); 
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);
  const [chatInput, setChatInput] = useState("");

  const [isPremium, setIsPremium] = useState(false);  

  const [isTyping, setIsTyping] = useState(false); // KarÅŸÄ± taraf yazÄ±yor mu?
  const [lastVisibleMsg, setLastVisibleMsg] = useState<any>(null); // Pagination iÃ§in
  const [loadingMoreMsg, setLoadingMoreMsg] = useState(false);

  const [showOnboarding, setShowOnboarding] = useState(false);
  const [onboardingStep, setOnboardingStep] = useState(0);
  
  const [msgLimit, setMsgLimit] = useState(125); // BaÅŸlangÄ±Ã§ta 125 mesaj gÃ¶ster

  

  const getDeviceLang = () => {
    const loc = Localization.getLocales()[0]; // CihazÄ±n birincil dili
    const code = loc ? loc.languageCode : 'en'; 
    // LANGUAGES dizisinde bu kod var mÄ± kontrol et, yoksa 'en' dÃ¶ndÃ¼r
    return LANGUAGES.some(l => l.code === code) ? code : 'en';
};



// State tanÄ±mlarken varsayÄ±lan deÄŸeri buna eÅŸitle
const [lang, setLang] = useState<LangCode>(getDeviceLang() as LangCode);
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [isSettingsOpen, setIsSettingsOpen] = useState<boolean>(false);
  const [isLangModalOpen, setIsLangModalOpen] = useState(false);
  const [isCompletedExpanded, setIsCompletedExpanded] = useState(false);
  const [isOverdueExpanded, setIsOverdueExpanded] = useState(true);
  const [taskViewMode, setTaskViewMode] = useState<'list' | 'category'>('list');

  // ADD MODAL STATE (Eksik olanlar eklendi)
  
  const [isAddModalOpen, setIsAddModalOpen] = useState(false); 
  const [addMode, setAddMode] = useState<'task' | 'habit'>('task'); 
  
  const router = useRouter();

  const [inputValue, setInputValue] = useState("");
  const [inputDesc, setInputDesc] = useState("");
  const [inputDueDate, setInputDueDate] = useState(""); 
  const [inputStartDate, setInputStartDate] = useState(""); 
  const [notifInput, setNotifInput] = useState("");
  const [alarmInput, setAlarmInput] = useState("");
  const [isNotifOn, setIsNotifOn] = useState(false);
  const [isAlarmOn, setIsAlarmOn] = useState(false);
  const [isEveryDayOn, setIsEveryDayOn] = useState(false);
  const [assignTarget, setAssignTarget] = useState<Contact | null>(null);

  const [newHabitTitle, setNewHabitTitle] = useState("");
  const [newHabitFreq, setNewHabitFreq] = useState<'daily' | 'weekly'>('daily');
  const [newHabitDays, setNewHabitDays] = useState<number[]>([]);
  const [newHabitEndDate, setNewHabitEndDate] = useState("");
  const [habitNotifInput, setHabitNotifInput] = useState(""); 
  const [isHabitModalOpen, setIsHabitModalOpen] = useState(false);
  // ... diÄŸer state tanÄ±mlarÄ±
  const [newCategoryName, setNewCategoryName] = useState("");

  const [categories, setCategories] = useState<Category[]>([
      { id: 'work', name: 'Ä°ÅŸ', color: 'blue' }, 
      { id: 'home', name: 'Ev', color: 'orange' },
      { id: 'personal', name: 'KiÅŸisel', color: 'green' }
  ]);
  const [selectedCategory, setSelectedCategory] = useState<Category>(categories[0]);

  const [selectedTask, setSelectedTask] = useState<Task | null>(null);
  const [expandedTaskId, setExpandedTaskId] = useState<string | null>(null);
  const [activeAlarmTask, setActiveAlarmTask] = useState<Task | null>(null);
  const [detailText, setDetailText] = useState("");
  const [detailDesc, setDetailDesc] = useState("");
  const [detailDueDate, setDetailDueDate] = useState("");

  // DATE PICKERS
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [showDetailDatePicker, setShowDetailDatePicker] = useState(false); 
  const [showHabitDatePicker, setShowHabitDatePicker] = useState(false);
  const [datePickerTarget, setDatePickerTarget] = useState<'start' | 'due' | 'habitEnd' | 'detail'>('start');

  const [deviceContacts, setDeviceContacts] = useState<DeviceContact[]>([]); 
  const [assignSearchText, setAssignSearchText] = useState("");
  const [searchUsername, setSearchUsername] = useState("");
  const [isNetworkModalOpen, setIsNetworkModalOpen] = useState(false);
  const [networkTab, setNetworkTab] = useState<'ommio' | 'contacts'>('ommio'); 
  const [isInputExpanded, setIsInputExpanded] = useState(false);

  

    // Google Auth KÄ±smÄ±nÄ± BÃ¶yle GÃ¼ncelle:
    // Bu kÄ±smÄ± Google.useIdTokenAuthRequest'in hemen Ã¼zerine yazÄ±n
const currentRedirectUri = React.useMemo(() => {
    return AuthSession.makeRedirectUri({
        scheme: 'ommioapp',
        path: 'auth' // Bunu eklemek bazen sorunu Ã§Ã¶zer
    });
}, []);

// Mevcut hook'unuzu bu yeni deÄŸiÅŸkeni kullanacak ÅŸekilde gÃ¼ncelleyin:
const [request, response, promptAsync] = Google.useIdTokenAuthRequest({
    clientId: '677937409612-ijhg8dbhknb24hs53t9r8gvse397pvrh.apps.googleusercontent.com',
    iosClientId: '677937409612-sats3t36t7mko7i2lds7m45sc52aofq2.apps.googleusercontent.com',
    androidClientId: '677937409612-prdicaptu9fn46vmbp4o1c05nrhg2asb.apps.googleusercontent.com',
    redirectUri: currentRedirectUri, // BURAYI GÃœNCELLEDÄ°K
    prompt: Prompt.SelectAccount,
    extraParams: { access_type: 'offline' },
});

  useEffect(() => {
   if (response?.type === 'success') {
        const { id_token } = response.params;
        const credential = GoogleAuthProvider.credential(id_token);
        
        // Loading baÅŸlat
        setIsAuthLoading(true);

        signInWithCredential(auth, credential)
            .then(async (userCredential) => {
          // Google giriÅŸi baÅŸarÄ±lÄ± oldu.
          // Åžimdi bu kullanÄ±cÄ±yÄ± veritabanÄ±na da kaydedelim (EÄŸer yoksa)
          const user = userCredential.user;
          const userRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(userRef);

          if (!docSnap.exists()) {
                  
                  // Google'dan gelen isimden kullanÄ±cÄ± adÄ± tÃ¼retelim
                  // Ã–rn: "Enes Berkay" -> "enesberkay_4821"
                  const randomSuffix = Math.floor(Math.random() * 10000);
                  const baseName = (user.displayName || "user").toLowerCase()
                      .replace(/\s+/g, '')
                      .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
                      .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c');
                  
                  const autoUsername = `${baseName}_${randomSuffix}`;

                  // VeritabanÄ±na yaz
                  await setDoc(userRef, {
                      uid: user.uid,
                      email: user.email,
                      username: autoUsername, // OTOMATÄ°K OLUÅžTURDUK
                      displayName: user.displayName || "Google User",
                      createdAt: serverTimestamp(),
                      photoURL: user.photoURL,
                      categories: [
                          { id: 'work', name: t('work'), color: 'blue' },
                          { id: 'home', name: t('home'), color: 'orange' },
                          { id: 'personal', name: t('personal'), color: 'green' }
                      ]
                  });
                  
                  // Public profil
                  await setDoc(doc(db, "public_users", user.uid), {
                      uid: user.uid,
                      username: autoUsername,
                      email: user.email,
                      photoURL: user.photoURL
                  });
              }
      })
            .catch((error) => {
                console.log("Google Sign-In Error:", error);
                showToast(t('login_error'), t('google_login_failed') + error.message, 'error');
            })
            .finally(() => {
                setIsAuthLoading(false);
            });
    } else if (response?.type === 'error') {
        showToast(t('warning_title'), t('google_connection_error'), 'error');
    }
}, [response]);
// --- EKSÄ°K OLAN PARÃ‡A: SEÃ‡Ä°LÄ° SOHBETÄ°N MESAJLARINI DÄ°NLEME ---
  useEffect(() => {
    // EÄŸer bir sohbet seÃ§ilmediyse veya kullanÄ±cÄ± yoksa iÅŸlem yapma
    if (!chatTarget || !user) return;

    // Chat ID oluÅŸtur (Alfabetik sÄ±raya gÃ¶re, bÃ¶ylece her iki tarafta da aynÄ± ID olur)
    const chatId = [user.uid, chatTarget.uid].sort().join('_');

    // Sorguyu hazÄ±rla: MesajlarÄ± tarihe gÃ¶re tersten sÄ±rala (en yeni en altta)
    const q = query(
      collection(db, "chats", chatId, "messages"),
      orderBy("timestamp", "desc")
    );

    // Dinlemeyi baÅŸlat
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const msgs = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as ChatMessage[];
      
      setChatMessages(msgs);
      
      // Okundu bilgisini gÃ¼ncelle (KarÅŸÄ± tarafÄ±n attÄ±ÄŸÄ± mesajlarÄ± okundu yap)
      snapshot.docs.forEach(async (docSnap) => {
         const msgData = docSnap.data();
         if (msgData.senderId !== user.uid && !msgData.read) {
             await updateDoc(doc(db, "chats", chatId, "messages", docSnap.id), { read: true });
         }
      });
    });

    // Sohbetten Ã§Ä±kÄ±nca dinlemeyi durdur
    return () => unsubscribe();
  }, [chatTarget, user]); // chatTarget deÄŸiÅŸtiÄŸinde (baÅŸka sohbete girince) tekrar Ã§alÄ±ÅŸÄ±r
// --- GÃ–REV Ä°Ã‡Ä° YORUMLARI DÄ°NLEME ---
  // --- GÃ–REV Ä°Ã‡Ä° YORUMLARI DÄ°NLEME (GÃœNCELLENDÄ°) ---
  useEffect(() => {
    // 1. GÃ¼venlik KontrolÃ¼
    if (!selectedTask || !user) return;

    // 2. ID Belirleme (Ã‡ok Ã–nemli)
    // EÄŸer 'assignedTo' varsa onu kullan, yoksa 'assignedBy' (gÃ¶revi oluÅŸturan), o da yoksa kendi ID'n.
    // VeritabanÄ± yapÄ±nÄ±za gÃ¶re gÃ¶revler "users/{USER_ID}/tasks" altÄ±nda durur.
    // addTask fonksiyonunuza baktÄ±ÄŸÄ±mda:
    // - BaÅŸkasÄ±na atadÄ±ysanÄ±z: users/{friendID}/tasks iÃ§ine kaydettiniz.
    // - Kendinize atadÄ±ysanÄ±z: users/{myID}/tasks iÃ§ine kaydettiniz.
    // Yani: GÃ¶revin durduÄŸu yer = assignedTo (eÄŸer varsa) yoksa user.uid
    
    let targetDbId = user.uid;
    
    if (selectedTask.assignedTo) {
        targetDbId = selectedTask.assignedTo;
    } else if (selectedTask.assignedBy === user.uid) {
        // EÄŸer ben oluÅŸturduysam ve kime atandÄ±ÄŸÄ± belli deÄŸilse (eski veri) bendedir.
        targetDbId = user.uid;
    }

    // Konsola yazdÄ±rÄ±p kontrol edelim (Hata ayÄ±klama iÃ§in)
    console.log("Sohbet Baglantisi Kuruluyor:", `users/${targetDbId}/tasks/${selectedTask.id}/comments`);

    try {
        const q = query(
          collection(db, "users", targetDbId, "tasks", selectedTask.id, "comments"),
          orderBy("createdAt", "asc")
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
          const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setTaskComments(msgs);
        }, (error) => {
            console.error("Snapshot Hatasi:", error);
            // Ä°zin hatasÄ± olursa kullanÄ±cÄ±ya bildirim gÃ¶stermeyelim, sadece konsola yazsÄ±n.
        });

        return () => unsubscribe();
    } catch (err) {
        console.log("Query Hatasi:", err);
    }
  }, [selectedTask]);

  // --- GÃ–REV YORUMU GÃ–NDERME (GÃœNCELLENDÄ°) ---
  const sendTaskComment = async () => {
    if (!taskCommentInput.trim() || !selectedTask || !user) return;

    // YukarÄ±daki mantÄ±ÄŸÄ±n aynÄ±sÄ±
    let targetDbId = user.uid;
    if (selectedTask.assignedTo) {
        targetDbId = selectedTask.assignedTo;
    }

    try {
      await addDoc(collection(db, "users", targetDbId, "tasks", selectedTask.id, "comments"), {
        text: taskCommentInput.trim(),
        senderId: user.uid,
        senderName: user.displayName || user.username,
        photoURL: user.photoURL || null,
        createdAt: serverTimestamp()
      });
      setTaskCommentInput(""); 
    } catch (e: any) {
      console.error("Yorum GÃ¶nderme HatasÄ±:", e);
      showToast(t('warning_title'), t('comment_failed') + e.message, 'error');
    }
  };
  
  useEffect(() => {
    const checkFirstLaunch = async () => {
        const hasLaunched = await AsyncStorage.getItem("hasLaunched");
        if (hasLaunched === null) {
            setShowOnboarding(true);
            await AsyncStorage.setItem("hasLaunched", "true");
        }
    };
    checkFirstLaunch();
}, []);
  // --- APPLE LOGIN ---
  // --- APPLE LOGIN (GÃœNCELLENMÄ°Åž) ---
  const handleAppleLogin = async () => {
    try {
      // 1. Ä°ÅŸlem baÅŸladÄ±ÄŸÄ±nÄ± kullanÄ±cÄ±ya hissettir
      setIsAuthLoading(true);

      // 2. Apple Native Penceresini AÃ§
      const credential = await AppleAuthentication.signInAsync({
        requestedScopes: [
          AppleAuthentication.AppleAuthenticationScope.FULL_NAME,
          AppleAuthentication.AppleAuthenticationScope.EMAIL,
        ],
      });

      console.log("Apple Credential AlÄ±ndÄ±:", credential); // Konsoldan takip et

      const { identityToken } = credential;
      
      if (identityToken) {
        // 3. Firebase ile BaÄŸlantÄ± Kur
        const provider = new OAuthProvider('apple.com');
        const oAuthCredential = provider.credential({ idToken: identityToken });
        
        // Bu iÅŸlem baÅŸarÄ±lÄ± olursa, useEffect'teki onAuthStateChanged tetiklenir ve sayfayÄ± yÃ¶nlendirir.
        await signInWithCredential(auth, oAuthCredential);
        console.log("Firebase Apple GiriÅŸi BaÅŸarÄ±lÄ±!");
      } else {
        throw new Error("Apple Identity Token alÄ±namadÄ±.");
      }

    } catch (e: any) {
      setIsAuthLoading(false); // Hata olursa loading'i kapat
      console.error("Apple Login HatasÄ±:", e);

      // KullanÄ±cÄ± vazgeÃ§tiyse hata gÃ¶sterme
      if (e.code === 'ERR_CANCELED') {
          console.log("KullanÄ±cÄ± giriÅŸi iptal etti.");
      } else {
          // GerÃ§ek hatayÄ± ekrana bas
          showToast(t('warning_title'), t('apple_login_failed') + e.message, 'error');
      }
    }
  };
  // --- MÄ°SAFÄ°R UYARISI ---
  const checkGuest = (actionName: string) => {
  if (user && user.isAnonymous) {
    askConfirmation(
      t('auth_guest_title') || t('auth_guest_title'),
      tFormat('feature_login_required', { actionName: 'Mesaj GÃ¶nderme' }),
      handleLogout // Onayla'ya basÄ±nca Ã§Ä±kÄ±ÅŸ yapar (KayÄ±t ekranÄ±na dÃ¶ner)
    );
    return true; // Ä°ÅŸlemi durdurur
  }
  return false;
};

  // --- MÄ°SAFÄ°R GÄ°RÄ°ÅžÄ° ---
  // --- MÄ°SAFÄ°R GÄ°RÄ°ÅžÄ° ---
  const handleGuestLogin = async () => {
    // 1. Loading baÅŸlat
    setIsAuthLoading(true);
    console.log("Misafir giriÅŸi baÅŸlatÄ±lÄ±yor...");

    try {
      // 2. Firebase Anonim GiriÅŸ Ä°steÄŸi
      const userCredential = await signInAnonymously(auth);
      const guestUser = userCredential.user;
      
      console.log("Misafir giriÅŸi baÅŸarÄ±lÄ±, ID:", guestUser.uid);

      // 3. VeritabanÄ±na kayÄ±t (Hata alsa bile giriÅŸ baÅŸarÄ±lÄ± sayÄ±lsÄ±n diye try-catch iÃ§inde)
      try {
          await setDoc(doc(db, "users", guestUser.uid), {
            uid: guestUser.uid,
            username: "misafir_" + Math.floor(Math.random() * 100000),
            displayName: "Misafir KullanÄ±cÄ±",
            createdAt: serverTimestamp(),
            categories: [
              { id: 'work', name: 'Ä°ÅŸ', color: 'blue' },
              { id: 'home', name: 'Ev', color: 'orange' },
              { id: 'personal', name: 'KiÅŸisel', color: 'green' }
            ],
            isGuest: true
          });
      } catch (dbError) {
          console.log("VeritabanÄ± oluÅŸturma hatasÄ± (Ã–nemli deÄŸil, giriÅŸ yapÄ±ldÄ±):", dbError);
      }

      // BaÅŸarÄ±lÄ± olduÄŸunda useEffect'teki onAuthStateChanged tetiklenecek ve sayfayÄ± aÃ§acaktÄ±r.

    } catch (error: any) {
      console.error("Misafir GiriÅŸ HatasÄ±:", error);
      
      let errorMsg = error.message;
      if (error.code === 'auth/operation-not-allowed') {
          errorMsg = "Firebase konsolundan 'Anonymous' giriÅŸi aÃ§Ä±lmamÄ±ÅŸ.";
      } else if (error.code === 'auth/network-request-failed') {
          errorMsg = "Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.";
      }

      showToast(t('login_error'), errorMsg, 'error');
    } finally {
      // 4. Ä°ÅŸlem bitti, loading'i kapat
      setIsAuthLoading(false);
    }
  };
    // --- MEVCUT useEffect'LERÄ°N ALTINA EKLE ---

  // Dil deÄŸiÅŸtiÄŸinde Takvim dilini de otomatik gÃ¼ncelle
  useEffect(() => {
      // EÄŸer seÃ§ilen dil (Ã¶rn: 'ja', 'uk') config dosyasÄ±nda tanÄ±mlÄ±ysa onu yap
      if (LocaleConfig.locales[lang]) {
          LocaleConfig.defaultLocale = lang;
      } else {
          // TanÄ±mlÄ± deÄŸilse (garanti olsun diye) Ä°ngilizce yap
          LocaleConfig.defaultLocale = 'en';
      }
  }, [lang]); // 'lang' deÄŸiÅŸtiÄŸinde bu kod Ã§alÄ±ÅŸÄ±r

  // -------------------------------------------
  // --- EFFECT: AUTH & DATA ---
// --- GÃœNCELLENMÄ°Åž AUTH & VERÄ° Ã‡EKME KODU ---
  // --- AUTH & USER DATA LISTENER (DÃœZELTÄ°LMÄ°Åž HALÄ°) ---
  useEffect(() => {
    const checkPersistence = async () => {
        // KullanÄ±cÄ± daha Ã¶nce "Beni HatÄ±rla"yÄ± kapattÄ±ysa, aÃ§Ä±lÄ±ÅŸta Ã§Ä±kÄ±ÅŸ yap
        const shouldRemember = await AsyncStorage.getItem("ommio_remember_me");
        if (shouldRemember === "false") {
            await signOut(auth);
        }
    };
    checkPersistence();
    const unsubAuth = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        // 1. Auth objesini baÅŸlangÄ±Ã§ olarak ayarla
        // Not: user.delete() gibi fonksiyonlarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in currentUser'Ä± yayÄ±yoruz.
        setUser(currentUser); 
        setIsAuthLoading(false);
        registerForPushNotificationsAsync().then(async (token) => {
        if (token) {
            // Token'Ä± kullanÄ±cÄ±nÄ±n dokÃ¼manÄ±na kaydet
            await setDoc(doc(db, "users", currentUser.uid), { pushToken: token }, { merge: true });
            
            // Public Users'a da kaydet (BaÅŸkalarÄ± bize mesaj atabilsin diye)
            // NOT: Public Users koleksiyonunda olup olmadÄ±ÄŸÄ±nÄ±zÄ± kontrol edin, yoksa oluÅŸturun.
            try {
               await setDoc(doc(db, "public_users", currentUser.uid), { pushToken: token }, { merge: true });
            } catch(e) {}
        }
        generateAndStoreKeys(currentUser.uid);
    });

        try {
          const userDocRef = doc(db, "users", currentUser.uid);

          // 2. VeritabanÄ±nÄ± CanlÄ± Dinle (onSnapshot)
          const unsubDb = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
              const userData = docSnap.data();
              
              // BURASI Ã–NEMLÄ°: VeritabanÄ±ndan gelen TÃœM verileri (username, photoURL, categories vb.)
              // mevcut user state'inin Ã¼zerine yazÄ±yoruz.
              setUser((prev: any) => ({
                ...prev,       // Auth'dan gelen temel bilgiler ve metotlar korunsun
                ...userData    // Firestore'dan gelen gÃ¼ncel username, photoURL, vb. Ã¼zerine yazÄ±lsÄ±n
              }));
              if (userData.hasSeenOnboarding === false || userData.hasSeenOnboarding === undefined) {
                    setShowOnboarding(true);
                } else {
                    setShowOnboarding(false);
                }

              // Premium bilgisini ayrÄ±ca state'e at
              setIsPremium(userData.isPremium || false);
            }
          });
          
          // Cleanup (Component kapanÄ±rsa dinlemeyi durdur) iÃ§in array'e atÄ±labilir 
          // ama ÅŸimdilik basit tutuyoruz.
          
        } catch (e) {
          console.log("Veri Ã§ekme hatasÄ±", e);
        }
      } else {
        setUser(null);
        setIsAuthLoading(false);
      }
    });

    return () => unsubAuth();
  }, []);
  
  useEffect(() => { setInputStartDate(formatDateDDMMYYYY(selectedDate)); }, [selectedDate]);
  useEffect(() => {
    const loadSettings = async () => {
        try {
            const savedLang = await AsyncStorage.getItem("ommio_lang");
            const savedTheme = await AsyncStorage.getItem("ommio_theme");
            if (savedLang) setLang(savedLang as LangCode);
            if (savedTheme) setTheme(savedTheme as ThemeMode);
        } catch (e) {}
    };
    loadSettings();
  }, []);

  useEffect(() => {
    const saveSettings = async () => {
        try {
            await AsyncStorage.setItem("ommio_lang", lang);
            await AsyncStorage.setItem("ommio_theme", theme);
        } catch (e) {}
    };
    saveSettings();
  }, [lang, theme]);

  // --- REKLAM TETÄ°KLEYÄ°CÄ° FONKSÄ°YON ---
  // --- REKLAM TETÄ°KLEYÄ°CÄ° ---
  const checkAdTrigger = (type: 'tasks' | 'habits' | 'assigned') => {
    if (isPremium) return; // Premium ise hiÃ§ uÄŸraÅŸma

    setAdCounters(prev => {
      const newVal = prev[type] + 1;
      if (newVal >= AD_THRESHOLDS[type]) {
        // ReklamÄ± aÃ§madan Ã¶nce sayacÄ± 5'e sÄ±fÄ±rla
        setAdCountdown(5);
        setIsAdVisible(true);
        return { ...prev, [type]: 0 };
      }
      return { ...prev, [type]: newVal };
    });
  };

  // --- REKLAM GERÄ° SAYIM MANTIÄžI ---
  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (isAdVisible && adCountdown > 0) {
      interval = setInterval(() => {
        setAdCountdown((prev) => prev - 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isAdVisible, adCountdown]);

  // --- ARKA PLAN ZAMANLAYICI (10 Dk) ---
  useEffect(() => {
    if (!user || isPremium || isAdVisible) return; 
    const timer = setInterval(() => {
      setAdCounters(prev => {
        const newTime = prev.time + 1;
        if (newTime >= AD_THRESHOLDS.time) {
          setAdCountdown(5); // SÃ¼reyi resetle
          setIsAdVisible(true);
          return { ...prev, time: 0 };
        }
        return { ...prev, time: newTime };
      });
    }, 1000);
    return () => clearInterval(timer);
  }, [user, isPremium, isAdVisible]);

  // --- EKSÄ°K OLAN PARÃ‡A: GELEN ARKADAÅžLIK Ä°STEKLERÄ°NÄ° DÄ°NLEME ---
  useEffect(() => {
    if (!user) return;

    // KullanÄ±cÄ±nÄ±n "friend_requests" koleksiyonunu dinle
    const q = query(
      collection(db, "users", user.uid, "friend_requests"),
      orderBy("createdAt", "desc") // En yeni istek en Ã¼stte gÃ¶rÃ¼nsÃ¼n
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const requests = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      })) as FriendRequest[];
      
      console.log("Gelen Ä°stekler:", requests); // Konsoldan kontrol etmek iÃ§in
      setFriendRequests(requests);
    });

    return () => unsubscribe();
  }, [user]);

  // 1. GÃ–REVLERÄ° DÄ°NLEME (Tasks Listener) // --- CONTACTS GÃœNCELLEME MANTIÄžI (FOTOÄžRAFLARI CANLI TUTAR) ---
  // --- EKSÄ°K OLAN KISIM BAÅžLANGICI ---
  useEffect(() => {
    if (!user) return;

    // KullanÄ±cÄ±nÄ±n "tasks" koleksiyonunu oluÅŸturulma tarihine gÃ¶re dinle
    const q = query(
      collection(db, "users", user.uid, "tasks"),
      orderBy("createdAt", "desc") 
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedTasks = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }))as Task[];
      setTasks(fetchedTasks);
    });

    return () => unsubscribe();
  }, [user]);

  // 2. ALIÅžKANLIKLARI DÄ°NLEME (Habits Listener)
  useEffect(() => {
    if (!user) return;

    // KullanÄ±cÄ±nÄ±n "habits" koleksiyonunu dinle
    const q = query(
      collection(db, "users", user.uid, "habits"),
      orderBy("createdAt", "desc")
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedHabits = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }))as Habit[];
      setHabits(fetchedHabits);
    });

    return () => unsubscribe();
  }, [user]);

  // --- CONTACTS GÃœNCELLEME MANTIÄžI (Ä°SÄ°M, GÃ–RÃœNEN Ä°SÄ°M VE FOTOÄžRAF SENKRONÄ°ZASYONU) ---
  useEffect(() => {
    if (!user) return;

    const qContacts = query(collection(db, "users", user.uid, "contacts"));
    
    const unsubC = onSnapshot(qContacts, async (snap) => {
        const localContacts = snap.docs.map(d => d.data() as Contact);
        
        // Her arkadaÅŸÄ±n GÃœNCEL bilgilerini Public tablodan Ã§ekiyoruz
        const syncedContacts = await Promise.all(localContacts.map(async (contact) => {
            try {
                const publicDoc = await getDoc(doc(db, "public_users", contact.uid));
                
                if (publicDoc.exists()) {
                    const pData = publicDoc.data();
                    return { 
                        ...contact, 
                        // EÄŸer arkadaÅŸÄ±n displayName'i varsa onu al, yoksa username'i kullan
                        displayName: pData.displayName || pData.username, 
                        username: pData.username || contact.username, 
                        photoURL: pData.photoURL || null 
                    }; 
                }
                // Public veri yoksa, mevcut veride displayName yoksa username'i ata
                return { ...contact, displayName: contact.displayName || contact.username }; 
            } catch (e) {
                return contact;
            }
        }));

        setContacts(syncedContacts);
    });

    return () => unsubC();
  }, [user]);
  // --- CHAT Ã–NÄ°ZLEMELERÄ°NÄ° DÄ°NLEME ---
  useEffect(() => {
    if (!user || contacts.length === 0) return;

    const unsubscribers: any[] = [];

    contacts.forEach(contact => {
        const chatId = [user.uid, contact.uid].sort().join('_');
        const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "desc"));

        // Her sohbet odasÄ±nÄ± dinle
        const unsub = onSnapshot(q, (snapshot) => {
            if (!snapshot.empty) {
                const docs = snapshot.docs;
                const lastMsg = docs[0].data();
                
                // OkunmamÄ±ÅŸ mesajlarÄ± say (GÃ¶nderen ben deÄŸilsem ve read=false ise)
                const unreadCount = docs.filter(d => d.data().senderId !== user.uid && !d.data().read).length;

                setChatPreviews((prev: any) => ({
                    ...prev,
                    [contact.uid]: {
                        text: lastMsg.text,
                        timestamp: lastMsg.timestamp,
                        unread: unreadCount
                    }
                }));
            } else {
                // HiÃ§ mesaj yoksa
                setChatPreviews((prev: any) => ({
                    ...prev,
                    [contact.uid]: { text: t('no_message'), timestamp: null, unread: 0 }
                }));
            }
        });
        unsubscribers.push(unsub);
    });

    return () => {
        unsubscribers.forEach(u => u());
    };
  }, [contacts, user]); // Contacts deÄŸiÅŸirse (yeni arkadaÅŸ gelirse) tekrar Ã§alÄ±ÅŸÄ±r

  // --- EFFECT: CHAT ---


  useEffect(() => {
    // Sadece Android'de Ã§alÄ±ÅŸsÄ±n, Web veya iOS'ta hata vermesin
    if (Platform.OS === 'android') {
        
        // Verileri hazÄ±rla
        const todayISO = getISODate(new Date());
        
        // 1. BugÃ¼ne ait gÃ¶revleri filtrele
        const todaysTasks = tasks.filter(t => {
             if (t.date === todayISO) return true;
             // Her gÃ¼n tekrar edenler vs.
             if (t.showEveryDayUntilDue && t.dueDate) return todayISO >= t.date && todayISO <= convertDDMMYYYYtoISO(t.dueDate);
             return false;
        }).map(t => ({ text: t.text, completed: t.completed })); // Sadece gerekli veriyi al

        // 2. BugÃ¼ne ait alÄ±ÅŸkanlÄ±klarÄ± filtrele
        const todaysHabitsData = habits.filter(h => {
             // Basit filtreleme (DetaylÄ± mantÄ±ÄŸÄ±nÄ±zÄ± buraya koyabilirsiniz)
             if (h.frequency === 'daily') return true;
             if (h.frequency === 'weekly') return h.selectedDays.includes(new Date().getDay());
             return false;
        }).map(h => ({ 
            title: h.title, 
            completed: h.completedDates.includes(todayISO) 
        }));

        try {
            // @ts-ignore
            requestWidgetUpdate({
                widgetName: 'OmmioWidget',
                renderWidget: () => (
                    <WidgetTaskHandler 
                        tasks={todaysTasks} 
                        habits={todaysHabitsData} 
                    />
                ),
                widgetNotFound: () => {
                    console.log("Widget ana ekrana eklenmemiÅŸ.");
                }
            });
        } catch (e) {
            console.log("Widget gÃ¼ncelleme hatasÄ±:", e);
        }
    }
}, [tasks, habits]); // Tasks VEYA Habits deÄŸiÅŸtiÄŸinde Ã§alÄ±ÅŸÄ±r

  const t = (key: string) => {
    // @ts-ignore
    return TRANSLATIONS[lang]?.[key] || TRANSLATIONS['en']?.[key] || key;
  };
    const tFormat = (key: string, params: Record<string, string | number>) => {
        let text = t(key);
        Object.entries(params).forEach(([k, v]) => {
            text = text.replace(`{{${k}}}`, String(v));
        });
        return text;
    };
  // --- FONKSÄ°YONLAR ---
  // --- ARKADAÅž SÄ°LME ---
  const handleRemoveFriend = async (targetUid: string, targetName: string) => {
    // Ã–nce kullanÄ±cÄ±dan onay alalÄ±m
    askConfirmation(
        t('remove_friend'),
         tFormat('friend_remove_confirm', { targetName }),
        async () => {
             try {
                 // Promise.all ile Ä°KÄ° TARAFTAN DA aynÄ± anda siliyoruz
                 await Promise.all([
                     // 1. Benim listemden sil
                     deleteDoc(doc(db, "users", user.uid, "contacts", targetUid)),
                     
                     // 2. KarÅŸÄ± tarafÄ±n listesinden beni sil
                     deleteDoc(doc(db, "users", targetUid, "contacts", user.uid))
                 ]);

                 showToast(t('success'), tFormat('friend_removed', { targetName }), 'success');
                 
                 // State'i (EkranÄ±) gÃ¼ncellememiz lazÄ±m ki hemen kaybolsun
                 // (Firestore listener'Ä± bazen gecikebilir, bu satÄ±r anlÄ±k tepki verir)
                 setContacts(prev => prev.filter(c => c.uid !== targetUid));

             } catch(e: any) { 
                 console.log(e);
                 showToast(t('warning_title'), t('delete_incomplete') + e.message, 'error');
             }
        },
        true // KÄ±rmÄ±zÄ± buton (Tehlikeli iÅŸlem)
    );
};
// --- MÄ°SAFÄ°R HESABINI KALICI HESABA Ã‡EVÄ°RME ---
const handleConvertGuest = async () => {
    // 1. Validasyonlar
    if (!username.trim()) {
        showToast(t('missing_info'), t('auth_username_required'), 'warning');
        return;
    }
    if (!email.includes('@') || !email.includes('.')) {
        showToast(t('missing_info'), t('enter_valid_email'), 'warning');
        return;
    }
    if (password.length < 6) {
        showToast(t('missing_info'), t('password_min_length'), 'warning');
        return;
    }

    // --- HATA Ã‡Ã–ZÃœMÃœ: KULLANICI KONTROLÃœ ---
    if (!auth.currentUser) {
        showToast(t('warning_title'), t('session_not_found'), 'error');
        return;
    }
    // ---------------------------------------

    setIsAuthLoading(true);

    try {
        // 2. KullanÄ±cÄ± AdÄ± KontrolÃ¼
        const cleanUsername = username.trim().toLowerCase()
            .replace(/\s+/g, '')
            .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
            .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c');

        const q = query(collection(db, "public_users"), where("username", "==", cleanUsername));
        const checkUser = await getDocs(q);
        
        if (!checkUser.empty) {
            setIsAuthLoading(false);
            showToast(t('warning_title'), t('profile_username_taken'), 'warning');
            return;
        }

        // 3. HESAP BAÄžLAMA Ä°ÅžLEMÄ°
        const credential = EmailAuthProvider.credential(email, password);
        
        // HATA Ã‡Ã–ZÃœMÃœ: ArtÄ±k auth.currentUser'Ä±n null olmadÄ±ÄŸÄ±nÄ± garanti ettiÄŸimiz iÃ§in hata vermez.
        const userCredential = await linkWithCredential(auth.currentUser, credential);
        const linkedUser = userCredential.user;

        // 4. Firestore Verilerini GÃ¼ncelleme
        const updates = {
            username: cleanUsername,
            displayName: username,
            email: email,
            isGuest: false,
            categories: categories 
        };

        await setDoc(doc(db, "users", linkedUser.uid), updates, { merge: true });

        await setDoc(doc(db, "public_users", linkedUser.uid), {
            uid: linkedUser.uid,
            username: cleanUsername,
            displayName: username,
            photoURL: null 
        });

        await setDoc(doc(db, "usernames", cleanUsername), {
            email: email
        });

        // 5. BaÅŸarÄ±lÄ±
        setIsAuthLoading(false);
        // ModalÄ± kapatmak iÃ§in state'i false yapÄ±n (isGuestModalOpen varsa)
        setIsGuestModalOpen(false); 
        showToast(t('success'), t('account_created_success'), 'success');

    } catch (error: any) {
        setIsAuthLoading(false);
        console.error("Link Error:", error);
        
        let msg = t('process_failed');
        if (error.code === 'auth/email-already-in-use') {
            msg = t('email_in_use');
        } else if (error.code === 'auth/credential-already-linked') {
            msg = t('account_already_linked');
        } else if (error.code === 'auth/invalid-email') {
            msg = t('invalid_email_again');
        } else if (error.code === 'auth/weak-password') {
            msg = t('weak_password');
        }

        showToast(t('error_title'), msg, 'error');
    }
};
  // --- ENGELLEME (BasitÃ§e siliyoruz ama farklÄ± mesaj veriyoruz, istersen 'blocked' koleksiyonu yapabilirsin) ---
const handleBlockFriend = async (targetUid: string, targetName: string) => {
      askConfirmation(
          t('friend_block_title'),
          `${targetName} {t('block_user_confirm')}`,
          async () => {
                try {
                    // 1. ArkadaÅŸlÄ±ktan Ã§Ä±kar (Her iki taraftan)
                    await deleteDoc(doc(db, "users", user.uid, "contacts", targetUid));
                    await deleteDoc(doc(db, "users", targetUid, "contacts", user.uid));

                    // 2. Engellenenler listesine ekle (arrayUnion kullanÄ±yoruz)
                    await updateDoc(doc(db, "users", user.uid), {
                        blockedUsers: arrayUnion(targetUid)
                    });

                    showToast(t('friend_block_title'), `${targetName} ${t('friend_blocked_success')}`, 'success');
                } catch (e) {
                    // EÄŸer blockedUsers alanÄ± henÃ¼z yoksa hata verebilir, setDoc ile merge yapalÄ±m
                    try {
                        await setDoc(doc(db, "users", user.uid), { blockedUsers: [targetUid] }, { merge: true });
                        // Tekrar silmeyi dene
                        await deleteDoc(doc(db, "users", user.uid, "contacts", targetUid));
                        await deleteDoc(doc(db, "users", targetUid, "contacts", user.uid));
                        showToast(t('friend_block_title'), `${targetName} ${t('friend_blocked_success')}`, 'success');
                    } catch (err) {
                        showToast(t('error_title'), t('process_failed'), 'error');
                    }
                }
          },
          true // KÄ±rmÄ±zÄ± buton
      );
  };
  const formatChatTime = (timestamp: any) => {
      if (!timestamp) return "";
      const date = new Date(timestamp.seconds * 1000);
      const now = new Date();
      
      // BugÃ¼n ise sadece saat
      if (date.toDateString() === now.toDateString()) {
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      // DÃ¼n veya daha eski ise tarih
      return date.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
  };
  const sendMessage = async () => {
    // 1. Validasyonlar
    if (!chatInput.trim() || !chatTarget || !user) return;
    
    const chatId = [user.uid, chatTarget.uid].sort().join('_');
    const plainText = chatInput; 
    setChatInput(""); // Inputu hemen temizle

    // ---------------------------------------------------------
    // ADIM A: ANAHTARLARI BUL (Hem onun hem senin)
    // ---------------------------------------------------------

    // 1. KarÅŸÄ± TarafÄ±n Public Key'i
    let targetPublicKey = chatTarget.publicKey;
    if (!targetPublicKey) {
        // EÄŸer sohbet listesinden gelmiyorsa veritabanÄ±ndan Ã§ek
        const userDoc = await getDoc(doc(db, "public_users", chatTarget.uid));
        if (userDoc.exists()) {
            targetPublicKey = userDoc.data().publicKey;
        }
    }

    // 2. Benim Public Key'im (Kendi kopyamÄ± ÅŸifrelemek iÃ§in)
    let myPublicKey = user.publicKey;
    if (!myPublicKey) {
         // EÄŸer user state'inde yoksa veritabanÄ±ndan Ã§ek
         const myDoc = await getDoc(doc(db, "public_users", user.uid));
         if (myDoc.exists()) {
             myPublicKey = myDoc.data().publicKey;
         }
    }

    // ---------------------------------------------------------
    // ADIM B: Ã‡Ä°FT ÅžÄ°FRELEME YAP (Sender Copy Metodu)
    // ---------------------------------------------------------
    
    // VarsayÄ±lan olarak dÃ¼z metin (EÄŸer anahtar yoksa gÃ¼venlik aÃ§Ä±ÄŸÄ± olmasÄ±n diye ÅŸifresiz gider)
    let messageForReceiver = plainText; 
    let messageForMe = plainText;       

    // 1. AlÄ±cÄ± iÃ§in ÅŸifrele (text alanÄ±na gidecek)
    if (targetPublicKey) {
        const encrypted = await encryptMessage(plainText, targetPublicKey);
        if (encrypted) messageForReceiver = encrypted;
    }

    // 2. Kendim iÃ§in ÅŸifrele (senderCopy alanÄ±na gidecek)
    if (myPublicKey) {
        const encrypted = await encryptMessage(plainText, myPublicKey);
        if (encrypted) messageForMe = encrypted;
    }

    // ---------------------------------------------------------
    // ADIM C: VERÄ°TABANINA KAYDET
    // ---------------------------------------------------------
    await addDoc(collection(db, "chats", chatId, "messages"), {
        text: messageForReceiver,       // AlÄ±cÄ±nÄ±n Ã§Ã¶zeceÄŸi ÅŸifre
        senderCopy: messageForMe,       // Sizin Ã§Ã¶zeceÄŸiniz ÅŸifre
        senderId: user.uid,
        timestamp: serverTimestamp(),
        read: false 
    });

    // ---------------------------------------------------------
    // ADIM D: BÄ°LDÄ°RÄ°M GÃ–NDER (Opsiyonel)
    // ---------------------------------------------------------
    const targetPublicDoc = await getDoc(doc(db, "public_users", chatTarget.uid));
    if (targetPublicDoc.exists()) {
        const targetData = targetPublicDoc.data();
        if (targetData.pushToken) {
            // DÄ°KKAT: Bildirime ÅŸifreli metin gÃ¶ndermek yerine "Yeni Mesaj" yazmak
            // veya dÃ¼z metni (plainText) gÃ¶ndermek tercih meselesidir. 
            // GÃ¼venlik iÃ§in "Yeni bir mesajÄ±n var" yazdÄ±rÄ±yoruz.
            await sendPushNotification(
                targetData.pushToken,
                `ðŸ’¬ ${user.displayName || user.username}`,
                "ðŸ”’ Yeni ÅŸifreli mesaj", 
                { type: 'message', senderId: user.uid }
            );
        }
    }
};
  const handleDeleteChat = async () => {
   askConfirmation(
        t('delete_chat'),
        t('delete_chat_confirm'), 
         async () => {
            if (!user || !chatTarget) return;
            const chatId = [user.uid, chatTarget.uid].sort().join('_');
            try {
              // MesajlarÄ± tek tek sil (Firestore'da koleksiyonu tek seferde silemezsin)
              const q = query(collection(db, "chats", chatId, "messages"));
              const snapshot = await getDocs(q);
              const batchPromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
              await Promise.all(batchPromises);
              
              setActiveTab('messages'); // Mesajlar sekmesine dÃ¶n
              setChatTarget(null);
              showToast(t('success'), t('chat_deleted'), 'success');
            } catch (e) {
              showToast(t('warning_title'), t('chat_delete_failed'), 'error');
            }
          },
          true // KÄ±rmÄ±zÄ± buton (isDestructive)
    );
  };


// --- ÅžÄ°FRE DEÄžÄ°ÅžTÄ°RME FONKSÄ°YONU ---
  // --- ÅžÄ°FRE DEÄžÄ°ÅžTÄ°RME / OLUÅžTURMA FONKSÄ°YONU ---
  const handlePasswordChange = async () => {
      // 1. Validasyon
      if (!newPasswordInput.trim() || newPasswordInput.length < 6) {
          showToast(t('warning_title'), t('password_min_length'), 'warning');
          return;
      }

      if (!user) return;

      try {
          // 2. Firebase Åžifre GÃ¼ncelleme (Google hesabÄ± olsa bile bu fonksiyon ÅŸifre ekler)
          await updatePassword(user, newPasswordInput);
          
          showToast(t('success'), t('password_set_success'), 'success');
          setIsPasswordModalOpen(false);
          setNewPasswordInput("");

      } catch (error: any) {
          console.log(error);
          
          // Ã–nemli Hata YÃ¶netimi:
          if (error.code === 'auth/requires-recent-login') {
                askConfirmation(
                    t('security_warning_title') || t('security_warning_title'),
                    t('security_relogin_msg'),
                    handleLogout, // Onayla basÄ±nca Ã§Ä±kÄ±ÅŸ yapar
                    false 
                );
            } else {
              showToast(t('error_title'), t('process_failed') + error.message, 'error');
          }
      }
  };
     // Bu fonksiyonu mevcut handleAuth yerine yapÄ±ÅŸtÄ±rÄ±n
const handleAuth = async () => {
    // 1. Girdileri Temizle
    const inputVal = email.trim(); // Hem e-posta hem kullanÄ±cÄ± adÄ± olabilir
    const cleanPassword = password.trim();

    // --- LOGIN Ä°ÅžLEMÄ° ---
    if (authMode === 'login') {
        if (!inputVal || !cleanPassword) {
            showToast(t('warning_title'), t('fill_all_fields'), 'warning');
            return;
        }

        setIsAuthLoading(true);

        try {
            let emailToLogin = inputVal;

            // EÄžER GÄ°RÄ°LEN DEÄžER BÄ°R E-POSTA DEÄžÄ°LSE (Ä°Ã§inde @ yoksa), KULLANICI ADIDIR
            if (!inputVal.includes('@')) {
                // KullanÄ±cÄ± adÄ±nÄ± temizle (kÃ¼Ã§Ã¼k harf, boÅŸluksuz)
                const cleanUsername = inputVal.toLowerCase()
                    .replace(/\s+/g, '')
                    .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
                    .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c');

                // --- GÃœVENLÄ° YÃ–NTEM ---
                // Query yerine doÄŸrudan GET yapÄ±yoruz.
                // 'usernames' koleksiyonunda ID'si bu kullanÄ±cÄ± adÄ± olan belgeyi Ã§ek
                const usernameRef = doc(db, "usernames", cleanUsername);
                const docSnap = await getDoc(usernameRef);

                if (!docSnap.exists()) {
                    throw new Error("USER_NOT_FOUND"); // BÃ¶yle bir kullanÄ±cÄ± adÄ± yok
                }

                // E-postasÄ±nÄ± al
                emailToLogin = docSnap.data().email;
            }

            // Beni HatÄ±rla KontrolÃ¼
            if (rememberMe) {
                await AsyncStorage.setItem("ommio_remember_me", "true");
            } else {
                await AsyncStorage.setItem("ommio_remember_me", "false");
            }

            // Bulunan veya girilen E-posta ile giriÅŸ yap
            await signInWithEmailAndPassword(auth, emailToLogin, cleanPassword);
            
            // BaÅŸarÄ±lÄ± olursa useEffect'teki auth listener otomatik yÃ¶nlendirir, loading kapatmaya gerek yok.

        } catch (e: any) {
            setIsAuthLoading(false);
            console.error("Login Error:", e);
            
            let errorMsg = "GiriÅŸ baÅŸarÄ±sÄ±z.";
            if (e.message === "USER_NOT_FOUND") errorMsg = t('username_not_found');
            else if (e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password') errorMsg = "Åžifre veya kullanÄ±cÄ± bilgisi hatalÄ±.";
            else if (e.code === 'auth/user-not-found') errorMsg = "KullanÄ±cÄ± bulunamadÄ±.";
            else if (e.code === 'auth/too-many-requests') errorMsg = "Ã‡ok fazla deneme yaptÄ±nÄ±z, lÃ¼tfen bekleyin.";
            
            showToast(t('error_title'), errorMsg, 'error');
        }
    } 
    // --- KAYIT OLMA (SIGNUP) Ä°ÅžLEMÄ° ---
    else {
        // KayÄ±t olurken mutlaka gerÃ§ek bir e-posta zorunlu
        if (!username.trim()) {
            showToast(t('missing_info'), t('auth_username_required'), 'warning');
            return;
        }
        // Basit e-posta doÄŸrulama
        if (!inputVal.includes('@') || !inputVal.includes('.')) {
             showToast(t('missing_info'), t('enter_email_username'), 'warning');
             return;
        }
        if (!cleanPassword) {
            showToast(t('missing_info'), t('enter_password'), 'warning');
            return;
        }

        setIsAuthLoading(true);

        try {
            const cleanUsername = username.trim().toLowerCase()
                .replace(/\s+/g, '')
                .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
                .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c');

            // KullanÄ±cÄ± adÄ± daha Ã¶nce alÄ±nmÄ±ÅŸ mÄ± kontrol et
            const q = query(collection(db, "public_users"), where("username", "==", cleanUsername));
            const checkUser = await getDocs(q);
            if(!checkUser.empty) {
                setIsAuthLoading(false);
                showToast("Hata", t('profile_username_taken'), 'warning');
                return;
            }

            // KayÄ±t Ä°ÅŸlemi
            const cred = await createUserWithEmailAndPassword(auth, inputVal, cleanPassword);
            await updateProfile(cred.user, { displayName: username });

            const userData = {
                uid: cred.user.uid,
                username: cleanUsername,
                displayName: username,
                email: inputVal,
                createdAt: serverTimestamp(),
                hasSeenOnboarding: false,
                categories: [
                    { id: 'work', name: 'Ä°ÅŸ', color: 'blue' },
                    { id: 'home', name: 'Ev', color: 'orange' },
                    { id: 'personal', name: 'KiÅŸisel', color: 'green' }
                ]
            };

            await setDoc(doc(db, "users", cred.user.uid), userData);
            
            // Public users koleksiyonuna e-posta bilgisini de kaydediyoruz ki
            // ileride kullanÄ±cÄ± adÄ± ile giriÅŸ yaparken e-postayÄ± buradan bulalÄ±m.
            await setDoc(doc(db, "public_users", cred.user.uid), {
                uid: cred.user.uid,
                username: cleanUsername,
                originalUsername: username,
                // email: inputVal,  <-- BUNU KALDIRIN VEYA SÄ°LÄ°N (GÃ¼venlik Riski)
                photoURL: null
            });

            // --- YENÄ° EKLENECEK KISIM ---
            // E-posta adresini gÃ¼venli bir "lookup" (arama) koleksiyonuna kaydediyoruz.
            // Belge ID'si = kullanÄ±cÄ± adÄ±
            await setDoc(doc(db, "usernames", cleanUsername), {
                email: inputVal
            });
            
            setIsAuthLoading(false);

        } catch (e: any) {
            setIsAuthLoading(false);
            console.error("Signup Error:", e);
            let errorMsg = t('login_failed') || "GiriÅŸ baÅŸarÄ±sÄ±z.";

            // --- ÅžÄ°FRE HATASI KONTROLÃœ ---
            if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
                errorMsg = t('wrong_password_msg') || "GirdiÄŸiniz ÅŸifre hatalÄ±.";
            } 
            // --- KULLANICI BULUNAMADI ---
            else if (e.message === "USER_NOT_FOUND" || e.code === 'auth/user-not-found') {
                errorMsg = t('username_not_found') || "Bu kullanÄ±cÄ± adÄ± veya e-posta kayÄ±tlÄ± deÄŸil.";
            } 
            // --- Ã‡OK FAZLA DENEME ---
            else if (e.code === 'auth/too-many-requests') {
                errorMsg = t('too_many_requests') || "Ã‡ok fazla deneme yaptÄ±nÄ±z, lÃ¼tfen biraz bekleyin.";
            }
            // --- DÄ°ÄžER HATALAR ---
            else if (e.code === 'auth/invalid-email') {
                errorMsg = t('invalid_email') || "GeÃ§ersiz e-posta formatÄ±.";
            }

            // TOAST GÃ–STER
            showToast(t('error_title'), errorMsg, 'error');
        }
    }
};

  const handleLogout = async () => { await signOut(auth); setTasks([]); 
    if (Platform.OS === 'web') {
        setShowAuth(false);
    }
  };
  
const pickImage = async () => {
    try {
        console.log("Resim seÃ§me iÅŸlemi baÅŸladÄ±...");

        // 1. Ä°zin Ä°ste
        const permissionResult = await ImagePicker.requestMediaLibraryPermissionsAsync();
        if (permissionResult.granted === false) {
            showToast(t('permission_required'), t('profile_gallery_perm'), 'warning');
            return;
        }

        // 2. Resmi SeÃ§
        const result = await ImagePicker.launchImageLibraryAsync({
            mediaTypes: ImagePicker.MediaTypeOptions.Images,
            allowsEditing: true,
            aspect: [1, 1],
            quality: 1, // Buradaki kalite Ã¶nemli deÄŸil, aÅŸaÄŸÄ±da manipulator ile ayarlayacaÄŸÄ±z
        });

        if (!result.canceled && result.assets && result.assets.length > 0) {
            const asset = result.assets[0];
            
            console.log("Resim seÃ§ildi, yeniden boyutlandÄ±rÄ±lÄ±yor...");

            // --- 3. RESMÄ° KÃœÃ‡ÃœLTME (RESIZE) Ä°ÅžLEMÄ° ---
            // GeniÅŸliÄŸi 500px yapÄ±yoruz, yÃ¼kseklik otomatik ayarlanÄ±yor.
            // Bu iÅŸlem boyutu 50KB - 150KB arasÄ±na dÃ¼ÅŸÃ¼rÃ¼r.
            const manipResult = await ImageManipulator.manipulateAsync(
                asset.uri,
                [{ resize: { width: 500 } }], // GeniÅŸliÄŸi 500px'e sabitle
                { 
                    compress: 0.7, // Kalite %70 (Gayet yeterli)
                    format: ImageManipulator.SaveFormat.JPEG, 
                    base64: true // Base64 verisini istiyoruz
                }
            );

            const finalBase64 = `data:image/jpeg;base64,${manipResult.base64}`;

            // Boyut KontrolÃ¼ (ArtÄ±k buraya takÄ±lmasÄ± imkansÄ±za yakÄ±n)
            if (finalBase64.length > 1048487) {
                showToast(t('file_too_large'), t('image_size_limit'), 'error');
                return;
            }

            // 4. Kaydetme Ä°ÅŸlemleri
          

            await setDoc(doc(db, "users", user.uid), { photoURL: finalBase64 }, { merge: true });
            
            try {
                await setDoc(doc(db, "public_users", user.uid), { photoURL: finalBase64 }, { merge: true });
            } catch (e) {}

            setUser({ ...user, photoURL: finalBase64 });
            
            showToast(t('premium_congrats'), t('profile_photo_updated'), 'success');
        }
    } catch (e: any) {
        showToast(t('error'), "t('image_upload_failed')" + e.message, 'error');
    }
  };
  // --- PROFÄ°L GÃœNCELLEME FONKSÄ°YONU ---
const handleUpdateProfile = async () => {
    // 1. Girdileri Temizle
    const cleanDisplayName = editDisplayNameInput.trim();
    
    // Username deÄŸiÅŸtiyse temizle, deÄŸiÅŸmediyse eskisini tut
    const cleanUsername = editUsernameInput.trim().toLowerCase()
        .replace(/\s+/g, '')
        .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
        .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c');

    // 2. Validasyon (Kontrol)
    if (!cleanDisplayName) {
        showToast(t('warning_title'), t('display_name_required'), 'warning');
        return;
    }

    if (cleanUsername.length < 3) {
        showToast(t('warning_title'), t('profile_username_short'), 'warning');
        return;
    }

    // DeÄŸiÅŸiklik var mÄ± kontrolÃ¼? (Gereksiz yere veritabanÄ±nÄ± yormayalÄ±m)
    const isNameChanged = cleanDisplayName !== user.displayName;
    const isUsernameChanged = cleanUsername !== user.username;

    if (!isNameChanged && !isUsernameChanged) {
        setIsEditProfileVisible(false); // DeÄŸiÅŸiklik yoksa kapat
        return;
    }

    try {
        // --- SENARYO A: Sadece GÃ¶rÃ¼nen Ä°sim DeÄŸiÅŸiyor (En kolayÄ±) ---
        if (isNameChanged && !isUsernameChanged) {
             // 1. Firebase Auth Profilini GÃ¼ncelle
             if (auth.currentUser) {
                await updateProfile(auth.currentUser, { displayName: cleanDisplayName });
            }

            // 2. VeritabanlarÄ±nÄ± GÃ¼ncelle
            await updateDoc(doc(db, "users", user.uid), { displayName: cleanDisplayName });
            await updateDoc(doc(db, "public_users", user.uid), { displayName: cleanDisplayName });

            // 3. State'i GÃ¼ncelle (AnlÄ±k deÄŸiÅŸim iÃ§in)
            setUser((prev: any) => ({ ...prev, displayName: cleanDisplayName }));
            showToast(t('success_label'), "Ä°sminiz gÃ¼ncellendi.", 'success');
        }

        // --- SENARYO B: KullanÄ±cÄ± AdÄ± DeÄŸiÅŸiyor (Zor olan) ---
        else if (isUsernameChanged) {
            // BaÅŸkasÄ± almÄ±ÅŸ mÄ± kontrol et
            const q = query(collection(db, "public_users"), where("username", "==", cleanUsername));
            const check = await getDocs(q);
            
            if (!check.empty) {
                showToast("Hata", t('profile_username_taken'), 'error');
                return;
            }

            // MÃ¼saitse gÃ¼ncelle (Hem isim hem username)
            const updates = { username: cleanUsername, displayName: cleanDisplayName };
            
            if (auth.currentUser) await updateProfile(auth.currentUser, { displayName: cleanDisplayName });
            
            await updateDoc(doc(db, "users", user.uid), updates);
            // Public tablosunda eski username ile olan kaydÄ± silip yenisini yaratmak daha gÃ¼venlidir ama update de Ã§alÄ±ÅŸÄ±r
            // Biz burada merge ile update yapÄ±yoruz
            await setDoc(doc(db, "public_users", user.uid), updates, { merge: true });

            // State GÃ¼ncelle
            setUser((prev: any) => ({ ...prev, ...updates }));
            showToast(t('success_label'), "Profiliniz tamamen gÃ¼ncellendi.", 'success');
        }

        setIsEditProfileVisible(false); // ModalÄ± kapat

    } catch (e: any) {
        console.error(e);
        showToast(t('error_title'), t('update_failed_generic'), 'error');
    }
};

  const scheduleLocalNotification = async (title: string, body: string, timeString: string, type: 'notification' | 'alarm') => {
    if (Platform.OS === 'web') return null;
    
    try {
        const [hours, minutes] = timeString.split(':').map(Number);
        const triggerDate = new Date(selectedDate);
        triggerDate.setHours(hours, minutes, 0, 0);

        // Tarih geÃ§miÅŸteyse yarÄ±na kur (Ã–rn: Saat 14:00, kullanÄ±cÄ± 09:00'a alarm kurdu -> YarÄ±n 09:00)
        if (triggerDate <= new Date()) {
            triggerDate.setDate(triggerDate.getDate() + 1);
        }

        const id = await Notifications.scheduleNotificationAsync({
            content: {
                title: title,
                body: body,
                sound: true, // iOS iÃ§in standart ses
                // Android iÃ§in Ã¶zel kanal (YÃ¼ksek Ã¶ncelikli)
                color: type === 'alarm' ? COLORS.danger : COLORS.primary,
                priority: Notifications.AndroidNotificationPriority.MAX,
                data: { type: type },
                // EÄŸer alarm ise Android'de Ã¶zel kanal kullan
                ...(Platform.OS === 'android' && type === 'alarm' ? { channelId: 'alarm' } : {}), 
            },
            trigger: { 
               type: Notifications.SchedulableTriggerInputTypes.DATE, // Bu satÄ±r EKLENDÄ°
               date: triggerDate 
            },
        });
        return id;
    } catch (e) {
        console.log("Bildirim hatasÄ±:", e);
        return null;
    }
};

const addTask = async () => {
    if (!inputValue.trim()) {
        showToast(t('warning_title'), t('missing_info'), 'warning');
        return;
    }
    if (!user) {
        showToast(t('error_title'), "Oturum hatasÄ±.", 'error');
        return;
    }

    setIsAuthLoading(true);

    try {
        let finalStartDate = inputStartDate;
        if (!finalStartDate || finalStartDate.length < 10) {
            finalStartDate = formatDateDDMMYYYY(selectedDate);
        }
        const formattedStart = convertDDMMYYYYtoISO(finalStartDate);
        let finalCategoryId = selectedCategory.id;

        // --- ATAMA MANTIÄžI ---
        if (assignTarget) {
            if (checkGuest("GÃ¶rev Atama")) return;

            const targetUserDoc = await getDoc(doc(db, "users", assignTarget.uid));
            if (!targetUserDoc.exists()) throw new Error("KullanÄ±cÄ± bulunamadÄ±.");
            
            const targetContactRef = doc(db, "users", assignTarget.uid, "contacts", user.uid);
            const targetContactDoc = await getDoc(targetContactRef);

            if (!targetContactDoc.exists() || targetContactDoc.data().canAssignToMe === false) {
                showToast(t('assignment_failed_title'), `${assignTarget.username} ${t('assign_permission_denied_msg')}`, 'error');
                setIsAuthLoading(false);
                return;
            }

            const targetSettings = targetContactDoc.data();
            if (targetSettings.defaultCategoryId) {
                finalCategoryId = targetSettings.defaultCategoryId;
            }
        }

        // --- BÄ°LDÄ°RÄ°M & ALARM ---
        let notifId = null, alarmId = null;
        if (!assignTarget) {
            if (isNotifOn && notifInput.length === 5) {
                notifId = await scheduleLocalNotification(t('notification'), inputValue, notifInput, 'notification');
            }
            if (isAlarmOn && alarmInput.length === 5) {
                alarmId = await scheduleLocalNotification(t('alarm'), inputValue, alarmInput, t('alarm'));
            }
        }

        // --- GÃ–REV OBJESÄ° ---
        const newTask = {
            text: inputValue,
            description: inputDesc,
            completed: false,
            date: formattedStart,
            dueDate: inputDueDate.length >= 10 ? inputDueDate : null,
            showEveryDayUntilDue: isEveryDayOn,
            categoryId: finalCategoryId,
            notificationTime: isNotifOn ? notifInput : null,
            alarmTime: isAlarmOn ? alarmInput : null,
            notificationId: notifId,
            alarmId: alarmId,
            createdAt: serverTimestamp(),
            assignedBy: user.uid,
            assignedByName: user.displayName || user.username || "KullanÄ±cÄ±",
            assignedTo: assignTarget ? assignTarget.uid : user.uid
        };

        // --- KAYIT Ä°ÅžLEMÄ° (DÃœZELTÄ°LDÄ°) ---
        if (assignTarget) {
            // 1. KarÅŸÄ± tarafa kaydet
            await addDoc(collection(db, "users", assignTarget.uid, "tasks"), newTask);
            
            // 2. Bildirim GÃ¶nder
            const targetPublicDoc = await getDoc(doc(db, "public_users", assignTarget.uid));
            if (targetPublicDoc.exists()) {
                const targetData = targetPublicDoc.data();
                if (targetData.pushToken) {
                    await sendPushNotification(
                        targetData.pushToken,
                        t('new_task_assigned'),
                        `${user.displayName || user.username} ${t('assigned_task_msg')}: ${inputValue}`,
                        { type: 'task', taskId: newTask.assignedBy }
                    );
                }
            }
            showToast(t('task_assigned_title'), `${t('task_assigned_msg')} ${assignTarget.username}`, 'success');
            checkAdTrigger('assigned');
        } else {
            // Kendime kaydet
            await addDoc(collection(db, "users", user.uid, "tasks"), newTask);
        }

        // --- TEMÄ°ZLÄ°K ---
        setIsAddModalOpen(false);
        setInputValue("");
        setInputDesc("");
        setNotifInput("");
        setAlarmInput("");
        setIsNotifOn(false);
        setIsAlarmOn(false);
        setIsEveryDayOn(false);
        setAssignTarget(null);
        setIsInputExpanded(false);
        Keyboard.dismiss();

    } catch (error: any) {
        console.error("HATA:", error);
        showToast(t('error_title'), error.message, 'error');
    } finally {
        setIsAuthLoading(false);
    }
};
 const addHabit = async () => {
      // 1. GÄ°RÄ°Åž KONTROLÃœ
      if (!user) {
          showToast(t('error_title'), t('session_not_open'), 'error');
          return;
      }

      // 2. BOÅž KONTROLÃœ
      if (!newHabitTitle.trim()) {
          showToast(t('warning_title'), t('missing_info'), 'warning');
          return;
      }

      try {
          const endDateISO = newHabitEndDate ? convertDDMMYYYYtoISO(newHabitEndDate) : null;
          let notificationIds: string[] = [];
          
          // Bildirim Kurma
          if (habitNotifInput.length === 5 && Platform.OS !== 'web') {
              const [hours, minutes] = habitNotifInput.split(':').map(Number);
              try {
                  if (newHabitFreq === 'daily') {
                      // @ts-ignore
                      const id = await Notifications.scheduleNotificationAsync({ 
                          content: { title: t('habits'), body: newHabitTitle, sound: true }, 
                          trigger: { hour: hours, minute: minutes, repeats: true, type: Notifications.SchedulableTriggerInputTypes.CALENDAR } 
                      });
                      notificationIds.push(id);
                  } else if (newHabitFreq === 'weekly') {
                      for (const dayIndex of newHabitDays) {
                          const expoWeekday = dayIndex + 1; 
                          // @ts-ignore
                          const id = await Notifications.scheduleNotificationAsync({ 
                              content: { title: t('habits'), body: newHabitTitle, sound: true }, 
                              trigger: { weekday: expoWeekday, hour: hours, minute: minutes, repeats: true, type: Notifications.SchedulableTriggerInputTypes.CALENDAR } 
                          });
                          notificationIds.push(id);
                      }
                  }
              } catch(e) { console.log("Bildirim hatasÄ±:", e); }
          }

          // 3. KAYIT
          await addDoc(collection(db, "users", user.uid, "habits"), { 
              title: newHabitTitle, 
              frequency: newHabitFreq, 
              selectedDays: newHabitDays, 
              endDate: endDateISO, 
              completedDates: [], 
              notificationTime: habitNotifInput, 
              notificationIds: notificationIds, 
              categoryId: selectedCategory.id, 
              createdAt: serverTimestamp() 
          });

          // 4. TEMÄ°ZLÄ°K
          showToast(t('success'), t('all_good'), 'success');
          setIsAddModalOpen(false);
          setNewHabitTitle(""); 
          setNewHabitFreq('daily'); 
          setNewHabitDays([]); 
          setNewHabitEndDate(""); 
          setHabitNotifInput("");

      } catch (error: any) {
          console.error("ADD HABIT ERROR:", error);
          showToast(t('error_title'), error.message, 'error');
      }
  };

    const toggleTask = async (task: Task) => { 
            if(user) {
                // EÄŸer gÃ¶rev tamamlanÄ±yorsa (false -> true oluyorsa) sayacÄ± artÄ±r
                if (!task.completed) {
                    checkAdTrigger('tasks'); 
                }
                await updateDoc(doc(db, "users", user.uid, "tasks", task.id), { completed: !task.completed }); 
            }};  
  
  const deleteTask = async (task: Task) => { if (user) { await deleteDoc(doc(db, "users", user.uid, "tasks", task.id)); } };
  
  const toggleHabitCompletion = async (habit: Habit, date: string) => {
      const ref = doc(db, "users", user.uid, "habits", habit.id);
      
      // EÄŸer bu tarih daha Ã¶nce iÅŸaretlenmemiÅŸse (yani yeni tamamlanÄ±yorsa)
      if (!habit.completedDates.includes(date)) {
           checkAdTrigger('habits');
      }

      if (habit.completedDates.includes(date)) await updateDoc(ref, { completedDates: arrayRemove(date) });
      else await updateDoc(ref, { completedDates: arrayUnion(date) });
  };
  
  const deleteHabit = async (habit: Habit) => { 
      if (habit.notificationIds) {
          for(const id of habit.notificationIds) { if (Platform.OS !== 'web') await Notifications.cancelScheduledNotificationAsync(id); }
      }
      if (user) await deleteDoc(doc(db, "users", user.uid, "habits", habit.id)); 
  };

  const toggleExpand = (taskId: string) => { LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut); setExpandedTaskId(expandedTaskId === taskId ? null : taskId); };
  const openEditModal = (task: Task) => { if (task.assignedBy !== user.uid && task.assignedTo !== user.uid) { showToast(t('error_title'), t('task_unauth_edit'), 'error'); return; } setSelectedTask(task); setDetailText(task.text); setDetailDesc(task.description || ""); setDetailDueDate(task.dueDate || ""); };
  const saveTaskDetail = async () => { if (!selectedTask) return; try { const targetUid = selectedTask.assignedTo || user.uid; const taskRef = doc(db, "users", targetUid, "tasks", selectedTask.id); await updateDoc(taskRef, { text: detailText, description: detailDesc, dueDate: detailDueDate }); setSelectedTask(null); showToast(t('success'), t('task_updated'), 'success'); } catch (e) { showToast(t('error_title'), t('update_failed_generic'), 'error'); } };
  
  const onDateChange = (event: any, selected: Date | undefined) => { 
      // Sadece Android'de seÃ§im yapÄ±nca otomatik kapat (Web ve iOS'ta butonla kapatacaÄŸÄ±z)
      if (Platform.OS === 'android') {
          setShowDatePicker(false); 
      }
      
      if (selected) { 
          const formatted = formatDateDDMMYYYY(selected);
          // Hangi input iÃ§in aÃ§Ä±ldÄ±ysa onu gÃ¼ncelle
          if (datePickerTarget === 'start') setInputStartDate(formatted);
          if (datePickerTarget === 'due') setInputDueDate(formatted);
          if (datePickerTarget === 'habitEnd') setNewHabitEndDate(formatted);
          if (datePickerTarget === 'detail') setDetailDueDate(formatted);
      } 
  };
  
  const onDetailDateChange = (event: any, selected: Date | undefined) => { 
      setShowDetailDatePicker(false); 
      if (selected) setDetailDueDate(formatDateDDMMYYYY(selected));
  };
  const onHabitDateChange = (event: any, selected: Date | undefined) => {
      setShowHabitDatePicker(false);
      if (selected) setNewHabitEndDate(formatDateDDMMYYYY(selected));
  };

  const openDatePicker = (target: 'start' | 'due' | 'habitEnd' | 'detail') => {
      setDatePickerTarget(target);
      setShowDatePicker(true);
  };

  const handleInputStartDateChange = (text: string) => { setInputStartDate(maskDateInput(text)); };
  const handleInputDueDateChange = (text: string) => { setInputDueDate(maskDateInput(text)); };
  const handleDetailDueDateChange = (text: string) => { setDetailDueDate(maskDateInput(text)); };
  const handleHabitEndDateChange = (text: string) => setNewHabitEndDate(maskDateInput(text));
  const handleNotifInputChange = (text: string) => { setNotifInput(maskTimeInput(text)); };
  const handleAlarmInputChange = (text: string) => { setAlarmInput(maskTimeInput(text)); };
  const handleHabitNotifInputChange = (text: string) => { setHabitNotifInput(maskTimeInput(text)); };
  const changeDate = (days: number) => { const newDate = new Date(selectedDate); newDate.setDate(selectedDate.getDate() + days); setSelectedDate(newDate); };
  const toggleHabitDay = (dayId: number) => { if (newHabitDays.includes(dayId)) setNewHabitDays(newHabitDays.filter(d => d !== dayId)); else setNewHabitDays([...newHabitDays, dayId]); };
  // ... mevcut fonksiyonlarÄ±n arasÄ±na ekleyin

  const handleAddCategory = async () => {
    if (!newCategoryName.trim()) return;
    const newId = Math.random().toString(36).substr(2, 9);
    
    const newCategory = { id: newId, name: newCategoryName, color: newCategoryColor };
    const updatedCategories = [...categories, newCategory];
    
    setCategories(updatedCategories);
    setNewCategoryName("");
    
    // FIREBASE KAYDI (Ã–NEMLÄ°)
    if (user) {
        try {
            // 'users' koleksiyonunda kullanÄ±cÄ±nÄ±n dÃ¶kÃ¼manÄ±na 'categories' alanÄ±nÄ± gÃ¼ncelliyoruz
            await setDoc(doc(db, "users", user.uid), { categories: updatedCategories }, { merge: true });
        } catch (e) {
            console.log("Kategori kaydedilemedi", e);
        }
    }
};

// Kategori silerken de updateDoc yapmalÄ±sÄ±nÄ±z:
const handleDeleteCategory = async (catId: string) => {
    if (categories.length <= 1) {
    showToast(t('warning_label'), t('at_least_one_category'), 'warning');
    return;
}
    const updatedCategories = categories.filter(c => c.id !== catId);
    setCategories(updatedCategories);
    
    if (user) {
         await updateDoc(doc(db, "users", user.uid), { categories: updatedCategories });
    }
};

  const sendFriendRequest = async () => {
    // 1. BoÅŸ kontrolÃ¼
    if (!searchUsername.trim()) {
        showToast(t('warning_title'), t('auth_username_required'), 'warning');
        return;
    }

    // KÃ¼Ã§Ã¼k harfe Ã§evir ve boÅŸluklarÄ± sil (Instagram mantÄ±ÄŸÄ±: username her zaman kÃ¼Ã§Ã¼k harftir)
    const targetUsername = searchUsername.trim().toLowerCase().replace(/\s/g, '');

    try {
        // 2. KullanÄ±cÄ±yÄ± "public_users" iÃ§inde unique username ile ara
        const q = query(collection(db, "public_users"), where("username", "==", targetUsername));
        const querySnapshot = await getDocs(q);

        // A. KULLANICI BULUNAMADI
        if (querySnapshot.empty) { 
            showToast(t('error_title'), tFormat('user_not_found', { targetUsername }), 'error'); 
            return; 
        }

        // Hedef kullanÄ±cÄ±nÄ±n verisini al
        const targetUser = querySnapshot.docs[0].data();
        const targetUid = targetUser.uid;
        // GÃ¶rÃ¼nen ismi al (Yoksa username kullan)
        const targetDisplayName = targetUser.displayName || targetUser.username;

        // B. KENDÄ°NE Ä°STEK ATMA
        if (targetUid === user.uid) { 
            showToast(t('warning_title'), t('self_add_error'), 'warning'); 
            return; 
        }

        // C. ZATEN ARKADAÅž MI?
        const contactRef = doc(db, "users", user.uid, "contacts", targetUid);
        const contactSnap = await getDoc(contactRef);
        if (contactSnap.exists()) { 
            showToast(t('info_title'), tFormat('already_friend', { targetDisplayName }) , 'info'); 
            setSearchUsername(""); 
            return; 
        }

        // 3. Ä°steÄŸi GÃ¶nder
        const requestRef = doc(db, "users", targetUid, "friend_requests", user.uid);
        
        await setDoc(requestRef, { 
            id: user.uid,
            fromUid: user.uid, 
            // GÃ¶nderen olarak BÄ°ZÄ°M username ve display name'imizi ekliyoruz
            fromUsername: user.username, 
            fromDisplayName: user.displayName || user.username, // <-- YENÄ°: Display name de gidiyor
            fromEmail: user.email, 
            status: 'pending', 
            createdAt: serverTimestamp() 
        });
        if (targetUser.pushToken) {
            await sendPushNotification(
                targetUser.pushToken,
                t('friend_req_title') || "ArkadaÅŸlÄ±k Ä°steÄŸi",
                `${user.displayName || user.username} ${t('sent_friend_req_msg') || t('sent_you_request')}`,
                { type: 'friend_request' }
            );
        }
        
        // D. BAÅžARILI (KullanÄ±cÄ±ya Display Name ile geri bildirim veriyoruz)
        setSearchUsername(""); 
        showToast(t('social_request_sent'),  tFormat('request_sent', { 
    targetDisplayName, 
    targetUsername  }), 'success');

    } catch (e: any) { 
        console.error("Ä°stek gÃ¶nderme hatasÄ±:", e);
        showToast(t('error_title'), t('request_failed'), 'error');
    }
};

  const acceptRequest = async (req: FriendRequest) => {
    if (!user) return;
    
    try {
        // 1. Ä°steÄŸi gÃ¶nderen kiÅŸinin GÃœNCEL verisini al
        const senderDoc = await getDoc(doc(db, "public_users", req.fromUid));
        
        // EÄŸer veri yoksa istekteki eski verileri kullan (Fallback)
        // req nesnesine any diyerek tip hatasÄ±nÄ± geÃ§ici Ã§Ã¶zÃ¼yoruz Ã§Ã¼nkÃ¼ friendRequest interface'ini gÃ¼ncellemedik
        const reqData = req as any; 
        
        const senderData = senderDoc.exists() ? senderDoc.data() : { 
            username: reqData.fromUsername, 
            displayName: reqData.fromDisplayName || reqData.fromUsername,
            photoURL: null 
        };
        
        // 2. Kaydedilecek Veriler
        const senderUsername = senderData.username;
        const senderDisplayName = senderData.displayName || senderUsername; // Ã–ncelik Display Name
        const senderPhoto = senderData.photoURL || null;

        const myUsername = user.username; 
        const myDisplayName = user.displayName || user.username;
        const myPhoto = user.photoURL;

        // 3. Ã‡ift TaraflÄ± KayÄ±t
        await Promise.all([
            // A. Benim listeme ekle (Display Name Ã¶ncelikli kaydediyoruz)
            setDoc(doc(db, "users", user.uid, "contacts", req.fromUid), { 
                uid: req.fromUid, 
                username: senderUsername,      // Arama ve @ etiketi iÃ§in
                displayName: senderDisplayName, // Listede gÃ¶stermek iÃ§in
                email: reqData.fromEmail || "", 
                photoURL: senderPhoto, 
                canAssignToMe: true,
                createdAt: serverTimestamp()
            }),

            // B. KarÅŸÄ± tarafa beni ekle
            setDoc(doc(db, "users", req.fromUid, "contacts", user.uid), { 
                uid: user.uid, 
                username: myUsername, 
                displayName: myDisplayName,
                email: user.email, 
                photoURL: myPhoto, 
                canAssignToMe: false,
                createdAt: serverTimestamp()
            }),

            // C. Ä°steÄŸi sil
            deleteDoc(doc(db, "users", user.uid, "friend_requests", req.id || req.fromUid))
        ]);
        
        showToast(t('success_label'),
  tFormat('success_friend', { senderDisplayName }), 'success');
        
    } catch (e: any) { 
        console.error("Kabul hatasÄ±:", e);
        showToast(t('error_title'), t('connection_failed'), 'error'); 
    }
};
  const showTasksAssignedToFriend = async (friendUid: string, friendName: string) => {
    if (!user) return;
    try {
        // ArkadaÅŸÄ±n "tasks" koleksiyonunda, "assignedBy" benim ID'm olanlarÄ± Ã§ek
        const q = query(
            collection(db, "users", friendUid, "tasks"), 
            where("assignedBy", "==", user.uid)
        );
        
        const snapshot = await getDocs(q);
        const sentTasks = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        
        setFriendTasksModal({ visible: true, tasks: sentTasks, friendName });
    } catch (e) {
        showToast(t('error_title'), t('tasks_fetch_error'), 'error');
    }
  };
  const rejectRequest = async (reqId: string) => { try { await deleteDoc(doc(db, "users", user.uid, "friend_requests", reqId)); } catch (e) { } };
  const togglePermission = async (contact: Contact) => { await updateDoc(doc(db, "users", user.uid, "contacts", contact.uid), { canAssignToMe: !contact.canAssignToMe }); };
  const setContactCategory = async (contact: Contact, categoryId: string) => { await updateDoc(doc(db, "users", user.uid, "contacts", contact.uid), { defaultCategoryId: categoryId }); };
  const fetchDeviceContacts = async () => {
      const { status } = await Contacts.requestPermissionsAsync();
      if (status === 'granted') {
          const { data } = await Contacts.getContactsAsync({ fields: [Contacts.Fields.PhoneNumbers, Contacts.Fields.Name] });
          if (data.length > 0) {
              const formattedContacts: DeviceContact[] = [];
              for (const contact of data) {
                  if (contact.phoneNumbers && contact.phoneNumbers.length > 0) {
                      let number = contact.phoneNumbers[0].number || "";
                      number = number.replace(/\s/g, '').replace(/-/g, '').replace(/\(/g, '').replace(/\)/g, '');
                      formattedContacts.push({ id: contact.id || Math.random().toString(), name: contact.name || t('no_name'), phoneNumber: number, isAppUser: false });
                  }
              }
              setDeviceContacts(formattedContacts);
          }
        } else { showToast(t('permission_required'), t('contacts_permission'), 'warning'); }  };
  
  const inviteContact = async (phoneNumber: string) => {
      const isAvailable = await SMS.isAvailableAsync();
      if (isAvailable) { await SMS.sendSMSAsync([phoneNumber], t('social_invite_sms')); } else { showToast(t('error_title'), t('sms_error'), 'error'); }
  };
const handleDeleteAccount = async () => {
    // Silme MantÄ±ÄŸÄ±
    const performDelete = async () => {
        try {
            if (!user) return;
            await deleteDoc(doc(db, "users", user.uid));
            try { await deleteDoc(doc(db, "public_users", user.uid)); } catch (e) {}
            await user.delete();
            setTasks([]);
            
            // BaÅŸarÄ±lÄ± MesajÄ±
            showToast( t('delete_account_success_title'), t('delete_account_success_msg'), 'success');

        } catch (error: any) {
            console.log("Silme hatasÄ±:", error);
            // Hata MesajÄ±
            showToast( t('error_title'), t('account_delete_error'), 'error');
        }
    };

    // Onay Kutusu
    askConfirmation(
        t('delete_account'), // "HesabÄ± Sil"
        t('account_delete_confirm'), // "Emin misin?..."
        performDelete,
        true // KÄ±rmÄ±zÄ± buton
    );
};

  // --- UI HELPERS ---
  const isSystemDark = systemScheme === 'dark';
  // --- YENÄ° BÄ°LDÄ°RÄ°M FONKSÄ°YONU ---
  // type kÄ±smÄ±na 'warning' ekledik
const showToast = (title: string, message: string, type: 'success' | 'error' | 'info' | 'warning' = 'success') => {
    setCustomToast({ visible: true, title, message, type });
    setTimeout(() => setCustomToast(prev => ({ ...prev, visible: false })), 4000);
};

  // --- YENÄ° ONAY KUTUSU FONKSÄ°YONU ---
  const askConfirmation = (title: string, message: string, onConfirm: () => void, isDestructive = false) => {
      setConfirmModal({
          visible: true,
          title,
          message,
          onConfirm,
          isDestructive
      });
  };
  // --- CHAT ODASI RENDER FONKSÄ°YONU ---
  const renderChatRoom = () => {
    return (
      <View style={{ flex: 1, backgroundColor: currentColors.bg }}> 
        
        {/* --- CHAT HEADER (LOGO YOK, GERÄ° BUTONU ve SÄ°LME BUTONU VAR) --- */}
        <View style={{
            flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between',
            paddingTop: Platform.OS === 'ios' ? 0 : 10, paddingBottom: 10, paddingHorizontal: 15,
            backgroundColor: currentColors.surface, borderBottomWidth: 1, borderColor: isDark ? '#334155' : '#f1f5f9',
            height: 60, zIndex: 10
        }}>
            <View style={{flexDirection:'row', alignItems:'center'}}>
                <TouchableOpacity 
                    onPress={() => {
                        setChatTarget(null);       // 1. Hedef kiÅŸiyi boÅŸalt (Sohbeti kapat)
                        setActiveTab('messages');  // 2. Sekmeyi Mesajlar yap
                        setChatMessages([]);       // 3. Mesaj listesini temizle (Eski mesajlar gÃ¶zÃ¼kmesin)
                    }} 
                    style={{ marginRight: 10 }}
                >
                    <ChevronLeft size={28} color={COLORS.primary} />
                </TouchableOpacity>

                <View style={{ width: 36, height: 36, borderRadius: 18, backgroundColor: COLORS.secondary, alignItems: 'center', justifyContent: 'center', marginRight: 10, overflow:'hidden' }}>
                    {chatTarget?.photoURL ? (
                        <Image source={{ uri: chatTarget.photoURL }} style={{ width: 36, height: 36 }} />
                    ) : (
                        <Text style={{ color: '#fff', fontWeight: 'bold' }}>{chatTarget?.username?.[0]?.toUpperCase()}</Text>
                    )}
                </View>

              <View>
              {/* Ãœstte BÃ¼yÃ¼k Display Name */}
                <Text style={{ fontSize: 16, fontWeight: 'bold', color: currentColors.text }}>
                    {chatTarget?.displayName || chatTarget?.username}
                </Text>
                
                {/* Altta KÃ¼Ã§Ã¼k @username */}
                <Text style={{ fontSize: 11, color: currentColors.subText }}>
                    @{chatTarget?.username}
                </Text>

                {isTyping && <Text style={{ fontSize: 10, color: COLORS.primary }}>{t('typing')}</Text>}
            </View>
            </View>

            {/* SÄ°LME BUTONU */}
            <TouchableOpacity onPress={handleDeleteChat} style={{padding: 5}}>
                <Trash2 size={20} color={COLORS.danger} />
            </TouchableOpacity>
        </View>

        {/* --- MESAJ LÄ°STESÄ° --- */}
        <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === 'ios' ? 'padding' : undefined}>
            <FlatList
                data={chatMessages}
                keyExtractor={(item) => item.id}
                inverted={true} 
                contentContainerStyle={{ paddingHorizontal: 15, paddingVertical: 20 }}
                showsVerticalScrollIndicator={false}
                onEndReached={() => setMsgLimit((prev) => prev + 25)}
                // BURASI Ã‡OK Ã–NEMLÄ°: Sadece MessageItem Ã§aÄŸrÄ±lmalÄ±, baÅŸka kod olmamalÄ±.
                renderItem={({ item: msg }) => (
                    <MessageItem 
                        msg={msg} 
                        user={user} 
                        chatTarget={chatTarget}
                        currentColors={currentColors}
                        isDark={isDark}
                    />
                )}
            />
                

            {/* --- DAHA KOMPAKT INPUT ALANI --- */}
            <View style={{ padding: 10, backgroundColor: currentColors.surface, borderTopWidth: 1, borderColor: isDark ? '#334155' : '#f1f5f9', paddingBottom: Platform.OS === 'ios' ? 30 : 10 }}>
                <View style={{ 
                    flexDirection: 'row', 
                    alignItems: 'center', // Ortala
                    backgroundColor: isDark ? COLORS.darkBg : '#f1f5f9', 
                    borderRadius: 24, // Tam yuvarlak kÃ¶ÅŸeler (Pill shape)
                    paddingHorizontal: 15, 
                    borderWidth: 1, 
                    borderColor: isDark ? '#475569' : '#e2e8f0', 
                    minHeight: 40, // Minimum yÃ¼kseklik (tek satÄ±r iÃ§in ideal)
                    maxHeight: 100 // Ã‡ok yazÄ±nca uzasÄ±n ama ekranÄ± kaplamasÄ±n
                }}>
                   <TextInput
                    value={chatInput}
                    onChangeText={setChatInput}
                    placeholder="Mesaj..."
                    placeholderTextColor={currentColors.subText}
                    multiline={true} 
                    blurOnSubmit={false} 
                    onSubmitEditing={sendMessage} // Mobilde klavyeden gÃ¶nder tuÅŸu
                    onKeyPress={(e) => {
                        // HATA Ã‡Ã–ZÃœMÃœ: (e as any) kullanarak TypeScript'i susturuyoruz.
                        // Web'de Shift+Enter yeni satÄ±r, Sadece Enter mesaj gÃ¶nderir.
                        if (e.nativeEvent.key === 'Enter' && !(e as any).nativeEvent.shiftKey) {
                            // Sadece Web'de preventDefault Ã§alÄ±ÅŸÄ±r, mobilde hata vermemesi iÃ§in kontrol
                            if (Platform.OS === 'web') {
                                e.preventDefault();
                            }
                            sendMessage();
                        }
                    }}
                    style={{ 
                        flex: 1, 
                        color: currentColors.text, 
                        fontSize: 15,
                        paddingVertical: 8,
                        paddingTop: 8,
                        paddingBottom: 8
                    }}
                />
                    <TouchableOpacity onPress={sendMessage} disabled={!chatInput.trim()} style={{ marginLeft: 10 }}>
                        <View style={{width: 32, height: 32, borderRadius: 16, backgroundColor: chatInput.trim() ? COLORS.primary : 'transparent', alignItems:'center', justifyContent:'center'}}>
                            <Send size={18} color={chatInput.trim() ? '#fff' : currentColors.subText} />
                        </View>
                    </TouchableOpacity>
                </View>
            </View>
        </KeyboardAvoidingView>
      </View>
    );
  };
  const isDark = theme === 'system' ? isSystemDark : theme === 'dark';
  const currentColors = isDark ? { bg: COLORS.darkBg, surface: COLORS.darkSurface, text: '#fff', subText: '#94a3b8' } : { bg: COLORS.background, surface: COLORS.surface, text: COLORS.textDark, subText: COLORS.textLight };
    const getCategoryColor = (catId: string) => {
        // Kategorinin rengini bul, eÄŸer bulamazsan varsayÄ±lan 'blue' al
        const cat = categories.find(c => c.id === catId);
        const colorKey = cat?.color || 'blue';
        // Rengin HEX kodunu ve arka planÄ±nÄ± bul
        return CATEGORY_COLORS.find(c => c.id === colorKey) || CATEGORY_COLORS[0];
    };
  const currentISODate = getISODate(selectedDate);
  const todaysTasks = tasks.filter(t => {
      if (t.date === currentISODate) return true;
      if (t.showEveryDayUntilDue && t.dueDate) return currentISODate >= t.date && currentISODate <= convertDDMMYYYYtoISO(t.dueDate);
      return false;
  });

  const activeTasks = todaysTasks.filter(t => !t.completed).sort((a,b) => parseDueDate(a.dueDate) - parseDueDate(b.dueDate));
  const completedTasks = todaysTasks.filter(t => t.completed);
  const overdueTasks = tasks.filter(t => !t.completed && !t.showEveryDayUntilDue && t.date < getISODate(new Date()));
  // --- BURAYI KOPYALA VE overdueTasks TANIMININ ALTINA YAPIÅžTIR ---
  
  const getUpcomingTasks = () => {
    const today = new Date();
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);

    const todayISO = getISODate(today);
    const nextWeekISO = getISODate(nextWeek);

    // Tarihi yarÄ±n ve sonraki 7 gÃ¼n iÃ§inde olan, tamamlanmamÄ±ÅŸ gÃ¶revler
    return tasks.filter((t: Task) => { // 't: Task' diyerek tip hatasÄ±nÄ± da Ã§Ã¶zÃ¼yoruz
      return !t.completed && t.date > todayISO && t.date <= nextWeekISO;
    }).sort((a, b) => a.date.localeCompare(b.date));
  };
  
  const upcomingTasks = getUpcomingTasks();
  
  // ----------------------------------------------------------------
  
  const todaysHabits = habits.filter(h => {
      if (h.endDate && h.endDate < currentISODate) return false;
      if (h.frequency === 'daily') return true;
      if (h.frequency === 'weekly') return h.selectedDays.includes(selectedDate.getDay());
      return false;
  }).sort((a,b) => (a.notificationTime || "24:00").localeCompare(b.notificationTime || "24:00"));
  // --- PROGRESS BAR HESAPLAMASI ---
  const totalTodaysHabits = todaysHabits.length;
  const completedTodaysHabits = todaysHabits.filter(h => h.completedDates.includes(currentISODate)).length;
  const habitProgress = totalTodaysHabits > 0 ? (completedTodaysHabits / totalTodaysHabits) * 100 : 0;
  const filteredContacts = contacts.filter(c => c.username.toLowerCase().includes(assignSearchText.toLowerCase()));
  // --- GÃ–REVLER PROGRESS BAR HESAPLAMASI ---
  const totalTodaysTasks = todaysTasks.length;
  const completedTodaysTasks = todaysTasks.filter(t => t.completed).length;
  const taskProgress = totalTodaysTasks > 0 ? (completedTodaysTasks / totalTodaysTasks) * 100 : 0;
   // --- TAKVÄ°M Ä°ÅžARETLEME MANTIÄžI (BUGÃœN ve SEÃ‡Ä°LÄ° GÃœN) ---
  const todayStr = getISODate(new Date());
  const selectedStr = getISODate(selectedDate || new Date());
  

  const calendarMarks: any = {};

  // 1. Ã–nce BugÃ¼nÃ¼ Ä°ÅŸaretle (VarsayÄ±lan Stil)
  calendarMarks[todayStr] = {
    customStyles: {
      text: { color: COLORS.primary, fontWeight: '900' }
    }
  };

  // 2. SeÃ§ili GÃ¼nÃ¼ Ä°ÅŸaretle (EÄŸer bugÃ¼n seÃ§iliyse, Ã¼stteki stilin Ã¼zerine yazar)
  calendarMarks[selectedStr] = {
    selected: true,
    customStyles: {
      container: {
        backgroundColor: COLORS.primary, // MOR KUTU
        borderRadius: 8,
        width: 36,
        height: 36,
        alignItems: 'center',
        justifyContent: 'center',
        elevation: 4,
        shadowColor: "#000", shadowOpacity: 0.2, shadowRadius: 3
      },
      text: {
        color: '#ffffff', // BEYAZ YAZI
        fontWeight: 'bold'
      }
    }
  };
const styles = useMemo(() => getDynamicStyles(currentColors, isDark), [currentColors, isDark]);
  const renderTask = (task: Task) => {
    const catInfo = categories.find(c => c.id === task.categoryId) || categories[0];
    const catColor = CATEGORY_COLORS.find(c => c.id === catInfo.color) || CATEGORY_COLORS[0];
    const isAssignedByOther = task.assignedBy && task.assignedBy !== user.uid;
    const isExpanded = expandedTaskId === task.id;
    const isMultiDay = task.showEveryDayUntilDue;
    // ... diÄŸer kodlar ...
    return (
        <View key={task.id} style={[styles.taskCard, { backgroundColor: currentColors.surface, opacity: task.completed ? 0.6 : 1, borderLeftWidth: isAssignedByOther ? 4 : 0, borderLeftColor: COLORS.warning }]}>
            <TouchableOpacity onPress={() => toggleExpand(task.id)} style={{flexDirection:'row', alignItems:'center'}}>
                <TouchableOpacity onPress={() => toggleTask(task)} style={[styles.checkBox, task.completed ? { backgroundColor: COLORS.success, borderColor: COLORS.success } : { borderColor: '#cbd5e1' }]}>
                    {task.completed && <Check size={14} color="#fff" />}
                </TouchableOpacity>
                <View style={{flex:1}}>
                    <Text style={[styles.taskText, { color: currentColors.text, textDecorationLine: task.completed ? 'line-through' : 'none' }]}>{task.text}</Text>
                    <View style={styles.taskMeta}>
                        <View style={[styles.miniBadge, { backgroundColor: isDark ? '#334155' : catColor.bg }]}><View style={{width:6, height:6, borderRadius:3, backgroundColor: catColor.hex}} /><Text style={{fontSize:10, color: isDark ? '#fff' : catColor.hex, fontWeight:'bold'}}>{catInfo.name}</Text></View>
                        {isAssignedByOther && <View style={[styles.miniBadge, { backgroundColor: '#fef3c7' }]}><User size={10} color={COLORS.warning} /><Text style={{fontSize:10, color: COLORS.warning, fontWeight:'bold'}}>{task.assignedByName || 'Patron'}</Text></View>}
                        {task.dueDate && <View style={styles.metaItem}><CalendarClock size={10} color={COLORS.danger} /><Text style={{fontSize:10, color: COLORS.danger}}>{task.dueDate}</Text></View>}
                        {isMultiDay && <View style={styles.metaItem}><Repeat size={10} color={COLORS.primary} /><Text style={{fontSize:10, color: COLORS.primary}}>{t('every_day')}</Text></View>}
                        {task.notificationTime && (<View style={styles.metaItem}><Bell size={10} color={COLORS.primary} /><Text style={{fontSize:10, color: COLORS.primary}}>{task.notificationTime}</Text></View>)}
                    </View>
                </View>
                <View style={{marginLeft:10}}>{isExpanded ? <ChevronUp size={20} color={currentColors.subText} /> : <ChevronDown size={20} color={currentColors.subText} />}</View>
            </TouchableOpacity>
            {isExpanded && (
                <View style={{marginTop:15, paddingTop:15, borderTopWidth:1, borderColor: isDark ? '#334155' : '#f1f5f9'}}>
                    {task.description ? (<View style={{flexDirection:'row', gap:5, marginBottom:10}}><AlignLeft size={14} color={currentColors.subText} style={{marginTop:2}} /><Text style={{color: currentColors.text, fontSize:14, flex:1}}>{task.description}</Text></View>) : (<Text style={{color: currentColors.subText, fontSize:12, fontStyle:'italic', marginBottom:10}}>{t('task_no_desc')}</Text>)}
                    <View style={{flexDirection:'row', justifyContent:'flex-end', gap:15, marginTop:5}}>
                        <TouchableOpacity onPress={() => {askConfirmation( t('delete_btn'), t('task_delete_confirm'), () => deleteTask(task), true );
                            }}><Trash2 size={16} color={COLORS.danger} /><Text style={{color: COLORS.danger, fontSize:12, fontWeight:'bold'}}>{t('delete')}</Text></TouchableOpacity>
                        {(task.assignedBy === user.uid || task.assignedTo === user.uid) && (<TouchableOpacity onPress={() => openEditModal(task)} style={{flexDirection:'row', alignItems:'center', gap:5, padding:5, backgroundColor: COLORS.primary + '20', borderRadius:8, paddingHorizontal:10}}><Edit2 size={16} color={COLORS.primary} /><Text style={{color: COLORS.primary, fontSize:12, fontWeight:'bold'}}>{t('edit')}</Text></TouchableOpacity>)}
                    </View>
                </View>
            )}
        </View>
    );
  };

// EÄŸer Splash animasyonu daha bitmediyse, Auth yÃ¼klense bile Splash gÃ¶ster.
// --- A) SPLASH EKRANI ---
  if (!isSplashAnimationComplete && Platform.OS !== 'web') { 
      return (
        <AnimatedSplash 
            onAnimationFinish={() => {
                setIsSplashAnimationComplete(true); 
                setShowAuth(true);
            }} 
        /> 
      );
  }

  // --- B) KULLANICI YOKSA (GiriÅŸ / KayÄ±t EkranÄ±) ---
  if (!user) {
    // 1. Landing Page mi gÃ¶sterilsin?
    if (!showAuth) {
      return (
        <LandingPage 
            lang={lang} 
            isDark={isDark} 
            onGetStarted={(mode) => {
                // Landing Page'deki butona basÄ±lÄ±nca Ã§alÄ±ÅŸÄ±r
                setAuthMode(mode); // 'login' veya 'signup' modunu ayarla
                setShowAuth(true); // ArtÄ±k GiriÅŸ ekranÄ±nÄ± gÃ¶ster
            }} 
            onLanguageChange={(newLang) => setLang(newLang as LangCode)}
        />
      );    
    }

    // 2. HAYIR, GÄ°RÄ°Åž EKRANI (Login/Signup) GÃ–STERÄ°LSÄ°N
    // (Senin kodunda eksik veya karÄ±ÅŸÄ±k olan kÄ±sÄ±m burasÄ±ydÄ±)
    return (
      <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={{ flex: 1 }}>
        <TouchableWithoutFeedback onPress={Platform.OS !== 'web' ? Keyboard.dismiss : undefined}>
          <View style={{ flex: 1, backgroundColor: currentColors.bg, justifyContent: 'center', padding: 20 }}>
            
            {/* LOGO */}
            <View style={{ alignItems: 'center', marginBottom: 40 }}>
               <Image source={require('../../assets/Logo/Logo.png')} style={{ width: 200, height: 60, resizeMode: 'contain' }} />
            </View>

            {/* INPUTLAR (KullanÄ±cÄ± AdÄ± / Åžifre) */}
            <View style={{ gap: 15 }}>
               {/* KayÄ±t Modundaysa KullanÄ±cÄ± AdÄ± Inputu */}
               {authMode === 'signup' && (
                <View style={styles.authInputRow}>
                    <User size={20} color={currentColors.subText} />
                    <TextInput value={username} onChangeText={setUsername} placeholder={t('social_search_tab_username')} placeholderTextColor={currentColors.subText} style={[styles.authInput, {color: currentColors.text}]} autoCapitalize='none' />
                </View>
            )}

            <View style={styles.authInputRow}>
                <Mail size={20} color={currentColors.subText} />
                <TextInput 
                    value={email} 
                    onChangeText={setEmail} 
                    // Placeholder'Ä± deÄŸiÅŸtirdik:
                    placeholder={authMode === 'login' ? t('auth_email_username_placeholder') : t('email')} 
                    placeholderTextColor={currentColors.subText} 
                    style={[styles.authInput, {color: currentColors.text}]} 
                    autoCapitalize='none' 
                    // Login sÄ±rasÄ±nda klavyede @ iÅŸareti zorunlu olmasÄ±n diye default yapÄ±yoruz
                    keyboardType={authMode === 'login' ? "default" : "email-address"}
                    returnKeyType="next" // Klavyede "Ä°leri" butonu gÃ¶sterir
                    blurOnSubmit={false} // Enter'a basÄ±nca klavyeyi kapatma
                    onSubmitEditing={() => passwordRef.current?.focus()} // Åžifre kutusuna atla
                />
            </View>

            <View style={styles.authInputRow}>
                <Lock size={20} color={currentColors.subText} />
                <TextInput value={password} onChangeText={setPassword} placeholder={t('auth_password_placeholder')} placeholderTextColor={currentColors.subText} style={[styles.authInput, {color: currentColors.text}]} secureTextEntry ref={passwordRef} returnKeyType="done"  onSubmitEditing={handleAuth} />
            </View>

            {/* --- YENÄ° YER: BENÄ° HATIRLA (Sadece GiriÅŸ Modunda) --- */}
            {authMode === 'login' && (
                <TouchableOpacity 
                    onPress={() => setRememberMe(!rememberMe)} 
                    style={{flexDirection:'row', alignItems:'center', gap:10, marginBottom: 15, marginTop: 5}}
                >
                    <View style={{
                        width: 20, height: 20, borderRadius: 4, borderWidth: 2, 
                        borderColor: rememberMe ? COLORS.primary : currentColors.subText, 
                        alignItems:'center', justifyContent:'center',
                        backgroundColor: rememberMe ? COLORS.primary : 'transparent'
                    }}>
                        {rememberMe && <Check size={14} color="#fff" />}
                    </View>
                    <Text style={{color: currentColors.text, fontSize: 14}}>{t('remember_me')}</Text>
                </TouchableOpacity>
            )}
            {/* -------------------------------------------------- */}

            {/* 3. GÄ°RÄ°Åž BUTONU */}
            <TouchableOpacity onPress={handleAuth} style={[styles.createBtn, {marginTop: 10}]}>
                <Text style={{color:'#fff', fontWeight:'bold', fontSize:16}}>
                    {authMode === 'login' ? t('auth_login_tab') : t('auth_signup_tab')}
                </Text>
            </TouchableOpacity>

            {/* 4. ÅžÄ°FREMÄ° UNUTTUM BUTONU */}
                {authMode === 'login' && (
                    <TouchableOpacity onPress={() => router.push('/auth/forgot-password')}style={{ marginTop: 15, alignSelf: 'center', padding: 5 }}>
                        <Text style={{ color: currentColors.subText, fontSize: 14, fontWeight: '500' }}>{t('forgot_password')}</Text>
                    </TouchableOpacity>
                )}

        </View>
        <View style={{marginTop: 20, gap: 10}}>
           <TouchableOpacity disabled={!request} onPress={() => promptAsync()} style={[styles.socialBtn, {backgroundColor: currentColors.surface, flexDirection:'row', gap:10, justifyContent: 'center'}]}>
              <Globe size={20} color={currentColors.text} /> 
              <Text style={{color: currentColors.text, fontWeight:'600'}}>{t('auth_google_continue')}</Text>
           </TouchableOpacity>
           
           {Platform.OS === 'ios' && (
             <AppleAuthentication.AppleAuthenticationButton 
               buttonType={AppleAuthentication.AppleAuthenticationButtonType.SIGN_IN} 
               buttonStyle={isDark ? AppleAuthentication.AppleAuthenticationButtonStyle.WHITE : AppleAuthentication.AppleAuthenticationButtonStyle.BLACK} 
               cornerRadius={12} 
               style={{ width: '100%', height: 50 }} 
               onPress={handleAppleLogin} 
             />
           )}
           {/* MÄ°SAFÄ°R GÄ°RÄ°ÅžÄ° - SADECE MOBÄ°LDE GÃ–ZÃœKSÃœN (WEB'DE GÄ°ZLE) */}
            {Platform.OS !== 'web' && (
                <TouchableOpacity 
                    onPress={handleGuestLogin} 
                    style={{marginTop: 15, padding: 10, alignItems:'center'}}
                >
                    <Text style={{color: currentColors.subText, fontSize: 14, textDecorationLine:'underline'}}>
                        {t('continue_guest')}
                    </Text>
                </TouchableOpacity>
            )}
            </View>
            {customToast.visible && (
              <View style={{
                position: 'absolute', top: 50, left: 20, right: 20, zIndex: 9999, // Top deÄŸerini 50 yaptÄ±m
                backgroundColor: customToast.type === 'error' ? '#fee2e2' : (customToast.type === 'warning' ? '#fef3c7' : '#f0fdf4'),
                padding: 15, borderRadius: 16, flexDirection: 'row', alignItems: 'center', gap: 12,
                shadowColor: "#000", shadowOpacity: 0.2, shadowRadius: 10, elevation: 10,
                borderWidth: 1, borderColor: customToast.type === 'error' ? '#ef4444' : (customToast.type === 'warning' ? '#f59e0b' : '#10b981')
              }}>
                <View style={{ width: 36, height: 36, borderRadius: 18, backgroundColor: customToast.type === 'error' ? '#ef4444' : (customToast.type === 'warning' ? '#f59e0b' : '#10b981'), alignItems: 'center', justifyContent: 'center' }}>
                  {customToast.type === 'success' && <Check size={18} color="#fff" />}
                  {customToast.type === 'error' && <X size={18} color="#fff" />}
                  {customToast.type === 'warning' && <AlertCircle size={18} color="#fff" />}
                  {customToast.type === 'info' && <Bell size={18} color="#fff" />}
                </View>
                <View style={{ flex: 1 }}>
                  <Text style={{ color: '#1e293b', fontWeight: 'bold', fontSize: 13 }}>{customToast.title}</Text>
                  <Text style={{ color: '#475569', fontSize: 11 }}>{customToast.message}</Text>
                </View>
                <TouchableOpacity onPress={() => setCustomToast({ ...customToast, visible: false })}><X size={16} color="#475569" /></TouchableOpacity>
              </View>
            )}
          </View>
        </TouchableWithoutFeedback>
      </KeyboardAvoidingView>
    );
  }
  

        {/* ================================================================================= */}
        {/* 1. HEADER (LOGO) - Chat odasÄ± hariÃ§ her yerde gÃ¶rÃ¼nÃ¼r */}
        {/* ================================================================================= */}
        return (
    <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={{ flex: 1 }}>
      <SafeAreaView style={[styles.container, { backgroundColor: currentColors.bg }]}>
        <StatusBar barStyle={isDark ? 'light-content' : 'dark-content'} />

        {activeTab !== 'chat_room' && (
          <View style={[styles.header, { justifyContent: 'center', paddingBottom: 5 }]}>
            <TouchableOpacity onPress={() => setActiveTab('list')} activeOpacity={0.7}>
              <Image
                source={require('../../assets/Logo/Logo.png')}
                style={{ width: 150, height: 50, resizeMode: 'contain' }}
              />
            </TouchableOpacity>
          </View>
        )}

        {/* ================================================================================= */}
        {/* 2. MODERN TARÄ°H NAVÄ°GASYONU & TAKVÄ°M */}
        {/* ================================================================================= */}
        {(activeTab === 'list' || activeTab === 'habits') && (
          <View style={{ marginBottom: 10, zIndex: 20 }}>
            
            {/* ÃœST NAVÄ°GASYON BARI */}
            <View style={{ 
              flexDirection: 'row', 
              alignItems: 'center', 
              justifyContent: 'space-between', 
              paddingHorizontal: 20, 
              marginBottom: isCalendarExpanded ? 15 : 5 
            }}>
              
              {/* SOL OK */}
              <TouchableOpacity 
                onPress={() => changeDate(-1)} 
                style={{
                  width: 40, height: 40, borderRadius: 20,
                  backgroundColor: isDark ? 'rgba(255,255,255,0.05)' : '#fff',
                  alignItems: 'center', justifyContent: 'center',
                  borderWidth: 1, borderColor: isDark ? 'transparent' : '#f1f5f9',
                  shadowColor: "#000", shadowOpacity: 0.05, shadowRadius: 5, elevation: 2
                }}
              >
                <ChevronLeft size={20} color={currentColors.text} />
              </TouchableOpacity>

              {/* ORTA TARÄ°H BUTONU (Pill Shape) */}
              <TouchableOpacity
                onPress={() => {
                  LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
                  setIsCalendarExpanded(!isCalendarExpanded);
                }}
                activeOpacity={0.7}
                style={{
                  flexDirection: 'row',
                  alignItems: 'center',
                  backgroundColor: isCalendarExpanded ? COLORS.primary : (isDark ? 'rgba(255,255,255,0.05)' : '#fff'),
                  paddingHorizontal: 20,
                  paddingVertical: 10,
                  borderRadius: 24,
                  borderWidth: 1,
                  borderColor: isCalendarExpanded ? COLORS.primary : (isDark ? 'transparent' : '#f1f5f9'),
                  shadowColor: isCalendarExpanded ? COLORS.primary : "#000",
                  shadowOpacity: isCalendarExpanded ? 0.3 : 0.05,
                  shadowRadius: 8, elevation: isCalendarExpanded ? 4 : 2,
                  gap: 8
                }}
              >
                <CalendarIcon size={16} color={isCalendarExpanded ? '#fff' : COLORS.primary} />
                <Text style={{ 
                  fontSize: 15, 
                  fontWeight: '700', 
                  color: isCalendarExpanded ? '#fff' : currentColors.text 
                }}>
                  {selectedDate.getDate()} {getGreeting(lang) === 'tr' ? ' ' : '/'} {selectedDate.getMonth() + 1} {selectedDate.getFullYear()}
                </Text>
                {isCalendarExpanded ? 
                  <ChevronUp size={16} color="#fff" /> : 
                  <ChevronDown size={16} color={currentColors.subText} />
                }
              </TouchableOpacity>

              {/* SAÄž OK */}
              <TouchableOpacity 
                onPress={() => changeDate(1)} 
                style={{
                  width: 40, height: 40, borderRadius: 20,
                  backgroundColor: isDark ? 'rgba(255,255,255,0.05)' : '#fff',
                  alignItems: 'center', justifyContent: 'center',
                  borderWidth: 1, borderColor: isDark ? 'transparent' : '#f1f5f9',
                  shadowColor: "#000", shadowOpacity: 0.05, shadowRadius: 5, elevation: 2
                }}
              >
                <ChevronRight size={20} color={currentColors.text} />
              </TouchableOpacity>
            </View>

            {/* AÃ‡ILIR TAKVÄ°M (AKORDEON) */}
            {isCalendarExpanded && (
              <View style={{ 
                backgroundColor: currentColors.surface, 
                marginHorizontal: 20, 
                borderRadius: 24, 
                padding: 15, 
                borderWidth: 1, 
                borderColor: isDark ? '#334155' : '#f1f5f9', 
                shadowColor: "#000", shadowOffset: { width: 0, height: 10 }, shadowOpacity: 0.1, shadowRadius: 20, elevation: 10 
              }}>
                <Calendar
                  current={getISODate(selectedDate)}
                  key={`${lang}-${theme}`}
                  markingType={'custom'}
                  markedDates={calendarMarks}
                  onDayPress={(day: any) => {
                    const newDate = new Date(day.timestamp);
                    newDate.setMinutes(newDate.getMinutes() + newDate.getTimezoneOffset());
                    setSelectedDate(newDate);
                    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
                    setIsCalendarExpanded(false);
                  }}
                  theme={{
                    backgroundColor: 'transparent',
                    calendarBackground: 'transparent',
                    textSectionTitleColor: currentColors.subText,
                    selectedDayBackgroundColor: COLORS.primary,
                    selectedDayTextColor: '#ffffff',
                    todayTextColor: COLORS.primary,
                    dayTextColor: currentColors.text,
                    textDisabledColor: isDark ? '#475569' : '#d9e1e8',
                    arrowColor: COLORS.primary,
                    monthTextColor: currentColors.text,
                    indicatorColor: COLORS.primary,
                    textDayFontWeight: '600',
                    textMonthFontWeight: '800',
                    textDayHeaderFontWeight: 'bold',
                    textDayFontSize: 14,
                    textMonthFontSize: 16,
                    textDayHeaderFontSize: 12
                  }}
                />
              </View>
            )}
          </View>
        )}

        {/* ================================================================================= */}
        {/* 3. ANA Ä°Ã‡ERÄ°K (PAGER VIEW veya CHAT ROOM) */}
        {/* ================================================================================= */}
        {activeTab === 'chat_room' && chatTarget ? (
          renderChatRoom()
        ) : (
          <View style={{ flex: 1 }}>
            <PagerView
              ref={pagerRef}
              style={{ flex: 1,width: '100%', height: '100%' }}
              initialPage={0}
              onPageSelected={handlePageScroll}
              scrollEnabled={Platform.OS !== 'web'}
            >
             {/* --- SAYFA 0: GÃ–REVLER (TASKS) --- */}
              <View key="0" style={{ flex: 1, width: '100%' }}>
                <ScrollView 
                  contentContainerStyle={{ 
                    paddingHorizontal: 20, 
                    paddingBottom: 120,
                    width: '100%',
                    maxWidth: 600, // Web'de iÃ§eriÄŸin Ã§ok geniÅŸlemesini engeller
                    alignSelf: 'center', // Web'de iÃ§eriÄŸi ortalar
                    paddingTop: 10
                  }} 
                  showsVerticalScrollIndicator={false}
                >
                  
                  {/* --- 1. MODERN PROGRESS BAR --- */}
                  {totalTodaysTasks > 0 && (
                    <View style={{ 
                      backgroundColor: COLORS.primary, 
                      borderRadius: 24, 
                      padding: 20, 
                      marginBottom: 25, 
                      shadowColor: COLORS.primary, 
                      shadowOpacity: 0.4, 
                      shadowRadius: 12, 
                      shadowOffset: { width: 0, height: 8 },
                      elevation: 8,
                      position: 'relative',
                      overflow: 'hidden'
                    }}>
                      {/* Arka Plan SÃ¼slemesi (Circle) */}
                      <View style={{ position: 'absolute', top: -30, right: -30, width: 100, height: 100, borderRadius: 50, backgroundColor: 'rgba(255,255,255,0.1)' }} />
                      
                      <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 15 }}>
                        <View>
                          <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: 13, fontWeight: '600', letterSpacing: 0.5 }}>
                            {t('daily_progress').toUpperCase()}
                          </Text>
                          <Text style={{ color: '#fff', fontSize: 32, fontWeight: '900', marginTop: 4 }}>
                            {Math.round(taskProgress)}%
                          </Text>
                        </View>
                        <View style={{ backgroundColor: 'rgba(255,255,255,0.2)', paddingHorizontal: 12, paddingVertical: 6, borderRadius: 12 }}>
                          <Text style={{ color: '#fff', fontSize: 14, fontWeight: 'bold' }}>
                            {completedTodaysTasks} / {totalTodaysTasks}
                          </Text>
                        </View>
                      </View>

                      <View style={{ height: 8, backgroundColor: 'rgba(255,255,255,0.2)', borderRadius: 4, overflow: 'hidden' }}>
                        <View style={{ width: `${taskProgress}%`, height: '100%', backgroundColor: '#fff', borderRadius: 4 }} />
                      </View>
                    </View>
                  )}

                  {/* --- 2. GECÄ°KEN GÃ–REVLER (OVERDUE) --- */}
                  {overdueTasks.length > 0 && (
                    <View style={{ marginBottom: 25 }}>
                      <TouchableOpacity 
                        onPress={() => { 
                          LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut); 
                          setIsOverdueExpanded(!isOverdueExpanded); 
                        }} 
                        activeOpacity={0.8}
                        style={{ 
                          flexDirection: 'row', 
                          alignItems: 'center', 
                          justifyContent: 'space-between', 
                          padding: 16, 
                          backgroundColor: isDark ? 'rgba(239, 68, 68, 0.1)' : '#fef2f2', 
                          borderRadius: 18, 
                          borderWidth: 1, 
                          borderColor: isDark ? 'rgba(239, 68, 68, 0.3)' : '#fee2e2'
                        }}
                      >
                        <View style={{ flexDirection: 'row', alignItems: 'center', gap: 12 }}>
                          <View style={{ backgroundColor: COLORS.danger, padding: 8, borderRadius: 10 }}>
                            <AlertCircle size={20} color="#fff" />
                          </View>
                          <View>
                            <Text style={{ color: COLORS.danger, fontWeight: '800', fontSize: 15 }}>
                              {t('overdue')}
                            </Text>
                            <Text style={{ color: COLORS.danger, fontSize: 11, opacity: 0.8, fontWeight: '500' }}>
                              {overdueTasks.length} {t('tasks_waiting')}
                            </Text>
                          </View>
                        </View>
                        <View style={{ backgroundColor: COLORS.danger + '15', padding: 6, borderRadius: 20 }}>
                          {isOverdueExpanded ? <ChevronUp size={20} color={COLORS.danger} /> : <ChevronDown size={20} color={COLORS.danger} />}
                        </View>
                      </TouchableOpacity>

                      {isOverdueExpanded && (
                        <View style={{ marginTop: 12, gap: 10, paddingHorizontal: 4 }}>
                          {overdueTasks.map((task, index) => (
                            <View 
                              key={task.id} 
                              style={{ 
                                flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between',
                                padding: 16, backgroundColor: currentColors.surface, 
                                borderRadius: 16, borderLeftWidth: 4, borderLeftColor: COLORS.danger,
                                shadowColor: COLORS.danger, shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.05, shadowRadius: 4, elevation: 2 
                              }}
                            >
                              <View style={{ flex: 1, marginRight: 10 }}>
                                <Text numberOfLines={2} style={{ fontSize: 15, fontWeight: '600', color: currentColors.text, marginBottom: 6 }}>
                                  {task.text}
                                </Text>
                                <View style={{ flexDirection: 'row', alignItems: 'center', gap: 6 }}>
                                  <CalendarIcon size={12} color={COLORS.danger} />
                                  <Text style={{ fontSize: 12, color: COLORS.danger, fontWeight: '600' }}>{task.date}</Text>
                                </View>
                              </View>
                              <TouchableOpacity onPress={() => deleteTask(task)} hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }} style={{ padding: 10, backgroundColor: isDark ? 'rgba(239, 68, 68, 0.1)' : '#fef2f2', borderRadius: 12 }}>
                                <Trash2 size={18} color={COLORS.danger} />
                              </TouchableOpacity>
                            </View>
                          ))}
                        </View>
                      )}
                    </View>
                  )}

                  {/* --- 3. AKTÄ°F GÃ–REVLER LÄ°STESÄ° --- */}
                  <View style={{ gap: 12 }}>
                    {activeTasks.length > 0 ? (
                      activeTasks.map((task, index) => (
                        <React.Fragment key={task.id}>
                          {renderTask(task)}
                          {/* Reklam AlanÄ± (Her 5 gÃ¶revde bir) */}
                          {!isPremium && (index + 1) % 5 === 0 && (
                            <View style={{ marginVertical: 15, alignItems: 'center' }}>
                              <OmmioAdBanner isPremium={false} />
                            </View>
                          )}
                        </React.Fragment>
                      ))
                    ) : (
                      /* BOÅž DURUM (EMPTY STATE) */
                      completedTasks.length === 0 && overdueTasks.length === 0 && (
                        <View style={{ alignItems: 'center', justifyContent: 'center', marginTop: 40, padding: 30 }}>
                          <View style={{ 
                            width: 100, height: 100, borderRadius: 50, 
                            backgroundColor: isDark ? 'rgba(99, 102, 241, 0.1)' : '#e0e7ff', 
                            alignItems: 'center', justifyContent: 'center', marginBottom: 20 
                          }}>
                            <Check size={48} color={COLORS.primary} strokeWidth={2.5} />
                          </View>
                          <Text style={{ fontSize: 22, fontWeight: '800', color: currentColors.text, marginBottom: 8, textAlign: 'center' }}>
                            {t('all_good')}
                          </Text>
                          <Text style={{ fontSize: 15, color: currentColors.subText, textAlign: 'center', lineHeight: 22, maxWidth: 250 }}>
                            {t('no_tasks_today')}
                          </Text>
                        </View>
                      )
                    )}
                  </View>

                  {/* --- 4. TAMAMLANAN GÃ–REVLER (AKORDEON) --- */}
                  {completedTasks.length > 0 && (
                    <View style={{ marginTop: 30 }}>
                      <TouchableOpacity 
                        onPress={() => { LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut); setIsCompletedExpanded(!isCompletedExpanded); }} 
                        activeOpacity={0.7}
                        style={{ 
                          flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', 
                          padding: 14, backgroundColor: isDark ? 'rgba(255,255,255,0.05)' : '#f8fafc', 
                          borderRadius: 14, borderWidth: 1, borderColor: isDark ? 'rgba(255,255,255,0.1)' : '#e2e8f0'
                        }}
                      >
                        <View style={{ flexDirection: 'row', alignItems: 'center', gap: 10 }}>
                          <View style={{ backgroundColor: COLORS.success + '20', padding: 6, borderRadius: 8 }}>
                            <CheckCircle2 size={18} color={COLORS.success} />
                          </View>
                          <Text style={{ color: currentColors.text, fontWeight: '700', fontSize: 14 }}>
                            {t('completed')} <Text style={{color: currentColors.subText}}>({completedTasks.length})</Text>
                          </Text>
                        </View>
                        {isCompletedExpanded ? <ChevronUp size={18} color={currentColors.subText} /> : <ChevronDown size={18} color={currentColors.subText} />}
                      </TouchableOpacity>
                      
                      {isCompletedExpanded && (
                        <View style={{ opacity: 0.6, gap: 10, marginTop: 15 }}>
                          {completedTasks.map(task => renderTask(task))}
                        </View>
                      )}
                    </View>
                  )}

                </ScrollView>
              </View>

              {/* --- SAYFA 1: ALIÅžKANLIKLAR (HABITS) --- */}
              <View key="1" style={{ flex: 1, width: '100%' }}>
                <ScrollView 
                  contentContainerStyle={{ 
                    paddingHorizontal: 20, 
                    paddingBottom: 120,
                    width: '100%',
                    maxWidth: 600, // Web'de iÃ§eriÄŸin yayÄ±lmasÄ±nÄ± engeller
                    alignSelf: 'center', // Web'de iÃ§eriÄŸi ortalar
                    paddingTop: 10
                  }} 
                  showsVerticalScrollIndicator={false}
                >
                  
                  {/* --- 1. MODERN PROGRESS BAR --- */}
                  <View style={{ 
                    backgroundColor: COLORS.primary, 
                    borderRadius: 24, 
                    padding: 20, 
                    marginBottom: 25, 
                    shadowColor: COLORS.primary, 
                    shadowOpacity: 0.4, 
                    shadowRadius: 12, 
                    shadowOffset: { width: 0, height: 8 }, 
                    elevation: 8,
                    position: 'relative',
                    overflow: 'hidden'
                  }}>
                    {/* Dekoratif Arka Plan */}
                    <View style={{ position: 'absolute', top: -40, right: -20, width: 120, height: 120, borderRadius: 60, backgroundColor: 'rgba(255,255,255,0.1)' }} />
                    
                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 15 }}>
                      <View>
                        <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: 13, fontWeight: '600', letterSpacing: 0.5 }}>
                          {t('daily_progress').toUpperCase()}
                        </Text>
                        <Text style={{ color: '#fff', fontSize: 32, fontWeight: '900', marginTop: 4 }}>
                          {Math.round(habitProgress)}%
                        </Text>
                      </View>
                      <View style={{ backgroundColor: 'rgba(255,255,255,0.2)', paddingHorizontal: 12, paddingVertical: 6, borderRadius: 12 }}>
                        <Text style={{ color: '#fff', fontSize: 14, fontWeight: 'bold' }}>
                          {completedTodaysHabits} / {totalTodaysHabits}
                        </Text>
                      </View>
                    </View>

                    <View style={{ height: 8, backgroundColor: 'rgba(255,255,255,0.2)', borderRadius: 4, overflow: 'hidden' }}>
                      <View style={{ width: `${habitProgress}%`, height: '100%', backgroundColor: '#fff', borderRadius: 4 }} />
                    </View>
                  </View>

                  {/* --- 2. ALIÅžKANLIK LÄ°STESÄ° --- */}
                  <View style={{ gap: 12 }}>
                    {todaysHabits.length > 0 ? (
                      todaysHabits.map((habit, index) => {
                        const isDone = habit.completedDates.includes(currentISODate);
                        const streak = habit.completedDates.length;
                        const cat = categories.find(c => c.id === habit.categoryId);
                        const cc = getCategoryColor(cat?.color || 'purple');

                        return (
                          <React.Fragment key={habit.id}>
                            <TouchableOpacity 
                              onPress={() => toggleHabitCompletion(habit, currentISODate)} 
                              activeOpacity={0.8}
                              style={{ 
                                flexDirection: 'row',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: 16,
                                backgroundColor: currentColors.surface,
                                borderRadius: 20,
                                borderWidth: 1,
                                borderColor: isDone ? 'transparent' : (isDark ? '#334155' : '#f1f5f9'),
                                opacity: isDone ? 0.7 : 1, // TamamlanÄ±nca hafif silikleÅŸsin
                                shadowColor: "#000",
                                shadowOffset: { width: 0, height: 4 },
                                shadowOpacity: isDone ? 0 : 0.05, // TamamlanÄ±nca gÃ¶lge kalksÄ±n
                                shadowRadius: 8,
                                elevation: isDone ? 0 : 3
                              }}
                            >
                              <View style={{ flexDirection: 'row', alignItems: 'center', gap: 14, flex: 1 }}>
                                
                                {/* Custom Checkbox (Yuvarlak) */}
                                <View style={{ 
                                  width: 28, height: 28, borderRadius: 14, 
                                  borderWidth: isDone ? 0 : 2, 
                                  borderColor: isDone ? 'transparent' : '#cbd5e1',
                                  backgroundColor: isDone ? COLORS.primary : 'transparent',
                                  alignItems: 'center', justifyContent: 'center'
                                }}>
                                  {isDone && <Check size={16} color="#fff" strokeWidth={3} />}
                                </View>

                                <View style={{ flex: 1 }}>
                                  <Text style={{ 
                                    fontSize: 16, 
                                    fontWeight: '700', 
                                    color: currentColors.text, 
                                    textDecorationLine: isDone ? 'line-through' : 'none',
                                    marginBottom: 6
                                  }}>
                                    {habit.title}
                                  </Text>
                                  
                                  {/* Rozetler (Badges) */}
                                  <View style={{ flexDirection: 'row', flexWrap: 'wrap', gap: 6 }}>
                                    
                                    {/* Streak (Seri) */}
                                    <View style={{ flexDirection: 'row', alignItems: 'center', gap: 4, backgroundColor: '#fff7ed', paddingHorizontal: 8, paddingVertical: 3, borderRadius: 8, borderWidth: 1, borderColor: '#ffedd5' }}>
                                      <Flame size={12} color="#f97316" fill="#f97316" />
                                      <Text style={{ fontSize: 11, color: '#c2410c', fontWeight: '700' }}>{streak} {t('day')}</Text>
                                    </View>

                                    {/* Kategori */}
                                    <View style={{ backgroundColor: cc.bg, paddingHorizontal: 8, paddingVertical: 3, borderRadius: 8 }}>
                                      <Text style={{ fontSize: 11, color: cc.hex, fontWeight: '600' }}>{cat?.name}</Text>
                                    </View>

                                    {/* Saat */}
                                    {habit.notificationTime && (
                                      <View style={{ flexDirection: 'row', alignItems: 'center', gap: 4, backgroundColor: isDark ? 'rgba(255,255,255,0.05)' : '#f1f5f9', paddingHorizontal: 8, paddingVertical: 3, borderRadius: 8 }}>
                                        <Text style={{ fontSize: 11, color: currentColors.subText }}>â° {habit.notificationTime}</Text>
                                      </View>
                                    )}
                                  </View>
                                </View>
                              </View>

                              {/* Silme Butonu */}
                              <TouchableOpacity 
                                onPress={() => askConfirmation(t('delete'), t('delete_habit_confirm'), () => deleteHabit(habit), true)}
                                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
                                style={{ padding: 8 }}
                              >
                                <Trash2 size={18} color={currentColors.subText} style={{ opacity: 0.6 }} />
                              </TouchableOpacity>
                            </TouchableOpacity>

                            {/* Reklam AlanÄ± (Her 5 alÄ±ÅŸkanlÄ±kta bir) */}
                            {!isPremium && (index + 1) % 5 === 0 && (
                              <View style={{ marginVertical: 15, alignItems: 'center' }}>
                                <OmmioAdBanner isPremium={false} />
                              </View>
                            )}
                          </React.Fragment>
                        );
                      })
                    ) : (
                      /* BOÅž DURUM (EMPTY STATE) */
                      <View style={{ alignItems: 'center', justifyContent: 'center', marginTop: 40, padding: 30 }}>
                        <View style={{ 
                          width: 100, height: 100, borderRadius: 50, 
                          backgroundColor: isDark ? 'rgba(99, 102, 241, 0.1)' : '#e0e7ff', 
                          alignItems: 'center', justifyContent: 'center', marginBottom: 20 
                        }}>
                          <Repeat size={48} color={COLORS.primary} strokeWidth={2.5} />
                        </View>
                        <Text style={{ fontSize: 22, fontWeight: '800', color: currentColors.text, marginBottom: 8, textAlign: 'center' }}>
                          {t('new_habit')}!
                        </Text>
                        <Text style={{ fontSize: 15, color: currentColors.subText, textAlign: 'center', lineHeight: 22, maxWidth: 250 }}>
                          {t('motivational_daily')}
                        </Text>
                      </View>
                    )}
                  </View>
                </ScrollView>
              </View>

              {/* --- SAYFA 2: MESAJLAR (MESSAGES) --- */}
              <View key="2" style={{ flex: 1, width: '100%' }}>
                <ScrollView 
                  contentContainerStyle={{ 
                    paddingHorizontal: 20, 
                    paddingBottom: 120,
                    width: '100%',
                    maxWidth: 600, // Web'de iÃ§eriÄŸi sÄ±nÄ±rlar
                    alignSelf: 'center', // Ortalar
                    paddingTop: 10
                  }} 
                  showsVerticalScrollIndicator={false}
                >
                  
                  {/* --- MÄ°SAFÄ°R KULLANICI UYARISI --- */}
                  {user.isAnonymous ? (
                    <View style={{ 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      marginTop: 40,
                      backgroundColor: currentColors.surface,
                      padding: 30,
                      borderRadius: 24,
                      shadowColor: "#000", shadowOpacity: 0.05, shadowRadius: 10, elevation: 5
                    }}>
                      <View style={{ width: 80, height: 80, borderRadius: 40, backgroundColor: COLORS.primary + '15', alignItems: 'center', justifyContent: 'center', marginBottom: 20 }}>
                        <MessageCircle size={40} color={COLORS.primary} />
                      </View>
                      <Text style={{ textAlign: 'center', fontWeight: '800', fontSize: 20, color: currentColors.text, marginBottom: 10 }}>
                        {t('profile_edit_desc')}
                      </Text>
                      <Text style={{ textAlign: 'center', color: currentColors.subText, marginBottom: 25, fontSize: 14, lineHeight: 20, maxWidth: 280 }}>
                        {t('messaging_guest_desc')}
                      </Text>
                      <TouchableOpacity 
                        onPress={() => setIsGuestModalOpen(true)} 
                        style={{ 
                          backgroundColor: COLORS.primary, 
                          paddingHorizontal: 30, 
                          paddingVertical: 14, 
                          borderRadius: 16,
                          shadowColor: COLORS.primary, shadowOpacity: 0.3, shadowRadius: 8, elevation: 4
                        }}
                      >
                        <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 16 }}>{t('create_ac')}</Text>
                      </TouchableOpacity>
                    </View>
                  ) : (
                    /* --- MESAJ LÄ°STESÄ° --- */
                    <View style={{ gap: 12 }}>
                      {contacts.length === 0 ? (
                        /* BOÅž DURUM (EMPTY STATE) */
                        <View style={{ alignItems: 'center', marginTop: 60, opacity: 0.8 }}>
                          <View style={{ width: 100, height: 100, borderRadius: 50, backgroundColor: isDark ? 'rgba(255,255,255,0.05)' : '#f1f5f9', alignItems: 'center', justifyContent: 'center', marginBottom: 20 }}>
                            <MessageCircle size={40} color={currentColors.subText} />
                          </View>
                          <Text style={{ fontSize: 18, fontWeight: '700', color: currentColors.text, marginBottom: 8 }}>
                            {t('no_connections')}
                          </Text>
                          <Text style={{ color: currentColors.subText, textAlign: 'center', maxWidth: 250 }}>
                            ArkadaÅŸ ekleyerek sohbet etmeye baÅŸlayÄ±n.
                          </Text>
                        </View>
                      ) : (
                        contacts
                          .sort((a, b) => {
                            const timeA = chatPreviews[a.uid]?.timestamp?.seconds || 0;
                            const timeB = chatPreviews[b.uid]?.timestamp?.seconds || 0;
                            return timeB - timeA;
                          })
                          .map(contact => {
                            const preview = chatPreviews[contact.uid] || { text: "", timestamp: null, unread: 0 };
                            const hasUnread = preview.unread > 0;

                            return (
                              <TouchableOpacity 
                                key={contact.uid} 
                                onPress={() => { setActiveTab('chat_room'); setChatTarget(contact); }} 
                                activeOpacity={0.7}
                                style={{ 
                                  flexDirection: 'row', 
                                  alignItems: 'center', 
                                  backgroundColor: currentColors.surface, 
                                  padding: 16, 
                                  borderRadius: 20,
                                  borderWidth: 1,
                                  borderColor: isDark ? '#334155' : 'transparent',
                                  shadowColor: "#000", shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.05, shadowRadius: 5, elevation: 2
                                }}
                              >
                                {/* Avatar */}
                                <View style={{ position: 'relative', marginRight: 15 }}>
                                  <View style={{ 
                                    width: 56, height: 56, borderRadius: 28, 
                                    backgroundColor: COLORS.secondary, 
                                    alignItems: 'center', justifyContent: 'center',
                                    borderWidth: 2, borderColor: currentColors.bg 
                                  }}>
                                    {contact.photoURL ? (
                                      <Image source={{ uri: contact.photoURL }} style={{ width: '100%', height: '100%', borderRadius: 28 }} />
                                    ) : (
                                      <Text style={{ fontWeight: '800', color: '#fff', fontSize: 20 }}>
                                        {contact.username[0].toUpperCase()}
                                      </Text>
                                    )}
                                  </View>
                                  {/* Opsiyonel: Online Status Indicator (Åžu an statik, ilerde dinamik yapÄ±labilir) */}
                                  {/* <View style={{ position: 'absolute', bottom: 2, right: 2, width: 14, height: 14, borderRadius: 7, backgroundColor: '#10b981', borderWidth: 2, borderColor: currentColors.surface }} /> */}
                                </View>

                                {/* Ä°Ã§erik */}
                                <View style={{ flex: 1 }}>
                                  <View style={{ flexDirection: 'row', justifyContent: 'space-between', marginBottom: 4, alignItems: 'center' }}>
                                    <Text 
                                      numberOfLines={1} 
                                      style={{ fontSize: 16, fontWeight: '700', color: currentColors.text, flex: 1, marginRight: 10 }}
                                    >
                                      {contact.displayName || contact.username}
                                    </Text>
                                    
                                    {preview.timestamp && (
                                      <Text style={{ 
                                        fontSize: 11, 
                                        color: hasUnread ? COLORS.primary : currentColors.subText, 
                                        fontWeight: hasUnread ? '700' : '500' 
                                      }}>
                                        {formatChatTime(preview.timestamp)}
                                      </Text>
                                    )}
                                  </View>

                                  <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <Text 
                                      numberOfLines={1} 
                                      style={{ 
                                        fontSize: 13, 
                                        color: hasUnread ? currentColors.text : currentColors.subText, 
                                        fontWeight: hasUnread ? '600' : '400',
                                        flex: 1, 
                                        marginRight: 10 
                                      }}
                                    >
                                      {preview.text || t('start_chatting')}
                                    </Text>
                                    
                                    {hasUnread && (
                                      <View style={{ 
                                        backgroundColor: COLORS.primary, 
                                        paddingHorizontal: 8, 
                                        height: 20, 
                                        borderRadius: 10, 
                                        alignItems: 'center', 
                                        justifyContent: 'center' 
                                      }}>
                                        <Text style={{ color: '#fff', fontSize: 10, fontWeight: 'bold' }}>
                                          {preview.unread > 9 ? '9+' : preview.unread}
                                        </Text>
                                      </View>
                                    )}
                                  </View>
                                </View>
                              </TouchableOpacity>
                            );
                          })
                      )}
                    </View>
                  )}
                </ScrollView>
              </View>

              {/* --- SAYFA 3: SOSYAL (SOCIAL) --- */}
              <View key="3" style={{ flex: 1, width: '100%' }}>
                <ScrollView 
                  contentContainerStyle={{ 
                    paddingHorizontal: 20, 
                    paddingBottom: 120,
                    width: '100%',
                    maxWidth: 600, // Web uyumluluÄŸu
                    alignSelf: 'center', // Ortala
                    paddingTop: 10
                  }} 
                  showsVerticalScrollIndicator={false}
                >
                  
                  {/* --- MÄ°SAFÄ°R KULLANICI UYARISI --- */}
                  {user.isAnonymous ? (
                    <View style={{ 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      marginTop: 40,
                      backgroundColor: currentColors.surface,
                      padding: 30,
                      borderRadius: 24,
                      shadowColor: "#000", shadowOpacity: 0.05, shadowRadius: 10, elevation: 5
                    }}>
                      <View style={{ width: 80, height: 80, borderRadius: 40, backgroundColor: COLORS.primary + '15', alignItems: 'center', justifyContent: 'center', marginBottom: 20 }}>
                        <Users size={40} color={COLORS.primary} />
                      </View>
                      <Text style={{ textAlign: 'center', fontWeight: '800', fontSize: 20, color: currentColors.text, marginBottom: 10 }}>
                        {t('social1')}
                      </Text>
                      <Text style={{ textAlign: 'center', color: currentColors.subText, marginBottom: 25, fontSize: 14, lineHeight: 20, maxWidth: 280 }}>
                        {t('register_af')}
                      </Text>
                      <TouchableOpacity 
                        onPress={() => setIsGuestModalOpen(true)} 
                        style={{ 
                          backgroundColor: COLORS.primary, 
                          paddingHorizontal: 30, 
                          paddingVertical: 14, 
                          borderRadius: 16,
                          shadowColor: COLORS.primary, shadowOpacity: 0.3, shadowRadius: 8, elevation: 4
                        }}
                      >
                        <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 16 }}>{t('create_ac')}</Text>
                      </TouchableOpacity>
                    </View>
                  ) : (
                    <View style={{ gap: 25 }}>
                      
                      {/* --- BAÅžLIK & EKLEME BUTONU --- */}
                      <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 }}>
                        <Text style={{ fontSize: 24, fontWeight: '800', color: currentColors.text }}>
                          {t('friends')}
                        </Text>
                        <TouchableOpacity 
                          onPress={() => { if (!checkGuest("ArkadaÅŸ Ekleme")) setIsNetworkModalOpen(true); }}
                          style={{ 
                            width: 40, height: 40, borderRadius: 14, 
                            backgroundColor: COLORS.primary + '15', 
                            alignItems: 'center', justifyContent: 'center' 
                          }}
                        >
                          <UserPlus size={22} color={COLORS.primary} />
                        </TouchableOpacity>
                      </View>

                      {/* --- ARKADAÅžLIK Ä°STEKLERÄ° --- */}
                      {friendRequests.length > 0 && (
                        <View>
                          <Text style={{ fontSize: 13, fontWeight: '700', color: currentColors.subText, marginBottom: 12, letterSpacing: 0.5 }}>
                            {t('social_pending_requests').toUpperCase()}
                          </Text>
                          {friendRequests.map(req => (
                            <View 
                              key={req.id} 
                              style={{ 
                                backgroundColor: currentColors.surface, 
                                padding: 16, 
                                borderRadius: 20, 
                                marginBottom: 12, 
                                flexDirection: 'row', 
                                justifyContent: 'space-between', 
                                alignItems: 'center', 
                                borderLeftWidth: 4, 
                                borderLeftColor: COLORS.warning,
                                shadowColor: "#000", shadowOpacity: 0.05, shadowRadius: 8, elevation: 3
                              }}
                            >
                              <View>
                                <Text style={{ color: currentColors.text, fontWeight: '700', fontSize: 16 }}>{req.fromUsername}</Text>
                                <Text style={{ color: currentColors.subText, fontSize: 12, marginTop: 2 }}>Ä°stek gÃ¶nderdi</Text>
                              </View>
                              <View style={{ flexDirection: 'row', gap: 12 }}>
                                <TouchableOpacity onPress={() => rejectRequest(req.id)} style={{ padding: 6, backgroundColor: '#fee2e2', borderRadius: 10 }}>
                                  <X size={20} color={COLORS.danger} />
                                </TouchableOpacity>
                                <TouchableOpacity onPress={() => acceptRequest(req)} style={{ padding: 6, backgroundColor: '#dcfce7', borderRadius: 10 }}>
                                  <Check size={20} color={COLORS.success} />
                                </TouchableOpacity>
                              </View>
                            </View>
                          ))}
                        </View>
                      )}

                      {/* --- ARKADAÅž LÄ°STESÄ° --- */}
                      {contacts.length === 0 && friendRequests.length === 0 ? (
                        <View style={{ alignItems: 'center', marginTop: 40, opacity: 0.6 }}>
                          <Users size={48} color={currentColors.subText} />
                          <Text style={{ textAlign: 'center', color: currentColors.subText, marginTop: 15, fontSize: 15 }}>
                            {t('no_users')}
                          </Text>
                        </View>
                      ) : (
                        <View style={{ gap: 12 }}>
                          {contacts.map(contact => {
                            const isExpanded = expandedContactId === contact.uid;
                            return (
                              <View 
                                key={contact.uid} 
                                style={{ 
                                  backgroundColor: currentColors.surface, 
                                  borderRadius: 24, 
                                  overflow: 'hidden',
                                  shadowColor: "#000", shadowOpacity: 0.05, shadowRadius: 8, elevation: 2,
                                  borderWidth: 1, borderColor: isDark ? '#334155' : 'transparent'
                                }}
                              >
                                <TouchableOpacity 
                                  onPress={() => { LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut); setExpandedContactId(isExpanded ? null : contact.uid); }} 
                                  activeOpacity={0.7} 
                                  style={{ flexDirection: 'row', alignItems: 'center', padding: 16 }}
                                >
                                  {/* Avatar */}
                                  <View style={{ 
                                    width: 52, height: 52, borderRadius: 26, 
                                    backgroundColor: COLORS.secondary, 
                                    alignItems: 'center', justifyContent: 'center', 
                                    marginRight: 15, borderWidth: 2, borderColor: currentColors.bg 
                                  }}>
                                    {contact.photoURL ? (
                                      <Image source={{ uri: contact.photoURL }} style={{ width: '100%', height: '100%', borderRadius: 26 }} />
                                    ) : (
                                      <Text style={{ fontWeight: '800', color: '#fff', fontSize: 20 }}>
                                        {contact.username[0].toUpperCase()}
                                      </Text>
                                    )}
                                  </View>
                                  
                                  {/* Ä°sim Bilgisi */}
                                  <View style={{ flex: 1 }}>
                                    <Text style={{ fontSize: 16, fontWeight: '700', color: currentColors.text }}>
                                      {contact.displayName || contact.username}
                                    </Text>
                                    <Text style={{ fontSize: 13, color: COLORS.primary, fontWeight: '500' }}>
                                      @{contact.username}
                                    </Text>
                                  </View>
                                  
                                  {/* Ok Ä°konu */}
                                  <View style={{ backgroundColor: isDark ? 'rgba(255,255,255,0.05)' : '#f8fafc', padding: 8, borderRadius: 12 }}>
                                    {isExpanded ? <ChevronUp size={18} color={currentColors.subText} /> : <ChevronDown size={18} color={currentColors.subText} />}
                                  </View>
                                </TouchableOpacity>

                                {/* Detay AlanÄ± (Akordeon) */}
                                {isExpanded && (
                                  <View style={{ backgroundColor: isDark ? 'rgba(0,0,0,0.2)' : '#f8fafc', padding: 20, paddingTop: 10 }}>
                                    
                                    {/* Ä°zin AyarÄ± */}
                                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20, paddingBottom: 15, borderBottomWidth: 1, borderColor: isDark ? 'rgba(255,255,255,0.1)' : '#e2e8f0' }}>
                                      <View style={{ flex: 1, marginRight: 10 }}>
                                        <Text style={{ fontWeight: '700', color: currentColors.text, fontSize: 14 }}>
                                          {t('task_assign_permission')}
                                        </Text>
                                        <Text style={{ fontSize: 11, color: currentColors.subText, marginTop: 2 }}>
                                          {t('c_sendtask')}
                                        </Text>
                                      </View>
                                      <View style={{ flexDirection: 'row', alignItems: 'center', gap: 8 }}>
                                        <Text style={{ fontSize: 12, fontWeight: '700', color: contact.canAssignToMe ? COLORS.success : currentColors.subText }}>
                                          {contact.canAssignToMe ? t('open_label') : t('closed_label')}
                                        </Text>
                                        <Switch 
                                          value={contact.canAssignToMe} 
                                          onValueChange={() => togglePermission(contact)} 
                                          trackColor={{ false: "#cbd5e1", true: "#10b981" }} 
                                          thumbColor={"#fff"}
                                        />
                                      </View>
                                    </View>

                                    {/* Aksiyon ButonlarÄ± */}
                                    <View style={{ gap: 10 }}>
                                      <TouchableOpacity 
                                        onPress={() => showTasksAssignedToFriend(contact.uid, contact.username)} 
                                        style={{ 
                                          flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 10, 
                                          padding: 14, borderRadius: 14, backgroundColor: COLORS.primary + '15' 
                                        }}
                                      >
                                        <ListTodo size={18} color={COLORS.primary} />
                                        <Text style={{ fontSize: 13, fontWeight: '700', color: COLORS.primary }}>
                                          {t('my_assigned_tasks')}
                                        </Text>
                                      </TouchableOpacity>

                                      <View style={{ flexDirection: 'row', gap: 10 }}>
                                        <TouchableOpacity 
                                          onPress={() => handleRemoveFriend(contact.uid, contact.username)} 
                                          style={{ 
                                            flex: 1, flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 8, 
                                            padding: 14, borderRadius: 14, backgroundColor: '#fee2e2' 
                                          }}
                                        >
                                          <UserMinus size={18} color={COLORS.danger} />
                                          <Text style={{ fontSize: 12, fontWeight: '700', color: COLORS.danger }} numberOfLines={1}>
                                            {t('remove_friend')}
                                          </Text>
                                        </TouchableOpacity>
                                        
                                        <TouchableOpacity 
                                          onPress={() => handleBlockFriend(contact.uid, contact.username)} 
                                          style={{ 
                                            flex: 1, flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 8, 
                                            padding: 14, borderRadius: 14, backgroundColor: isDark ? '#334155' : '#e2e8f0' 
                                          }}
                                        >
                                          <XCircle size={18} color={currentColors.subText} />
                                          <Text style={{ fontSize: 12, fontWeight: '700', color: currentColors.subText }} numberOfLines={1}>
                                            {t('block')}
                                          </Text>
                                        </TouchableOpacity>
                                      </View>
                                    </View>
                                  </View>
                                )}
                              </View>
                            );
                          })}
                        </View>
                      )}
                    </View>
                  )}
                </ScrollView>
              </View>

              {/* --- SAYFA 4: PROFÄ°L (PROFILE) --- */}
              <View key="4" style={{ flex: 1, width: '100%' }}>
                <ScrollView 
                  contentContainerStyle={{ 
                    paddingHorizontal: 20, 
                    paddingBottom: 120,
                    width: '100%',
                    maxWidth: 600, // Web'de iÃ§eriÄŸin Ã§ok yayÄ±lmasÄ±nÄ± engeller
                    alignSelf: 'center', // Web'de iÃ§eriÄŸi ortalar
                    paddingTop: 10
                  }} 
                  showsVerticalScrollIndicator={false}
                >
                  
                  {/* --- 1. PROFÄ°L KARTI (FOTOÄžRAF & Ä°SÄ°M) --- */}
                  <View style={[styles.card, { backgroundColor: currentColors.surface, alignItems: 'center', paddingVertical: 25, marginBottom: 15, borderRadius: 24 }]}>
                    
                    {/* FotoÄŸraf AlanÄ± */}
                    <TouchableOpacity 
                      onPress={() => { 
                        if (user.isAnonymous || user.isGuest) { 
                          showToast(t('warning_title'), t('guest_edit_warning') || t('guest_cannot_change_photo'), 'warning'); 
                          return; 
                        } 
                        pickImage(); 
                      }} 
                      activeOpacity={0.8}
                      style={{ position: 'relative', marginBottom: 15 }}
                    >
                      <View style={{ 
                        width: 110, height: 110, borderRadius: 55, 
                        backgroundColor: COLORS.primary, alignItems: 'center', justifyContent: 'center',
                        borderWidth: 4, borderColor: currentColors.bg, // FotoÄŸrafÄ±n etrafÄ±na temiz bir Ã§erÃ§eve
                        shadowColor: COLORS.primary, shadowOpacity: 0.3, shadowRadius: 10, elevation: 5
                      }}>
                        {user.photoURL ? (
                          <Image source={{ uri: user.photoURL }} style={{ width: '100%', height: '100%', borderRadius: 55 }} />
                        ) : (
                          <User size={50} color="#fff" />
                        )}
                      </View>
                      
                      {/* DÃ¼zenleme Ä°konu (SaÄŸ Alt) */}
                      {!(user.isAnonymous || user.isGuest) && (
                        <View style={{ 
                          position: 'absolute', bottom: 0, right: 0, 
                          backgroundColor: currentColors.surface, borderRadius: 20, padding: 6,
                          borderWidth: 1, borderColor: '#e2e8f0', shadowColor: "#000", shadowOpacity: 0.1, elevation: 2
                        }}>
                          <Edit2 size={14} color={COLORS.primary} />
                        </View>
                      )}
                    </TouchableOpacity>

                    {/* Ä°sim ve KullanÄ±cÄ± AdÄ± */}
                    <View style={{ alignItems: 'center', gap: 4 }}>
                      <Text style={{ fontSize: 24, fontWeight: '800', color: currentColors.text, textAlign: 'center' }}>
                        {user.displayName || user.username || t('no_name')}
                      </Text>
                      
                      <TouchableOpacity 
                        onPress={() => { 
                          if (user.isAnonymous || user.isGuest) return; 
                          setEditUsernameInput(user.username || ""); 
                          setEditDisplayNameInput(user.displayName || ""); 
                          setIsEditProfileVisible(true); 
                        }} 
                        activeOpacity={(user.isAnonymous || user.isGuest) ? 1 : 0.6}
                        style={{ flexDirection: 'row', alignItems: 'center', gap: 4, backgroundColor: isDark ? 'rgba(255,255,255,0.05)' : '#f1f5f9', paddingHorizontal: 10, paddingVertical: 4, borderRadius: 12 }}
                      >
                        <Text style={{ fontSize: 14, color: COLORS.primary, fontWeight: '600' }}>@{user.username}</Text>
                        {!(user.isAnonymous || user.isGuest) && <Edit2 size={10} color={COLORS.primary} style={{ opacity: 0.7 }} />}
                      </TouchableOpacity>

                      {(user.isAnonymous || user.isGuest) && (
                        <View style={{ marginTop: 8, backgroundColor: '#fff7ed', paddingHorizontal: 10, paddingVertical: 4, borderRadius: 8, borderWidth: 1, borderColor: '#ffedd5' }}>
                          <Text style={{ fontSize: 11, color: '#c2410c', fontWeight: 'bold' }}>Misafir HesabÄ±</Text>
                        </View>
                      )}
                    </View>
                  </View>

                  {/* --- 2. AYARLAR KARTI --- */}
                  <View style={[styles.card, { backgroundColor: currentColors.surface, padding: 0, borderRadius: 24, overflow: 'hidden', marginBottom: 15 }]}>
                    <View style={{ padding: 20, paddingBottom: 10 }}>
                      <Text style={[styles.cardTitle, { color: currentColors.text, fontSize: 18, marginBottom: 15 }]}>{t('settings')}</Text>
                      
                      {/* Kategoriler */}
                      <TouchableOpacity onPress={() => setIsCategoryModalOpen(true)} style={[styles.settingBtn, { marginBottom: 12, justifyContent: 'space-between', backgroundColor: isDark ? 'rgba(255,255,255,0.03)' : '#f8fafc', borderWidth: 0 }]}>
                        <View style={{ flexDirection: 'row', gap: 12, alignItems: 'center' }}>
                          <View style={{ padding: 8, borderRadius: 10, backgroundColor: COLORS.primary + '15' }}><Layers size={20} color={COLORS.primary} /></View>
                          <Text style={{ color: currentColors.text, fontSize: 15, fontWeight: '500' }}>{t('edit_categories')}</Text>
                        </View>
                        <ChevronRight size={18} color={currentColors.subText} />
                      </TouchableOpacity>

                      {/* Dil SeÃ§imi */}
                      <TouchableOpacity onPress={() => setIsLangModalOpen(true)} style={[styles.settingBtn, { marginBottom: 12, justifyContent: 'space-between', backgroundColor: isDark ? 'rgba(255,255,255,0.03)' : '#f8fafc', borderWidth: 0 }]}>
                        <View style={{ flexDirection: 'row', gap: 12, alignItems: 'center' }}>
                          <View style={{ padding: 8, borderRadius: 10, backgroundColor: COLORS.primary + '15' }}><Globe size={20} color={COLORS.primary} /></View>
                          <Text style={{ color: currentColors.text, fontSize: 15, fontWeight: '500' }}>{t('language')}</Text>
                        </View>
                        <View style={{ flexDirection: 'row', alignItems: 'center', gap: 5 }}>
                          <Text style={{ fontSize: 22 }}>{LANGUAGES.find(l => l.code === lang)?.flag}</Text>
                          <ChevronRight size={18} color={currentColors.subText} />
                        </View>
                      </TouchableOpacity>

                      {/* Åžifre Ä°ÅŸlemleri */}
                      <TouchableOpacity onPress={() => setIsPasswordModalOpen(true)} style={[styles.settingBtn, { marginBottom: 12, justifyContent: 'space-between', backgroundColor: isDark ? 'rgba(255,255,255,0.03)' : '#f8fafc', borderWidth: 0 }]}>
                        <View style={{ flexDirection: 'row', gap: 12, alignItems: 'center' }}>
                          <View style={{ padding: 8, borderRadius: 10, backgroundColor: COLORS.primary + '15' }}><Lock size={20} color={COLORS.primary} /></View>
                          <View>
                            <Text style={{ color: currentColors.text, fontSize: 15, fontWeight: '500' }}>
                              {user.providerData.some((p: any) => p.providerId === 'password') ? t('change_password') : t('create_password')}
                            </Text>
                          </View>
                        </View>
                        <ChevronRight size={18} color={currentColors.subText} />
                      </TouchableOpacity>
                    </View>
                    
                    {/* GÃ¶rÃ¼nÃ¼m (Theme) */}
                    <View style={{ paddingHorizontal: 20, paddingBottom: 20 }}>
                      <Text style={{ fontSize: 12, color: currentColors.subText, fontWeight: '700', marginBottom: 10, marginLeft: 4 }}>{t('appearance')?.toUpperCase() || 'GÃ–RÃœNÃœM'}</Text>
                      <View style={{ flexDirection: 'row', backgroundColor: isDark ? 'rgba(0,0,0,0.2)' : '#f1f5f9', padding: 4, borderRadius: 14 }}>
                        {['light', 'dark', 'system'].map((mode) => {
                          const isActive = theme === mode;
                          const icon = mode === 'light' ? <Sun size={16} color={isActive ? COLORS.primary : currentColors.subText} /> : 
                                      mode === 'dark' ? <Moon size={16} color={isActive ? COLORS.primary : currentColors.subText} /> : 
                                      <Monitor size={16} color={isActive ? COLORS.primary : currentColors.subText} />;
                          const labelKey = `theme_${mode}`;
                          
                          return (
                            <TouchableOpacity 
                              key={mode}
                              onPress={() => setTheme(mode as ThemeMode)} 
                              style={{ 
                                flex: 1, flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 6,
                                paddingVertical: 10, borderRadius: 10,
                                backgroundColor: isActive ? currentColors.surface : 'transparent',
                                shadowColor: "#000", shadowOpacity: isActive ? 0.1 : 0, shadowRadius: 2, elevation: isActive ? 1 : 0
                              }}
                            >
                              {icon}
                              <Text style={{ fontSize: 12, fontWeight: isActive ? 'bold' : '500', color: isActive ? COLORS.primary : currentColors.subText }}>
                                {t(labelKey)}
                              </Text>
                            </TouchableOpacity>
                          )
                        })}
                      </View>
                    </View>
                    
                    {/* Gizlilik Linki */}
                    <TouchableOpacity onPress={() => { setIsSettingsOpen(false); router.push(`/${lang}/privacy`); }} style={{ borderTopWidth: 1, borderColor: isDark ? '#334155' : '#f1f5f9', padding: 15 }}>
                      <Text style={{ color: currentColors.subText, textAlign: 'center', fontSize: 12, fontWeight: '500' }}>{t('privacy_terms')}</Text>
                    </TouchableOpacity>
                  </View>

                  {/* --- 3. PREMIUM ALANI (Veya Misafir UyarÄ±sÄ±) --- */}
                  {!isPremium && (
                    <View style={{ marginBottom: 25 }}>
                      {user.isGuest ? (
                        /* MÄ°SAFÄ°R UYARISI KARTI */
                        <View style={{ backgroundColor: '#fffbeb', borderColor: '#fcd34d', borderWidth: 1, padding: 20, borderRadius: 24 }}>
                          <View style={{ flexDirection: 'row', alignItems: 'center', gap: 10, marginBottom: 10 }}>
                            <View style={{ backgroundColor: '#fff7ed', padding: 8, borderRadius: 10 }}>
                              <AlertCircle size={24} color="#d97706" />
                            </View>
                            <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#9a3412' }}>{t('guest_acc')}</Text>
                          </View>
                          <Text style={{ color: '#9a3412', marginBottom: 15, fontSize: 13, lineHeight: 20 }}>{t('guest_now')}</Text>
                          <TouchableOpacity 
                            onPress={() => setIsGuestModalOpen(true)} 
                            style={{ backgroundColor: '#d97706', padding: 14, borderRadius: 14, alignItems: 'center', shadowColor: "#d97706", shadowOpacity: 0.2, shadowRadius: 5, elevation: 3 }}
                          >
                            <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 15 }}>{t('save_register')}</Text>
                          </TouchableOpacity>
                        </View>
                      ) : (
                        /* PREMIUM KARTI (DÃ¼zeltildi) */
                        <TouchableOpacity 
                          activeOpacity={0.9}
                          onPress={async () => { 
                            try { 
                                // Buraya premium satÄ±n alma fonksiyonunu baÄŸla
                                setIsUpsellVisible(true); 
                            } catch (e) { console.log(e); } 
                          }} 
                          style={{
                            backgroundColor: COLORS.primary, // Ana renk (Mavi/Mor vs.)
                            borderRadius: 24,
                            padding: 20,
                            flexDirection: 'row',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            // Modern GÃ¶lge
                            shadowColor: COLORS.primary,
                            shadowOffset: { width: 0, height: 8 },
                            shadowOpacity: 0.4,
                            shadowRadius: 12,
                            elevation: 10,
                            borderWidth: 1,
                            borderColor: 'rgba(255,255,255,0.2)'
                          }}
                        >
                          <View style={{ flex: 1, paddingRight: 10 }}>
                            <View style={{ flexDirection: 'row', alignItems: 'center', gap: 6, marginBottom: 4 }}>
                              <Trophy size={18} color="#fbbf24" fill="#fbbf24" /> 
                              <Text style={{ color: '#fbbf24', fontWeight: '800', fontSize: 12, letterSpacing: 1 }}>PREMIUM</Text>
                            </View>
                            <Text style={{ color: '#fff', fontSize: 18, fontWeight: 'bold', marginBottom: 4 }}>{t('premium_cta')}</Text>
                            <Text style={{ color: 'rgba(255,255,255,0.8)', fontSize: 13 }}>{t('premium_price')}</Text>
                          </View>

                          <View style={{ 
                            width: 44, height: 44, borderRadius: 22, 
                            backgroundColor: 'rgba(255,255,255,0.2)', 
                            alignItems: 'center', justifyContent: 'center' 
                          }}>
                            <ChevronRight size={24} color="#fff" />
                          </View>
                        </TouchableOpacity>
                      )}
                    </View>
                  )}

                  {/* --- 4. Ã‡IKIÅž & SÄ°LME --- */}
                  <View style={{ gap: 12 }}>
                    <TouchableOpacity onPress={handleLogout} style={[styles.card, { backgroundColor: currentColors.surface, flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 10, padding: 16, borderRadius: 20, marginBottom: 0 }]}>
                      <LogOut size={20} color={COLORS.danger} />
                      <Text style={{ color: COLORS.danger, fontWeight: 'bold', fontSize: 16 }}>{t('logout')}</Text>
                    </TouchableOpacity>

                    <TouchableOpacity onPress={handleDeleteAccount} style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 8, padding: 10, opacity: 0.7 }}>
                      <Text style={{ color: currentColors.subText, fontWeight: '500', fontSize: 13 }}>{t('delete_account')}</Text>
                    </TouchableOpacity>
                  </View>

                </ScrollView>
              </View>
            </PagerView>
          </View>
        )}

        {/* ================================================================================= */}
        {/* 4. REKLAM (Sabit) */}
        {/* ================================================================================= */}
        {!isSettingsOpen && (<OmmioAdBanner isPremium={isPremium} />)}

       {/* ================================================================================= */}
        {/* 5. BOTTOM TABS */}
        {/* ================================================================================= */}
        {!isSettingsOpen && (
          <View 
            style={[
              styles.tabBar, 
              { 
                backgroundColor: currentColors.surface, 
                borderTopColor: isDark ? '#334155' : '#e2e8f0' 
              }
            ]}
          >
            {[
              { key: 'list', Icon: ListTodo, label: t('tasks_tab') },
              { key: 'habits', Icon: Repeat, label: t('habits_tab') },
              { key: 'messages', Icon: MessageCircle, label: t('messages_tab') },
              { key: 'social', Icon: Users, label: t('social_tab') },
              { key: 'profile', Icon: User, label: t('profile_tab') },
            ].map((item) => {
              const isActive = activeTab === item.key;
              const iconColor = isActive ? COLORS.primary : currentColors.subText;

              return (
                <TouchableOpacity
                  key={item.key}
                  onPress={() => onBottomTabPress(item.key)}
                  activeOpacity={0.7}
                  style={styles.tabItem}
                >
                  <View style={{ opacity: isActive ? 1 : 0.5, alignItems: 'center' }}>
                    <item.Icon size={24} color={iconColor} />
                    <Text 
                      style={[
                        styles.tabLabel, 
                        { color: iconColor }
                      ]}
                    >
                      {item.label}
                    </Text>
                  </View>
                </TouchableOpacity>
              );
            })}
          </View>
        )}

       {/* ================================================================================= */}
{/* 6. FLOATING ACTION BUTTONS & TASK INPUT BAR */}
{/* ================================================================================= */}

{/* A. ALIÅžKANLIK EKLEME BUTONU (Sadece Habits Sekmesi) */}
{!isSettingsOpen && activeTab === 'habits' && (
  <View style={[styles.fabContainer, { bottom: !isPremium ? 175 : 95 }]}>
    <TouchableOpacity
      onPress={() => { setAddMode('habit'); setIsAddModalOpen(true); }}
      style={styles.fabButton}
      activeOpacity={0.8}
    >
      <Plus size={28} color="#fff" />
    </TouchableOpacity>
  </View>
)}

{/* B. GÃ–REV EKLEME BARI (Sadece List Sekmesi) */}
{!isSettingsOpen && activeTab === 'list' && (
  <>
    {/* DÄ±ÅŸarÄ± TÄ±klama AlanÄ± (Overlay) */}
    {isInputExpanded && (
      <TouchableWithoutFeedback
        onPress={() => {
          LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
          setIsInputExpanded(false);
          Keyboard.dismiss();
        }}
      >
        <View style={styles.overlay} />
      </TouchableWithoutFeedback>
    )}

    {/* Blur Input Bar */}
    <BlurView
      intensity={Platform.OS === 'ios' ? 80 : 100}
      tint={isDark ? 'dark' : 'light'}
      style={[
        styles.blurInputContainer,
        {
          bottom: !isPremium ? 185 : 115,
          backgroundColor: isDark ? 'rgba(30, 41, 59, 0.6)' : 'rgba(255, 255, 255, 0.65)',
          borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.4)',
        }
      ]}
    >
      {/* 1. GENÄ°ÅžLETÄ°LMÄ°Åž SEÃ‡ENEKLER */}
      {isInputExpanded && (
        <View style={styles.expandedContent}>
          
          {/* BÃ¶lÃ¼m: Kime Atanacak */}
          <Text style={styles.sectionTitle}>{t('assign_to')}</Text>
          <View style={[styles.searchRow, { borderColor: isDark ? '#334155' : '#f1f5f9' }]}>
            <Search size={16} color={currentColors.subText} />
            <TextInput
              value={assignSearchText}
              onChangeText={setAssignSearchText}
              placeholder={t('search_contact')}
              placeholderTextColor={currentColors.subText}
              style={[styles.flexInput, { color: currentColors.text }]}
              onSubmitEditing={addTask}
            />
          </View>

          <View style={{ marginBottom: 15 }}>
            <Text style={[styles.miniHeader, { color: COLORS.primary }]}>{t('assign_to').toUpperCase()}</Text>
            <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={{ gap: 10, paddingHorizontal: 2 }}>
              
              {/* SeÃ§enek: Ben */}
              <TouchableOpacity
                onPress={() => setAssignTarget(null)}
                activeOpacity={0.8}
                style={[
                  styles.assignChip,
                  !assignTarget 
                    ? { backgroundColor: COLORS.primary, borderColor: COLORS.primary } 
                    : { backgroundColor: isDark ? '#334155' : '#fff', borderColor: isDark ? '#475569' : '#e2e8f0' }
                ]}
              >
                <View style={[styles.avatarSmall, { backgroundColor: !assignTarget ? 'rgba(255,255,255,0.2)' : (isDark ? '#475569' : '#f1f5f9') }]}>
                  {user.photoURL ? (
                    <Image source={{ uri: user.photoURL }} style={styles.avatarImage} />
                  ) : (
                    <User size={16} color={!assignTarget ? '#fff' : currentColors.subText} />
                  )}
                </View>
                <Text style={[styles.chipText, { color: !assignTarget ? '#fff' : currentColors.text }]}>{t('me')}</Text>
                {!assignTarget && <CheckCircle2 size={14} color="#fff" style={{ marginLeft: 6 }} />}
              </TouchableOpacity>

              {/* SeÃ§enek: Filtrelenen KiÅŸiler */}
              {filteredContacts.map(contact => {
                const isSelected = assignTarget?.uid === contact.uid;
                return (
                  <TouchableOpacity
                    key={contact.uid}
                    onPress={() => setAssignTarget(contact)}
                    activeOpacity={0.8}
                    style={[
                      styles.assignChip,
                      isSelected 
                        ? { backgroundColor: COLORS.primary, borderColor: COLORS.primary } 
                        : { backgroundColor: isDark ? '#334155' : '#fff', borderColor: isDark ? '#475569' : '#e2e8f0' }
                    ]}
                  >
                    <View style={[styles.avatarSmall, { backgroundColor: isSelected ? 'rgba(255,255,255,0.2)' : (isDark ? '#475569' : '#f1f5f9') }]}>
                      {contact.photoURL ? (
                        <Image source={{ uri: contact.photoURL }} style={styles.avatarImage} />
                      ) : (
                        <Text style={{ fontSize: 12, fontWeight: 'bold', color: isSelected ? '#fff' : currentColors.subText }}>
                          {contact.username?.[0]?.toUpperCase()}
                        </Text>
                      )}
                    </View>
                    <Text style={[styles.chipText, { color: isSelected ? '#fff' : currentColors.text }]}>
                      {contact.displayName || contact.username}
                    </Text>
                    {isSelected && <CheckCircle2 size={14} color="#fff" style={{ marginLeft: 6 }} />}
                  </TouchableOpacity>
                );
              })}
            </ScrollView>
          </View>

          {/* BÃ¶lÃ¼m: AÃ§Ä±klama */}
          <View style={{ marginBottom: 10 }}>
            <Text style={styles.sectionTitle}>{t('description')}</Text>
            <TextInput
              value={inputDesc}
              onChangeText={setInputDesc}
              placeholder="..."
              placeholderTextColor={currentColors.subText}
              style={[styles.smallInput, { backgroundColor: currentColors.bg, color: currentColors.text }]}
              onSubmitEditing={addTask}
            />
          </View>

          {/* BÃ¶lÃ¼m: Tarihler */}
          <View style={styles.dateRow}>
            {/* BaÅŸlangÄ±Ã§ Tarihi */}
            <View style={{ flex: 1 }}>
              <Text style={styles.sectionTitle}>{t('start_date')}</Text>
              <View style={styles.dateInputWrapper}>
                <TextInput
                  value={inputStartDate}
                  onChangeText={handleInputStartDateChange}
                  placeholder="DD-MM-YYYY"
                  placeholderTextColor={currentColors.subText}
                  maxLength={10}
                  keyboardType="numeric"
                  style={[styles.dateInput, { backgroundColor: currentColors.bg, color: currentColors.text }]}
                  onSubmitEditing={addTask}
                />
                <TouchableOpacity onPress={() => openDatePicker('start')} style={styles.calendarBtn}>
                  <CalendarIcon size={16} color="#fff" />
                </TouchableOpacity>
              </View>
            </View>
            
            {/* BitiÅŸ Tarihi */}
            <View style={{ flex: 1 }}>
              <Text style={styles.sectionTitle}>{t('due_date')}</Text>
              <View style={styles.dateInputWrapper}>
                <TextInput
                  value={inputDueDate}
                  onChangeText={handleInputDueDateChange}
                  placeholder="DD-MM-YYYY"
                  placeholderTextColor={currentColors.subText}
                  maxLength={10}
                  keyboardType="numeric"
                  style={[styles.dateInput, { backgroundColor: currentColors.bg, color: currentColors.text }]}
                  onSubmitEditing={addTask}
                />
                <TouchableOpacity onPress={() => openDatePicker('due')} style={styles.calendarBtn}>
                  <CalendarIcon size={16} color="#fff" />
                </TouchableOpacity>
              </View>
            </View>
          </View>

          {/* BÃ¶lÃ¼m: Kategoriler veya UyarÄ± */}
          <View style={[styles.divider, { borderColor: isDark ? '#334155' : '#f1f5f9' }]}>
            {!assignTarget ? (
              <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={{ gap: 8 }}>
                {categories.map(cat => {
                  const cc = CATEGORY_COLORS.find(c => c.id === cat.color) || CATEGORY_COLORS[0];
                  const isSelected = selectedCategory.id === cat.id;
                  return (
                    <TouchableOpacity
                      key={cat.id}
                      onPress={() => setSelectedCategory(cat)}
                      style={[
                        styles.categoryPill,
                        { 
                          borderColor: isDark ? '#334155' : '#e2e8f0',
                          backgroundColor: isSelected ? cc.hex : (isDark ? '#334155' : '#fff') 
                        },
                        isSelected && { borderColor: 'transparent' }
                      ]}
                    >
                      <View style={[styles.dot, { backgroundColor: cc.hex }]} />
                      <Text style={[styles.categoryText, { color: currentColors.text }]}>{cat.name}</Text>
                    </TouchableOpacity>
                  );
                })}
              </ScrollView>
            ) : (
              <Text style={{ fontSize: 11, color: COLORS.warning, fontStyle: 'italic' }}>
                {tFormat("task_assign_info", { name: assignTarget.username })}
              </Text>
            )}
          </View>

          {/* BÃ¶lÃ¼m: Alt Butonlar (Alarm, Bildirim, Recurring) */}
          <View style={styles.bottomActions}>
            <View style={{ flexDirection: 'row', gap: 5 }}>
              <TouchableOpacity
                onPress={() => setIsNotifOn(!isNotifOn)}
                style={[styles.iconToggle, isNotifOn && styles.iconToggleActiveBlue]}
              >
                <Bell size={16} color={isNotifOn ? '#3b82f6' : currentColors.subText} />
              </TouchableOpacity>
              
              <TouchableOpacity
                onPress={() => setIsAlarmOn(!isAlarmOn)}
                style={[styles.iconToggle, isAlarmOn && styles.iconToggleActiveRed]}
              >
                <AlarmClock size={16} color={isAlarmOn ? '#ef4444' : currentColors.subText} />
              </TouchableOpacity>

              {inputDueDate && (
                <TouchableOpacity
                  onPress={() => setIsEveryDayOn(!isEveryDayOn)}
                  style={[styles.iconToggle, isEveryDayOn && styles.iconToggleActiveGreen, { width: 'auto', paddingHorizontal: 8, gap: 5 }]}
                >
                  <CalendarDays size={16} color={isEveryDayOn ? '#10b981' : currentColors.subText} />
                  <Text style={{ fontSize: 10, fontWeight: 'bold', color: isEveryDayOn ? '#10b981' : currentColors.subText }}>
                    {t('every_day')}
                  </Text>
                </TouchableOpacity>
              )}
            </View>

            <View style={{ flexDirection: 'row', gap: 5 }}>
              {isNotifOn && (
                <TextInput
                  value={notifInput}
                  onChangeText={handleNotifInputChange}
                  placeholder="09:00"
                  placeholderTextColor="#94a3b8"
                  style={[styles.timeInput, { color: COLORS.primary, borderColor: COLORS.primary }]}
                  maxLength={5}
                  onSubmitEditing={addTask}
                />
              )}
              {isAlarmOn && (
                <TextInput
                  value={alarmInput}
                  onChangeText={handleAlarmInputChange}
                  placeholder="07:00"
                  placeholderTextColor="#94a3b8"
                  style={[styles.timeInput, { color: COLORS.danger, borderColor: COLORS.danger }]}
                  maxLength={5}
                  onSubmitEditing={addTask}
                />
              )}
            </View>
          </View>
        </View>
      )}

      {/* 2. ANA INPUT SATIRI */}
      <View style={styles.mainInputRow}>
        <TouchableOpacity
          onPress={() => {
            LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
            setIsInputExpanded(!isInputExpanded);
          }}
          style={styles.expandBtn}
        >
          {isInputExpanded ? <X size={20} color={currentColors.subText} /> : <Sliders size={20} color={currentColors.subText} />}
        </TouchableOpacity>
        
        <TextInput
          value={inputValue}
          onChangeText={setInputValue}
          placeholder={t('addTask')}
          placeholderTextColor={currentColors.subText}
          style={[styles.mainTextInput, { color: currentColors.text }]}
          onSubmitEditing={addTask}
        />
        
        <TouchableOpacity
          onPress={addTask}
          style={[
            styles.sendBtn,
            { 
              backgroundColor: inputValue.trim() ? (assignTarget ? COLORS.warning : COLORS.primary) : (isDark ? '#334155' : '#e2e8f0') 
            }
          ]}
        >
          <Plus size={24} color={inputValue.trim() ? '#fff' : '#94a3b8'} />
        </TouchableOpacity>
      </View>

    </BlurView>
  </>
)}
       {/* ================================================================================= */}
        {/* 7. TOAST BÄ°LDÄ°RÄ°MLER */}
        {/* ================================================================================= */}
        {customToast.visible && (() => {
          // Toast Tiplerine GÃ¶re Ayarlar (Renkler ve Ä°konlar)
          const TOAST_CONFIG = {
            success: { bg: '#ecfdf5', border: '#10b981', iconBg: '#10b981', Icon: Check },
            error:   { bg: '#fef2f2', border: '#ef4444', iconBg: '#ef4444', Icon: X },
            warning: { bg: '#fffbeb', border: '#f59e0b', iconBg: '#f59e0b', Icon: AlertCircle },
            info:    { bg: '#f0f9ff', border: '#0ea5e9', iconBg: '#0ea5e9', Icon: Bell },
          };

          // GeÃ§erli ayarÄ± seÃ§ (yoksa varsayÄ±lan olarak info kullan)
          const currentToast = TOAST_CONFIG[customToast.type] || TOAST_CONFIG.info;
          const ToastIcon = currentToast.Icon;

          return (
            <View style={[styles.toastContainer, { backgroundColor: currentToast.bg, borderColor: currentToast.border }]}>
              
              {/* Sol Ä°kon */}
              <View style={[styles.toastIconBox, { backgroundColor: currentToast.iconBg }]}>
                <ToastIcon size={20} color="#fff" strokeWidth={2.5} />
              </View>

              {/* Metin Ä°Ã§eriÄŸi */}
              <View style={{ flex: 1 }}>
                <Text style={styles.toastTitle}>{customToast.title}</Text>
                <Text style={styles.toastMessage} numberOfLines={2}>{customToast.message}</Text>
              </View>

              {/* Kapat Butonu */}
              <TouchableOpacity 
                onPress={() => setCustomToast({ ...customToast, visible: false })}
                style={styles.toastCloseBtn}
                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }} // TÄ±klama alanÄ±nÄ± geniÅŸletir
              >
                <X size={18} color="#64748b" />
              </TouchableOpacity>
            </View>
          );
        })()}

       {/* ================================================================================= */}
{/* 8. MODALLAR (Modernize EdilmiÅŸ) */}
{/* ================================================================================= */}

{/* A. ALIÅžKANLIK EKLEME MODALI */}
<Modal visible={isAddModalOpen} transparent animationType="slide" statusBarTranslucent>
  <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={styles.modalOverlay}>
    <TouchableWithoutFeedback onPress={() => { setIsAddModalOpen(false); Keyboard.dismiss(); }}>
      <View style={styles.modalBackdrop} />
    </TouchableWithoutFeedback>
    
    <View style={styles.bottomSheetCard}>
      <View style={styles.modalHeader}>
        <Text style={styles.modalTitle}>{t('new_habit')}</Text>
        <TouchableOpacity onPress={() => setIsAddModalOpen(false)} style={styles.closeBtn}>
          <X size={24} color={currentColors.text} />
        </TouchableOpacity>
      </View>

      <View style={styles.formGap}>
        {/* Ä°sim */}
        <TextInput 
          placeholder={t('habit_name')} 
          placeholderTextColor={currentColors.subText} 
          value={newHabitTitle} 
          onChangeText={setNewHabitTitle} 
          style={styles.inputField} 
        />

        {/* SÄ±klÄ±k (HaftalÄ±k/GÃ¼nlÃ¼k) */}
        <View style={styles.freqRow}>
          {(['daily', 'weekly'] as const).map((freq) => (
            <TouchableOpacity 
              key={freq}
              onPress={() => setNewHabitFreq(freq)} 
              style={[styles.freqPill, newHabitFreq === freq && styles.freqPillActive]}
            >
              <Text style={[styles.freqText, newHabitFreq === freq && styles.freqTextActive]}>
                {t(freq)}
              </Text>
            </TouchableOpacity>
          ))}
        </View>

        {/* GÃ¼n SeÃ§imi (Sadece Weekly ise) */}
        {newHabitFreq === 'weekly' && (
          <View style={styles.daysWrapper}>
            <Text style={styles.sectionLabel}>{t('which_days')}</Text>
            <View style={styles.daysContainer}>
              {getDaysOfWeek(lang).map((dayObj) => {
                const isSelected = newHabitDays.includes(dayObj.id);
                return (
                  <TouchableOpacity 
                    key={dayObj.id} 
                    onPress={() => toggleHabitDay(dayObj.id)} 
                    style={[styles.dayCircle, isSelected && styles.dayCircleActive]}
                  >
                    <Text style={[styles.dayText, isSelected && styles.dayTextActive]}>
                      {dayObj.label.substring(0, 2)}
                    </Text>
                  </TouchableOpacity>
                );
              })}
            </View>
          </View>
        )}

        {/* Bildirim Saati */}
        <View>
           <Text style={styles.sectionLabel}>{t('time_placeholder')}</Text>
           <TextInput 
            placeholder="09:00" 
            placeholderTextColor={currentColors.subText} 
            value={habitNotifInput} 
            onChangeText={(t) => setHabitNotifInput(maskTimeInput(t))} 
            style={styles.inputField} 
            maxLength={5} 
            keyboardType="numeric" 
          />
        </View>

        {/* Kategori SeÃ§imi */}
        <View>
          <Text style={styles.sectionLabel}>{t('category')}</Text>
          <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={{ gap: 8 }}>
            {categories.map(c => (
              <TouchableOpacity 
                key={c.id} 
                onPress={() => setSelectedCategory(c)} 
                style={[
                  styles.categoryTag, 
                  selectedCategory.id === c.id && { backgroundColor: COLORS.secondary, borderColor: COLORS.secondary }
                ]}
              >
                <Text style={{ color: selectedCategory.id === c.id ? '#fff' : currentColors.text, fontSize: 12, fontWeight: '600' }}>
                  {c.name}
                </Text>
              </TouchableOpacity>
            ))}
          </ScrollView>
        </View>

        <TouchableOpacity onPress={addHabit} style={styles.primaryButton}>
          <Text style={styles.primaryButtonText}>{t('start_habit')}</Text>
        </TouchableOpacity>
      </View>
    </View>
  </KeyboardAvoidingView>
</Modal>

{/* B. MÄ°SAFÄ°R DÃ–NÃœÅžÃœM MODALI */}
<Modal visible={isGuestModalOpen} transparent animationType="fade">
  <TouchableWithoutFeedback onPress={Keyboard.dismiss}>
    <View style={styles.centerModalOverlay}>
      <View style={styles.centerCard}>
        <View style={styles.modalHeader}>
          <Text style={styles.modalTitle}>{t('create_ac')}</Text>
          <TouchableOpacity onPress={() => setIsGuestModalOpen(false)}><X size={24} color={currentColors.subText} /></TouchableOpacity>
        </View>
        <Text style={styles.modalSubtitle}>{t('protect_data_msg')}</Text>
        
        <View style={styles.formGap}>
          <View style={styles.iconInputRow}>
            <User size={20} color={currentColors.subText} />
            <TextInput value={username} onChangeText={setUsername} placeholder={t('social_search_tab_username')} placeholderTextColor={currentColors.subText} style={styles.flexInput} autoCapitalize='none' />
          </View>
          <View style={styles.iconInputRow}>
            <Mail size={20} color={currentColors.subText} />
            <TextInput value={email} onChangeText={setEmail} placeholder="E-posta" placeholderTextColor={currentColors.subText} style={styles.flexInput} autoCapitalize='none' keyboardType="email-address" />
          </View>
          <View style={styles.iconInputRow}>
            <Lock size={20} color={currentColors.subText} />
            <TextInput value={password} onChangeText={setPassword} placeholder={t('auth_password_placeholder')} placeholderTextColor={currentColors.subText} style={styles.flexInput} secureTextEntry />
          </View>
          
          <TouchableOpacity onPress={handleConvertGuest} style={styles.primaryButton}>
            {isAuthLoading ? <ActivityIndicator color="#fff" /> : <Text style={styles.primaryButtonText}>{t('complete_profile')}</Text>}
          </TouchableOpacity>
        </View>
      </View>
    </View>
  </TouchableWithoutFeedback>
</Modal>

{/* C. TARÄ°H SEÃ‡Ä°CÄ°LER (Date Pickers) */}
{/* 1. Genel Date Picker */}
{showDatePicker && (
  Platform.OS === 'android' ? (
    <DateTimePicker value={selectedDate || new Date()} mode="date" display="default" onChange={onDateChange} />
  ) : (
    <Modal transparent visible={true} animationType="fade">
      <TouchableOpacity activeOpacity={1} onPress={() => setShowDatePicker(false)} style={styles.centerModalOverlay}>
        <View style={[styles.centerCard, { width: 340, padding: 0 }]}>
          <View style={{ padding: 20, borderBottomWidth: 1, borderColor: isDark ? '#334155' : '#f1f5f9', flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }}>
             <Text style={styles.modalTitle}>Tarih SeÃ§</Text>
             <TouchableOpacity onPress={() => setShowDatePicker(false)}><X size={24} color={currentColors.subText} /></TouchableOpacity>
          </View>
          <View style={{ padding: 10 }}>
            <Calendar 
              current={selectedStr} 
              key={`${lang}-${selectedStr}`} 
              onDayPress={(day) => { 
                const newDate = new Date(day.timestamp); 
                newDate.setMinutes(newDate.getMinutes() + newDate.getTimezoneOffset()); 
                onDateChange(null, newDate); 
              }} 
              theme={{
                backgroundColor: 'transparent', 
                calendarBackground: 'transparent', 
                textSectionTitleColor: currentColors.subText, 
                selectedDayBackgroundColor: COLORS.primary, 
                selectedDayTextColor: '#ffffff', 
                todayTextColor: COLORS.primary, 
                dayTextColor: currentColors.text, 
                arrowColor: COLORS.primary, 
                monthTextColor: currentColors.text,
                textDayFontWeight: '600',
                textMonthFontWeight: 'bold'
              }} 
              markingType={'custom'}
              markedDates={calendarMarks}
            />
          </View>
        </View>
      </TouchableOpacity>
    </Modal>
  )
)}

{/* 2. iOS Detail & Habit Date Pickers (Inline Wrapper) */}
{(showDetailDatePicker || (showHabitDatePicker && Platform.OS === 'ios')) && Platform.OS === 'ios' && (
  <Modal transparent visible={true} animationType="slide">
    <View style={styles.modalOverlay}>
      <TouchableOpacity style={styles.modalBackdrop} onPress={() => { setShowDetailDatePicker(false); setShowHabitDatePicker(false); }} />
      <View style={styles.bottomSheetCard}>
        <View style={styles.modalHeader}>
          <TouchableOpacity onPress={() => { setShowDetailDatePicker(false); setShowHabitDatePicker(false); }}>
            <Text style={{ color: COLORS.danger, fontSize: 16 }}>{t('cancel')}</Text>
          </TouchableOpacity>
          <TouchableOpacity onPress={() => { setShowDetailDatePicker(false); setShowHabitDatePicker(false); }}>
            <Text style={{ color: COLORS.primary, fontWeight: 'bold', fontSize: 16 }}>{t('ok_btn')}</Text>
          </TouchableOpacity>
        </View>
        <DateTimePicker 
          value={new Date()} 
          mode="date" 
          display="inline" 
          onChange={showDetailDatePicker ? onDetailDateChange : onHabitDateChange} 
          style={{ height: 320 }}
        />
      </View>
    </View>
  </Modal>
)}
{/* Android Habit Picker */}
{showHabitDatePicker && Platform.OS === 'android' && (
  <DateTimePicker value={new Date()} mode="date" display="default" onChange={onHabitDateChange} />
)}

{/* D. GÃ–REV DETAY MODALI */}
<Modal visible={!!selectedTask} animationType="slide" presentationStyle="pageSheet">
  <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : undefined} style={{ flex: 1, backgroundColor: currentColors.bg }}>
    <View style={{ flex: 1, padding: 20 }}>
      {/* Header */}
      <View style={styles.modalHeader}>
        <Text style={styles.modalTitle}>{t('task_detail_title')}</Text>
        <TouchableOpacity onPress={() => setSelectedTask(null)}>
          <Text style={{ color: COLORS.primary, fontWeight: 'bold', fontSize: 16 }}>{t('close_btn')}</Text>
        </TouchableOpacity>
      </View>

      {/* Segmented Control (Tabs) */}
      <View style={styles.segmentedControl}>
        <TouchableOpacity 
          onPress={() => setTaskModalTab('details')} 
          style={[styles.segmentBtn, taskModalTab === 'details' && styles.segmentBtnActive]}
        >
          <Text style={{ fontWeight: '600', color: taskModalTab === 'details' ? currentColors.text : currentColors.subText }}>
            {t('edit_label')}
          </Text>
        </TouchableOpacity>
        <TouchableOpacity 
          onPress={() => setTaskModalTab('chat')} 
          style={[styles.segmentBtn, taskModalTab === 'chat' && styles.segmentBtnActive]}
        >
          <Text style={{ fontWeight: '600', color: taskModalTab === 'chat' ? currentColors.text : currentColors.subText }}>
            {t('messaging_title')}
          </Text>
        </TouchableOpacity>
      </View>

      {/* Content */}
      <View style={{ flex: 1, marginTop: 15 }}>
        {taskModalTab === 'details' ? (
          <ScrollView showsVerticalScrollIndicator={false} contentContainerStyle={{ gap: 20 }}>
            <View>
              <Text style={styles.sectionLabel}>{t('title_label')}</Text>
              <TextInput value={detailText} onChangeText={setDetailText} multiline style={[styles.inputField, { height: 'auto', minHeight: 60, paddingTop: 12 }]} />
            </View>
            <View>
              <Text style={styles.sectionLabel}>{t('description_label')}</Text>
              <TextInput value={detailDesc} onChangeText={setDetailDesc} multiline numberOfLines={4} placeholder={t('add_note_placeholder')} placeholderTextColor={currentColors.subText} style={[styles.inputField, { height: 120, textAlignVertical: 'top', paddingTop: 12 }]} />
            </View>
            <View>
              <Text style={styles.sectionLabel}>{t('due_date_label')}</Text>
              <View style={{ flexDirection: 'row' }}>
                <TextInput value={detailDueDate} onChangeText={handleDetailDueDateChange} placeholder="dd-mm-yyyy" placeholderTextColor={currentColors.subText} maxLength={10} keyboardType="numeric" style={[styles.inputField, { borderTopRightRadius: 0, borderBottomRightRadius: 0, flex: 1 }]} />
                <TouchableOpacity onPress={() => openDatePicker('detail')} style={styles.inputAppendBtn}>
                  <CalendarIcon size={22} color="#fff" />
                </TouchableOpacity>
              </View>
            </View>
            <TouchableOpacity onPress={saveTaskDetail} style={styles.primaryButton}>
              <Text style={styles.primaryButtonText}>{t('save')}</Text>
            </TouchableOpacity>
          </ScrollView>
        ) : (
          <View style={{ flex: 1, backgroundColor: currentColors.surface, borderRadius: 16 }}>
            <FlatList 
              data={taskComments} 
              keyExtractor={item => item.id} 
              contentContainerStyle={{ padding: 15, paddingBottom: 60 }} 
              renderItem={({ item }) => { 
                const isMe = item.senderId === user.uid; 
                return (
                  <View style={{ flexDirection: 'row', marginBottom: 15, justifyContent: isMe ? 'flex-end' : 'flex-start' }}>
                    {!isMe && <View style={styles.chatAvatar}><Text style={{ fontSize: 10, fontWeight: 'bold', color: '#fff' }}>{item.senderName?.[0]}</Text></View>}
                    <View style={{ maxWidth: '80%' }}>
                      <View style={[styles.chatBubble, isMe ? styles.chatBubbleMe : styles.chatBubbleOther]}>
                        <Text style={{ color: isMe ? '#fff' : currentColors.text }}>{item.text}</Text>
                      </View>
                      <Text style={{ fontSize: 9, color: currentColors.subText, marginTop: 2, textAlign: isMe ? 'right' : 'left' }}>{item.senderName}</Text>
                    </View>
                  </View>
                ); 
              }} 
              ListEmptyComponent={<View style={{ alignItems: 'center', marginTop: 50, opacity: 0.5 }}><MessageCircle size={40} color={currentColors.subText} /><Text style={{ color: currentColors.subText, marginTop: 10 }}>{t('no_comments_yet')}</Text></View>} 
            />
            <View style={styles.chatInputBar}>
              <TextInput value={taskCommentInput} onChangeText={setTaskCommentInput} placeholder={t('add_comment_placeholder')} placeholderTextColor={currentColors.subText} style={styles.chatInput} />
              <TouchableOpacity onPress={sendTaskComment} disabled={!taskCommentInput.trim()} style={[styles.chatSendBtn, { backgroundColor: taskCommentInput.trim() ? COLORS.primary : '#ccc' }]}>
                <Send size={18} color="#fff" />
              </TouchableOpacity>
            </View>
          </View>
        )}
      </View>
    </View>
  </KeyboardAvoidingView>
</Modal>

{/* E. KATEGORÄ° MODALI */}
<Modal visible={isCategoryModalOpen} transparent animationType="fade">
  <TouchableOpacity activeOpacity={1} onPress={() => { setIsCategoryModalOpen(false); Keyboard.dismiss(); }} style={styles.centerModalOverlay}>
    <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={{ width: '100%', alignItems: 'center' }}>
      <TouchableWithoutFeedback>
        <View style={[styles.centerCard, { height: '80%', maxHeight: 600 }]}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>{t('categories_title')}</Text>
            <TouchableOpacity onPress={() => setIsCategoryModalOpen(false)}><X size={24} color={currentColors.subText} /></TouchableOpacity>
          </View>
          
          <ScrollView style={{ flex: 1, marginBottom: 15 }} showsVerticalScrollIndicator={false}>
            {categories.map((cat) => (
              <View key={cat.id} style={styles.categoryListItem}>
                <View style={{ flexDirection: 'row', alignItems: 'center', gap: 12 }}>
                  <View style={[styles.colorDot, { backgroundColor: CATEGORY_COLORS.find(c => c.id === cat.color)?.hex || 'gray' }]} />
                  <Text style={{ fontSize: 16, fontWeight: '600', color: currentColors.text }}>{cat.name}</Text>
                </View>
                <TouchableOpacity onPress={() => handleDeleteCategory(cat.id)} style={styles.deleteIconBtn}>
                  <Trash2 size={18} color={COLORS.danger} />
                </TouchableOpacity>
              </View>
            ))}
          </ScrollView>

          <View style={{ paddingTop: 15, borderTopWidth: 1, borderColor: isDark ? '#334155' : '#f1f5f9' }}>
            <Text style={styles.sectionLabel}>{t('create_new_category')}</Text>
            <TextInput value={newCategoryName} onChangeText={setNewCategoryName} placeholder={t('category_name_placeholder')} placeholderTextColor={currentColors.subText} style={[styles.inputField, { marginBottom: 15 }]} />
            
            <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={{ gap: 10, paddingBottom: 15 }}>
              {CATEGORY_PALETTE.map(colorName => { 
                const colorHex = CATEGORY_COLORS.find(c => c.id === colorName)?.hex || '#000'; 
                const isSelected = newCategoryColor === colorName; 
                return (
                  <TouchableOpacity key={colorName} onPress={() => setNewCategoryColor(colorName)} style={[styles.colorCircle, { backgroundColor: colorHex }, isSelected && styles.colorCircleSelected]}>
                    {isSelected && <Check size={18} color="#fff" strokeWidth={3} />}
                  </TouchableOpacity>
                ) 
              })}
            </ScrollView>

            <TouchableOpacity onPress={handleAddCategory} disabled={!newCategoryName.trim()} style={[styles.primaryButton, !newCategoryName.trim() && { backgroundColor: '#94a3b8' }]}>
              <Plus size={20} color="#fff" strokeWidth={3} />
              <Text style={styles.primaryButtonText}>{t('create_new_category')}</Text>
            </TouchableOpacity>
          </View>
        </View>
      </TouchableWithoutFeedback>
    </KeyboardAvoidingView>
  </TouchableOpacity>
</Modal>

{/* F. PREMIUM & UPSELL & ADS */}
<Modal visible={isAdVisible} transparent animationType="fade">
  <View style={styles.fullScreenOverlay}>
    <View style={styles.adCard}>
      <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%', marginBottom: 10 }}>
        <Text style={styles.adBadge}>{t('ad_label_full')}</Text>
      </View>
      <View style={styles.adContentPlaceholder}>
        <Text style={{ color: '#666' }}>Google Ads Component</Text>
      </View>
      <TouchableOpacity disabled={adCountdown > 0} onPress={() => { setIsAdVisible(false); setIsUpsellVisible(true); }} style={styles.adCloseBtn}>
        <Text style={{ color: '#000', fontWeight: 'bold' }}>{adCountdown > 0 ? `${t('ad_skip')} ${adCountdown}` : `${t('ad_close')} âœ•`}</Text>
      </TouchableOpacity>
    </View>
  </View>
</Modal>

<Modal visible={isUpsellVisible} transparent animationType="slide">
  <View style={styles.centerModalOverlay}>
    <View style={styles.centerCard}>
      <View style={{ alignItems: 'center', marginBottom: 20 }}>
        <View style={styles.upsellIconCircle}><Trophy size={40} color="#d97706" fill="#d97706" /></View>
        <Text style={styles.upsellTitle}>{t('premium_unlock')}</Text>
        <Text style={styles.upsellSubtitle}>{t('premium_subtitle')}</Text>
      </View>
      
      <View style={{ gap: 12, marginBottom: 25 }}>
        {[t('premium_feat_ads'), t('premium_feat_habits'), t('premium_feat_stats'), t('premium_feat_themes')].map((feat, i) => (
          <View key={i} style={{ flexDirection: 'row', alignItems: 'center', gap: 10 }}>
             <View style={styles.checkCircleSmall}><Check size={12} color="#fff" strokeWidth={3} /></View>
             <Text style={{ color: currentColors.text, fontSize: 14 }}>{feat}</Text>
          </View>
        ))}
      </View>

      <TouchableOpacity onPress={async () => { if (user) { await setDoc(doc(db, "users", user.uid), { isPremium: true }, { merge: true }); setIsUpsellVisible(false); } }} style={styles.primaryButton}>
        <View style={{ alignItems: 'center' }}>
          <Text style={styles.primaryButtonText}>{t('premium_cta')}</Text>
          <Text style={{ color: 'rgba(255,255,255,0.8)', fontSize: 10 }}>{t('premium_price')}</Text>
        </View>
      </TouchableOpacity>
      <TouchableOpacity onPress={() => setIsUpsellVisible(false)} style={{ padding: 15, alignItems: 'center' }}>
        <Text style={{ color: currentColors.subText, fontSize: 13, fontWeight: '600' }}>{t('keep_ads')}</Text>
      </TouchableOpacity>
    </View>
  </View>
</Modal>

{/* G. DÄ°ÄžER KÃœÃ‡ÃœK MODALLAR (Onboarding, Language, Confirm vb.) */}
{/* ONBOARDING */}
<Modal visible={showOnboarding} animationType="fade">
  <View style={styles.onboardingContainer}>
    <View style={{ alignItems: 'center', gap: 20, paddingHorizontal: 20 }}>
      <View style={styles.onboardingIconCircle}>
        {onboardingStep === 0 ? <ListTodo size={60} color="#fff" /> : (onboardingStep === 1 ? <Repeat size={60} color="#fff" /> : <Users size={60} color="#fff" />)}
      </View>
      <Text style={styles.onboardingTitle}>
        {onboardingStep === 0 ? t('welcome') : (onboardingStep === 1 ? t('onboard_step2_title') : t('onboard_step3_title'))}
      </Text>
      <Text style={styles.onboardingDesc}>
        {onboardingStep === 0 ? t('onboard_step1_desc') : (onboardingStep === 1 ? t('onboard_step2_desc') : t('onboard_step3_desc'))}
      </Text>
    </View>
    <View style={styles.onboardingFooter}>
      <View style={{ flexDirection: 'row', gap: 6 }}>
        {[0, 1, 2].map(i => <View key={i} style={{ width: 8, height: 8, borderRadius: 4, backgroundColor: i === onboardingStep ? '#fff' : 'rgba(255,255,255,0.3)' }} />)}
      </View>
      <TouchableOpacity onPress={async () => { if (onboardingStep < 2) { setOnboardingStep(onboardingStep + 1); } else { setShowOnboarding(false); if (user) await updateDoc(doc(db, "users", user.uid), { hasSeenOnboarding: true }); } }} style={styles.onboardingBtn}>
        <Text style={{ color: COLORS.primary, fontWeight: 'bold' }}>{onboardingStep === 2 ? t('start_btn') : t('next_btn')}</Text>
      </TouchableOpacity>
    </View>
  </View>
</Modal>

{/* CONFIRM (Onay) */}
<Modal visible={confirmModal.visible} transparent animationType="fade">
  <View style={styles.centerModalOverlay}>
    <View style={[styles.centerCard, { maxWidth: 320 }]}>
      <Text style={styles.modalTitle}>{confirmModal.title}</Text>
      <Text style={[styles.modalSubtitle, { textAlign: 'center' }]}>{confirmModal.message}</Text>
      <View style={{ flexDirection: 'row', gap: 10, marginTop: 10 }}>
        <TouchableOpacity onPress={() => setConfirmModal(prev => ({ ...prev, visible: false }))} style={styles.cancelButton}>
          <Text style={{ color: currentColors.text, fontWeight: '600' }}>{t('cancel_btn')}</Text>
        </TouchableOpacity>
        <TouchableOpacity 
          onPress={() => { confirmModal.onConfirm(); setConfirmModal(prev => ({ ...prev, visible: false })); }} 
          style={[styles.confirmButton, { backgroundColor: confirmModal.isDestructive ? COLORS.danger : COLORS.primary }]}
        >
          <Text style={{ color: '#fff', fontWeight: 'bold' }}>{confirmModal.isDestructive ? t('delete') : t('confirm_btn')}</Text>
        </TouchableOpacity>
      </View>
    </View>
  </View>
</Modal>
      </SafeAreaView>
    </KeyboardAvoidingView>
  );
}

// --- OmmioApp FONKSÄ°YONUNUN DIÅžINA, EN ALTA ---

// --- TÄ°P TANIMLAMASI ---
interface MessageItemProps {
    msg: any;          // DetaylÄ± tipiniz varsa ChatMessage kullanÄ±n, yoksa any
    user: any;         // User tipi
    chatTarget: any;   // Contact tipi
    currentColors: any;
    isDark: boolean;
}

// --- GÃœNCELLENMÄ°Åž MessageItem ---
// --- GÃœNCELLENMÄ°Åž MessageItem (DosyanÄ±n en altÄ±na yapÄ±ÅŸtÄ±rÄ±n) ---
const MessageItem = ({ msg, user, chatTarget, currentColors, isDark }: MessageItemProps) => {
    const [decryptedText, setDecryptedText] = useState(msg.text); 
    const isMe = msg.senderId === user.uid;

    useEffect(() => {
        const decrypt = async () => {
            // 1. DÃ¼z metin kontrolÃ¼
            if (!msg.text || !msg.text.startsWith('{')) {
                setDecryptedText(msg.text);
                return;
            }

            // 2. Åžifre Ã‡Ã¶zme
            if (isMe) {
                // Kendi mesajÄ±m: senderCopy alanÄ±nÄ± Ã§Ã¶z
                if (msg.senderCopy && msg.senderCopy.startsWith('{')) {
                    const myKey = user.publicKey; 
                    if (myKey) {
                        try {
                            const text = await decryptMessage(msg.senderCopy, myKey);
                            setDecryptedText(text);
                        } catch (e) {
                            setDecryptedText("âš ï¸ Ã‡Ã¶zÃ¼lemedi");
                        }
                    } else {
                        setDecryptedText("Anahtar bulunamadÄ±...");
                    }
                } else {
                    // EÄŸer senderCopy yoksa veya ÅŸifreli deÄŸilse
                    setDecryptedText(msg.senderCopy || "ðŸ”’ (KopyanÄ±z yok)");
                }
            } else {
                // Gelen mesaj: KarÅŸÄ± tarafÄ±n Public Key'ini kullan
                // HATA Ã‡Ã–ZÃœMÃœ: chatTarget?.publicKey ile null kontrolÃ¼ yapÄ±yoruz
                let senderKey = chatTarget?.publicKey;
                
                if (senderKey) {
                    try {
                        const text = await decryptMessage(msg.text, senderKey);
                        setDecryptedText(text);
                    } catch (e) {
                        setDecryptedText("âš ï¸ Mesaj Ã§Ã¶zÃ¼lemedi");
                    }
                } else {
                    setDecryptedText("ðŸ”’ Anahtar bekleniyor...");
                }
            }
        };
        decrypt();
        // Dependency array'e chatTarget?.publicKey ekledik
    }, [msg.text, msg.senderCopy, isMe, user.publicKey, chatTarget?.publicKey]); 

    const timeString = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

    return (
        <View style={{ alignSelf: isMe ? 'flex-end' : 'flex-start', marginBottom: 8, maxWidth: '75%' }}>
            <View style={{
                backgroundColor: isMe ? COLORS.primary : (isDark ? '#334155' : '#fff'),
                borderRadius: 12, borderBottomRightRadius: isMe ? 2 : 12, borderBottomLeftRadius: isMe ? 12 : 2,
                padding: 8, paddingHorizontal: 12,
                shadowColor: "#000", shadowOpacity: 0.05, shadowRadius: 2, elevation: 1
            }}>
                <Text style={{ color: isMe ? '#fff' : currentColors.text, fontSize: 15 }}>
                    {decryptedText}
                </Text>
                <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'flex-end', marginTop: 2, gap: 4 }}>
                    <Text style={{ fontSize: 9, color: isMe ? 'rgba(255,255,255,0.7)' : currentColors.subText }}>{timeString}</Text>
                    {isMe && (
                        msg.read ? <CheckCheck size={14} color="#a5f3fc" /> : <CheckCheck size={14} color="rgba(255,255,255,0.6)" />
                    )}
                </View>
            </View>
        </View>
    );
};

const premiumStyles = StyleSheet.create({
  
  overlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.85)', // ArkasÄ± hafif karartÄ±lmÄ±ÅŸ
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20
  },
  adContainer: {
    width: '100%',
    maxWidth: 400, // Web'de Ã§ok geniÅŸlemesin
    height: '60%', // EkranÄ±n %60'Ä±nÄ± kaplasÄ±n
    backgroundColor: '#000',
    borderRadius: 16,
    padding: 15,
    alignItems: 'center',
    justifyContent: 'space-between'
  },
  closeAdButton: {
    width: '100%',
    padding: 15,
    borderRadius: 12,
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 15
  },
  card: {
    width: '100%',
    maxWidth: 380, // Web'de kart gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in sÄ±nÄ±r
    borderRadius: 32, // Modern yuvarlak kÃ¶ÅŸeler
    padding: 30,
    alignItems: 'center',
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 10 },
    shadowOpacity: 0.25,
    shadowRadius: 20,
    elevation: 10,
  },
  headerSection: {
    alignItems: 'center',
    marginBottom: 25
  },
  iconCircle: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: '#fffbeb', // AÃ§Ä±k amber rengi
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 15,
    borderWidth: 1,
    borderColor: '#fcd34d'
  },
  title: {
    fontSize: 24,
    fontWeight: '900',
    textAlign: 'center',
    marginBottom: 8
  },
  subtitle: {
    fontSize: 14,
    textAlign: 'center',
    paddingHorizontal: 10,
    lineHeight: 20
  },
  featuresList: {
    width: '100%',
    marginBottom: 20
  },
  featureItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 12,
    gap: 12
  },
  checkCircle: {
    width: 20,
    height: 20,
    borderRadius: 10,
    backgroundColor: '#10b981', // YeÅŸil tik
    alignItems: 'center',
    justifyContent: 'center'
  },
  featureText: {
    fontSize: 15,
    fontWeight: '500'
  },
  ctaButton: {
    backgroundColor: '#d97706', // Amber-600
    paddingVertical: 16,
    borderRadius: 16,
    alignItems: 'center',
    shadowColor: '#d97706',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.4,
    shadowRadius: 8,
    elevation: 5
  },
  ctaText: {
    color: '#fff',
    fontSize: 18,
    fontWeight: 'bold'
  },
  ctaSubText: {
    color: 'rgba(255,255,255,0.8)',
    fontSize: 12,
    marginTop: 2
  },
  secondaryButton: {
    padding: 10,
    alignItems: 'center'
  }
});
const getDynamicStyles = (currentColors: any, isDark: boolean) => StyleSheet.create({
  closeBtn: {
    padding: 8,
    backgroundColor: isDark ? '#334155' : '#f1f5f9', // Hafif bir arka plan
    borderRadius: 20, // Yuvarlak buton gÃ¶rÃ¼nÃ¼mÃ¼
    alignItems: 'center',
    justifyContent: 'center',
  },
  // --- MODAL & SHEET STYLES ---
  modalOverlay: {
    flex: 1,
    justifyContent: 'flex-end',
    backgroundColor: 'rgba(0,0,0,0.5)',
  },
  modalBackdrop: {
    flex: 1,
  },
  bottomSheetCard: {
    backgroundColor: currentColors.bg,
    borderTopLeftRadius: 24,
    borderTopRightRadius: 24,
    padding: 24,
    minHeight: 400,
    shadowColor: "#000",
    shadowOffset: { width: 0, height: -5 },
    shadowOpacity: 0.1,
    shadowRadius: 10,
    elevation: 20,
  },
  centerModalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.6)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  centerCard: {
    backgroundColor: currentColors.surface,
    borderRadius: 24,
    padding: 24,
    width: '100%',
    maxWidth: 400,
    shadowColor: "#000",
    shadowOpacity: 0.25,
    shadowRadius: 10,
    elevation: 10,
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: currentColors.text,
  },
  modalSubtitle: {
    color: currentColors.subText,
    marginBottom: 20,
    lineHeight: 20,
  },
  
  // FORM ELEMENTS
  formGap: {
    gap: 16,
  },
  inputField: {
    backgroundColor: isDark ? '#1e293b' : '#f8fafc',
    color: currentColors.text,
    padding: 14,
    borderRadius: 12,
    fontSize: 15,
    borderWidth: 1,
    borderColor: isDark ? '#334155' : '#e2e8f0',
  },
  inputAppendBtn: {
    backgroundColor: COLORS.primary,
    paddingHorizontal: 15,
    borderTopRightRadius: 12,
    borderBottomRightRadius: 12,
    justifyContent: 'center',
    alignItems: 'center',
  },
  iconInputRow: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: isDark ? '#1e293b' : '#f8fafc',
    borderWidth: 1,
    borderColor: isDark ? '#334155' : '#e2e8f0',
    borderRadius: 12,
    paddingHorizontal: 15,
    gap: 10,
  },
  flexInput: {
    flex: 1,
    paddingVertical: 14,
    color: currentColors.text,
    fontSize: 15,
  },
  primaryButton: {
    backgroundColor: COLORS.primary,
    padding: 16,
    borderRadius: 14,
    alignItems: 'center',
    justifyContent: 'center',
    shadowColor: COLORS.primary,
    shadowOpacity: 0.3,
    shadowRadius: 5,
    elevation: 4,
    flexDirection: 'row',
    gap: 8,
  },
  primaryButtonText: {
    color: '#fff',
    fontWeight: 'bold',
    fontSize: 16,
  },

  // HABIT & FREQUENCY
  freqRow: {
    flexDirection: 'row',
    gap: 10,
  },
  freqPill: {
    flex: 1,
    paddingVertical: 10,
    alignItems: 'center',
    borderRadius: 10,
    backgroundColor: isDark ? '#334155' : '#f1f5f9',
    borderWidth: 1,
    borderColor: isDark ? '#475569' : '#e2e8f0',
  },
  freqPillActive: {
    backgroundColor: COLORS.primary,
    borderColor: COLORS.primary,
  },
  freqText: {
    fontWeight: '600',
    color: currentColors.text,
  },
  freqTextActive: {
    color: '#fff',
  },
  daysWrapper: {
    marginTop: 5,
  },
  daysContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 8,
    marginTop: 8,
  },
  dayCircle: {
    width: 38,
    height: 38,
    borderRadius: 19,
    backgroundColor: isDark ? '#334155' : '#f1f5f9',
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 1,
    borderColor: isDark ? '#475569' : '#e2e8f0',
  },
  dayCircleActive: {
    backgroundColor: COLORS.primary,
    borderColor: COLORS.primary,
  },
  dayText: {
    fontSize: 11,
    fontWeight: 'bold',
    color: currentColors.text,
  },
  dayTextActive: {
    color: '#fff',
  },
  sectionLabel: {
    color: currentColors.subText,
    fontSize: 12,
    fontWeight: 'bold',
    marginBottom: 6,
    textTransform: 'uppercase',
    letterSpacing: 0.5,
  },
  categoryTag: {
    paddingVertical: 8,
    paddingHorizontal: 14,
    borderRadius: 10,
    backgroundColor: currentColors.surface,
    borderWidth: 1,
    borderColor: isDark ? '#334155' : '#e2e8f0',
    marginRight: 6,
  },

  // SEGMENTED CONTROL (TABS)
  segmentedControl: {
    flexDirection: 'row',
    backgroundColor: isDark ? '#334155' : '#e2e8f0',
    borderRadius: 12,
    padding: 4,
    marginBottom: 10,
  },
  segmentBtn: {
    flex: 1,
    paddingVertical: 10,
    alignItems: 'center',
    borderRadius: 10,
  },
  segmentBtnActive: {
    backgroundColor: isDark ? '#1e293b' : '#fff',
    shadowColor: '#000',
    shadowOpacity: 0.1,
    shadowRadius: 2,
    elevation: 2,
  },

  // CHAT
  chatAvatar: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: COLORS.secondary,
    marginRight: 8,
    alignItems: 'center',
    justifyContent: 'center',
  },
  chatBubble: {
    padding: 12,
    borderRadius: 16,
    marginBottom: 2,
  },
  chatBubbleMe: {
    backgroundColor: COLORS.primary,
    borderBottomRightRadius: 4,
  },
  chatBubbleOther: {
    backgroundColor: isDark ? '#334155' : '#f1f5f9',
    borderTopLeftRadius: 4,
  },
  chatInputBar: {
    padding: 12,
    borderTopWidth: 1,
    borderColor: isDark ? '#334155' : '#f1f5f9',
    flexDirection: 'row',
    alignItems: 'center',
    gap: 10,
    backgroundColor: currentColors.surface,
  },
  chatInput: {
    flex: 1,
    backgroundColor: isDark ? '#1e293b' : '#f8fafc',
    borderRadius: 20,
    paddingHorizontal: 15,
    height: 40,
    color: currentColors.text,
  },
  chatSendBtn: {
    width: 40,
    height: 40,
    borderRadius: 20,
    alignItems: 'center',
    justifyContent: 'center',
  },

  // CATEGORY LIST
  categoryListItem: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 12,
    paddingHorizontal: 12,
    marginBottom: 8,
    borderRadius: 12,
    backgroundColor: isDark ? '#1e293b' : '#f8fafc',
    borderWidth: 1,
    borderColor: isDark ? '#334155' : '#e2e8f0',
  },
  colorDot: {
    width: 16,
    height: 16,
    borderRadius: 8,
  },
  deleteIconBtn: {
    padding: 8,
    backgroundColor: '#fee2e2',
    borderRadius: 8,
  },
  colorCircle: {
    width: 42,
    height: 42,
    borderRadius: 21,
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 1,
    borderColor: 'rgba(0,0,0,0.1)',
  },
  colorCircleSelected: {
    borderWidth: 3,
    borderColor: currentColors.text,
  },

  // ONBOARDING
  onboardingContainer: {
    flex: 1,
    backgroundColor: COLORS.primary,
    justifyContent: 'center',
    alignItems: 'center',
  },
  onboardingIconCircle: {
    width: 120,
    height: 120,
    backgroundColor: 'rgba(255,255,255,0.2)',
    borderRadius: 60,
    alignItems: 'center',
    justifyContent: 'center',
  },
  onboardingTitle: {
    fontSize: 28,
    fontWeight: 'bold',
    color: '#fff',
    textAlign: 'center',
  },
  onboardingDesc: {
    color: '#fff',
    textAlign: 'center',
    fontSize: 16,
    lineHeight: 24,
  },
  onboardingFooter: {
    position: 'absolute',
    bottom: 50,
    width: '100%',
    paddingHorizontal: 30,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  onboardingBtn: {
    backgroundColor: '#fff',
    paddingHorizontal: 24,
    paddingVertical: 12,
    borderRadius: 24,
  },

  // CONFIRM BUTTONS
  cancelButton: {
    flex: 1,
    padding: 14,
    borderRadius: 12,
    backgroundColor: isDark ? '#334155' : '#f1f5f9',
    alignItems: 'center',
  },
  confirmButton: {
    flex: 1,
    padding: 14,
    borderRadius: 12,
    alignItems: 'center',
  },

  // ADS & UPSELL
  fullScreenOverlay: {
    flex: 1,
    backgroundColor: '#000',
    justifyContent: 'center',
    padding: 20,
  },
  adCard: {
    backgroundColor: '#1e1e1e',
    borderRadius: 16,
    padding: 20,
    height: '60%',
    alignItems: 'center',
  },
  adBadge: {
    color: '#fff',
    fontSize: 12,
    fontWeight: 'bold',
    backgroundColor: 'rgba(255,255,255,0.2)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 4,
  },
  adContentPlaceholder: {
    flex: 1,
    width: '100%',
    backgroundColor: '#000',
    borderRadius: 12,
    alignItems: 'center',
    justifyContent: 'center',
    marginVertical: 10,
  },
  adCloseBtn: {
    padding: 12,
    backgroundColor: '#fff',
    borderRadius: 24,
    marginTop: 10,
    width: '100%',
    alignItems: 'center',
  },
  upsellIconCircle: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: '#fef3c7',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 15,
  },
  upsellTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: currentColors.text,
    textAlign: 'center',
  },
  upsellSubtitle: {
    color: currentColors.subText,
    textAlign: 'center',
    marginTop: 5,
  },
  checkCircleSmall: {
    width: 20,
    height: 20,
    borderRadius: 10,
    backgroundColor: COLORS.success,
    alignItems: 'center',
    justifyContent: 'center',
  },
 toastContainer: {
    position: 'absolute',
    top: Platform.OS === 'ios' ? 60 : 40, // Android/iOS farkÄ±
    left: 20,
    right: 20,
    zIndex: 9999,
    borderRadius: 16,
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    gap: 12,
    borderWidth: 1,
    // Modern GÃ¶lge
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.15,
    shadowRadius: 12,
    elevation: 8,
  },
  toastIconBox: {
    width: 40,
    height: 40,
    borderRadius: 20,
    alignItems: 'center',
    justifyContent: 'center',
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 5,
    elevation: 3,
  },
  toastTitle: {
    color: '#0f172a', // Daha koyu, okunabilir renk
    fontWeight: '700',
    fontSize: 14,
    marginBottom: 2,
    letterSpacing: 0.3,
  },
  toastMessage: {
    color: '#475569',
    fontSize: 12,
    fontWeight: '500',
    lineHeight: 16,
  },
  toastCloseBtn: {
    padding: 4,
    opacity: 0.7,
  },
   // FAB (Habit)
  fabContainer: {
    alignItems: 'flex-end',
    backgroundColor: 'transparent',
    shadowOpacity: 0,
    zIndex: 50,
    position: 'absolute',
    right: 20, // SaÄŸdan boÅŸluk varsayÄ±lan olarak eklendi
  },
  fabButton: {
    backgroundColor: COLORS.primary,
    width: 56,
    height: 56,
    borderRadius: 28,
    shadowColor: COLORS.primary,
    shadowOpacity: 0.3,
    shadowRadius: 10,
    elevation: 5,
    alignItems: 'center',
    justifyContent: 'center',
  },

  // Task Input Overlay & Container
  overlay: {
    position: 'absolute',
    top: 0, 
    bottom: 0, 
    left: 0, 
    right: 0, 
    backgroundColor: 'rgba(0,0,0,0.2)', 
    zIndex: 40 
  },
  blurInputContainer: {
    position: 'absolute',
    left: 20,
    right: 20,
    borderWidth: 1,
    overflow: 'hidden',
    zIndex: 50,
    borderRadius: 20, // VarsayÄ±lan olarak ekledim, tasarÄ±mÄ±na gÃ¶re deÄŸiÅŸtirebilirsin
  },
  
  // Expanded Content
  expandedContent: {
    padding: 15,
  },
  sectionTitle: {
    fontSize: 10,
    fontWeight: 'bold',
    color: currentColors.subText,
    marginBottom: 5,
  },
  miniHeader: {
    fontSize: 11, 
    fontWeight: '700', 
    marginBottom: 8, 
    letterSpacing: 0.5 
  },
  searchRow: {
    flexDirection: 'row',
    gap: 5,
    marginBottom: 10,
    alignItems: 'center',
    borderBottomWidth: 1,
    paddingBottom: 10,
  },
  
  // Assignee Chips
  assignChip: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 12,
    borderRadius: 20,
    borderWidth: 1,
  },
  avatarSmall: {
    width: 28,
    height: 28,
    borderRadius: 14,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 8,
    overflow: 'hidden',
  },
  avatarImage: {
    width: 28,
    height: 28,
  },
  chipText: {
    fontSize: 13, 
    fontWeight: '700'
  },
  
  // Date Inputs
  dateRow: {
    flexDirection: 'row',
    gap: 10,
    marginBottom: 10,
  },
  dateInputWrapper: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  dateInput: {
    flex: 1,
    height: 36,
    borderTopLeftRadius: 8,
    borderBottomLeftRadius: 8,
    paddingHorizontal: 10,
    fontSize: 12,
  },
  calendarBtn: {
    backgroundColor: COLORS.primary,
    padding: 7,
    borderTopRightRadius: 8,
    borderBottomRightRadius: 8,
    height: 36,
    justifyContent: 'center',
  },
  smallInput: {
    height: 36,
    borderRadius: 8,
    paddingHorizontal: 10,
    fontSize: 12,
  },

  // Categories
  divider: {
    paddingVertical: 10,
    borderTopWidth: 1,
  },
  categoryPill: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 10,
    borderRadius: 16,
    borderWidth: 1,
    gap: 6,
  },
  dot: {
    width: 8,
    height: 8,
    borderRadius: 4,
  },
  categoryText: {
    fontSize: 12,
    fontWeight: '600',
  },

  // Bottom Actions (Toggles)
  bottomActions: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingTop: 10,
  },
  iconToggle: {
    width: 32,
    height: 32,
    borderRadius: 16,
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 1,
    borderColor: 'transparent',
  },
  iconToggleActiveBlue: { backgroundColor: '#eff6ff', borderColor: '#3b82f6' },
  iconToggleActiveRed: { backgroundColor: '#fef2f2', borderColor: '#ef4444' },
  iconToggleActiveGreen: { backgroundColor: '#f0fdf4', borderColor: '#10b981' },
  timeInput: {
    width: 50,
    height: 30,
    borderWidth: 1,
    borderRadius: 6,
    textAlign: 'center',
    fontSize: 11,
    fontWeight: 'bold',
  },

  // Main Input Row
  mainInputRow: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 10,
    gap: 10,
  },
  expandBtn: {
    padding: 5,
  },
  mainTextInput: {
    flex: 1,
    height: 40,
  },
  sendBtn: {
    width: 40,
    height: 40,
    borderRadius: 20,
    alignItems: 'center',
    justifyContent: 'center',
  },
  tabBar: {
    flexDirection: 'row',
    justifyContent: 'space-around', // Ã–ÄŸeleri eÅŸit aralÄ±kla yayar
    alignItems: 'center',
    paddingVertical: 10, // Alt ve Ã¼st boÅŸluk
    paddingBottom: 20, // iPhone safe area iÃ§in ekstra boÅŸluk (gerekirse)
    borderTopWidth: 1,
    elevation: 10, // Android gÃ¶lgesi iÃ§in
    shadowColor: '#000', // iOS gÃ¶lgesi iÃ§in
    shadowOffset: { width: 0, height: -2 },
    shadowOpacity: 0.1,
    shadowRadius: 3,
  },
  tabItem: {
    alignItems: 'center',
    justifyContent: 'center',
    flex: 1, // TÄ±klama alanÄ±nÄ± geniÅŸletir
    paddingVertical: 5,
  },
  tabLabel: {
    fontSize: 10,
    marginTop: 4, // Ä°kon ile metin arasÄ±na biraz boÅŸluk
    fontWeight: '500',
  },
  
  container: { flex: 1, },
  header: { padding: 20, flexDirection: 'row', justifyContent:'space-between', alignItems:'center' },
  card: { padding: 20, borderRadius: 16, shadowColor: "#000", shadowOpacity: 0.05, elevation: 2 },
  input: { backgroundColor: 'rgba(0,0,0,0.05)', padding: 15, borderRadius: 12, fontSize: 16 },
  btn: { backgroundColor: COLORS.primary, padding: 15, borderRadius: 12, alignItems: 'center' },
  greeting: { fontSize: 14, fontWeight: '600', textTransform: 'uppercase', letterSpacing: 1 },
  appTitle: { fontSize: 28, fontWeight: '900' },
  checkbox: { width: 24, height: 24, borderRadius: 12, borderWidth: 2, borderColor: '#cbd5e1' },
  menuItem: { flexDirection:'row', alignItems:'center', justifyContent:'space-between', paddingVertical:15, borderBottomWidth:1, borderColor:'rgba(0,0,0,0.05)' },
  menuText: { fontSize:16, fontWeight:'500', marginLeft:10, flex:1 },
  pill: { paddingHorizontal: 15, paddingVertical: 8, borderRadius: 20, borderWidth: 1, borderColor: '#e2e8f0', marginRight: 10 },
  dateNavContainer: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingHorizontal: 24, marginBottom: 20 },
// styles objesi iÃ§inde gÃ¼ncelle veya kontrol et:
  dateDisplay: { 
    flexDirection: 'row', 
    alignItems: 'center', 
    backgroundColor: 'rgba(99, 102, 241, 0.1)', // Hafif mor arka plan
    paddingHorizontal: 16, 
    paddingVertical: 8, 
    borderRadius: 20 
  },
  dateText: { fontWeight: '700', fontSize: 14 },
  todayBadge: { marginLeft: 8, backgroundColor: COLORS.primary, paddingHorizontal: 6, paddingVertical: 2, borderRadius: 4 },
  todayText: { color: '#fff', fontSize: 10, fontWeight: 'bold' },
  dateArrow: { padding: 5 },
  content: { flex: 1, paddingHorizontal: 24 },
  emptyState: { alignItems: 'center', justifyContent: 'center', marginTop: 60 },
  emptyIconBox: { width: 80, height: 80, borderRadius: 40, alignItems: 'center', justifyContent: 'center', marginBottom: 20 },
  emptyTitle: { fontSize: 20, fontWeight: 'bold', marginBottom: 10 },
  emptyDesc: { textAlign: 'center', color: '#94a3b8', lineHeight: 20 },
  taskCard: { padding: 16, borderRadius: 24, marginBottom: 12, shadowColor: "#000", shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.05, shadowRadius: 10, elevation: 2 },
  checkBox: { width: 24, height: 24, borderRadius: 12, borderWidth: 2, alignItems: 'center', justifyContent: 'center', marginRight: 16 },
  taskText: { fontSize: 16, fontWeight: '600' },
  taskMeta: { flexDirection: 'row', alignItems: 'center', gap: 8, marginTop: 6 },
  miniBadge: { flexDirection: 'row', alignItems: 'center', gap: 4, paddingHorizontal: 8, paddingVertical: 3, borderRadius: 10 },
  metaItem: { flexDirection: 'row', alignItems: 'center', gap: 4 },
floatingInputWrapper: {position: 'absolute', bottom: 90, left: 20, right: 20, borderRadius: 24, padding: 10, shadowColor: "#000", shadowOffset: { width: 0, height: 10 }, shadowOpacity: 0.15, shadowRadius: 20, elevation: 10, overflow: 'hidden'},  
  inputMainRow: { flexDirection: 'row', alignItems: 'center', gap: 10 },
  mainInput: { flex: 1, fontSize: 16, height: 40, fontWeight: '500' },
  expandedOptions: { paddingBottom: 10, marginBottom: 10 },
  timeToggle: { flexDirection: 'row', alignItems: 'center', gap: 5, paddingHorizontal: 8, paddingVertical: 4, borderRadius: 12, borderWidth: 1, borderColor: '#e2e8f0' },
  statsHero: { padding: 30, borderRadius: 32, marginBottom: 20 },
  activeDot: { width: 4, height: 4, borderRadius: 2, backgroundColor: COLORS.primary, marginTop: 4 },
  cardTitle: { fontSize: 16, fontWeight: 'bold', marginBottom: 15 },
  settingBtn: { flexDirection: 'row', alignItems: 'center', gap: 8, paddingHorizontal: 15, paddingVertical: 10, borderRadius: 12, borderWidth: 1, borderColor: '#e2e8f0' },
  settingBtnActive: { borderColor: COLORS.primary, backgroundColor: '#e0e7ff' },
  authInputRow: { flexDirection: 'row', alignItems: 'center', borderWidth: 1, borderColor: '#e2e8f0', borderRadius: 12, paddingHorizontal: 15, marginBottom: 15, height: 50 },
  authInput: { flex: 1, marginLeft: 10, height: '100%' },
  createBtn: { backgroundColor: COLORS.primary, padding: 15, borderRadius: 12, alignItems: 'center' },
  socialBtn: { padding: 15, borderRadius: 12, alignItems: 'center', borderWidth: 1, borderColor: '#e2e8f0' },
  alarmOverlay: { flex: 1, backgroundColor: 'rgba(99, 102, 241, 0.95)', justifyContent: 'center', alignItems: 'center' },
  alarmCard: { width: '80%', padding: 30, borderRadius: 30, alignItems: 'center' },
  alarmTitle: { fontSize: 22, fontWeight: '900', marginBottom: 10 },
  alarmCloseBtn: { backgroundColor: COLORS.primary, paddingHorizontal: 30, paddingVertical: 12, borderRadius: 16, marginTop: 20 },
  tinyInput: { fontSize: 12, fontWeight: 'bold', width: 40, padding: 0, textAlign: 'center', borderBottomWidth: 1 },
  dateBtn: { flexDirection: 'row', alignItems: 'center', gap: 6, backgroundColor: '#eff6ff', padding: 8, borderRadius: 8, marginTop: 5 },
  catModal: { width: '80%', padding: 20, borderRadius: 24 },
  catModalTitle: { fontSize: 18, fontWeight: 'bold', marginBottom: 15 },
  
});